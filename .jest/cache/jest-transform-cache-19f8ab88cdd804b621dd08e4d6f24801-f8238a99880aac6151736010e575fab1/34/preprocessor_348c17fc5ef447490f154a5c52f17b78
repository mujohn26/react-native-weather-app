0d597f87fcf641bcbf50fbf0b569c83b
'use strict';

var UNICODE = require("../common/unicode");

var $ = UNICODE.CODE_POINTS;

function isSurrogatePair(cp1, cp2) {
  return cp1 >= 0xD800 && cp1 <= 0xDBFF && cp2 >= 0xDC00 && cp2 <= 0xDFFF;
}

function getSurrogatePairCodePoint(cp1, cp2) {
  return (cp1 - 0xD800) * 0x400 + 0x2400 + cp2;
}

var DEFAULT_BUFFER_WATERLINE = 1 << 16;

var Preprocessor = module.exports = function () {
  this.html = null;
  this.pos = -1;
  this.lastGapPos = -1;
  this.lastCharPos = -1;
  this.gapStack = [];
  this.skipNextNewLine = false;
  this.lastChunkWritten = false;
  this.endOfChunkHit = false;
  this.bufferWaterline = DEFAULT_BUFFER_WATERLINE;
};

Preprocessor.prototype.dropParsedChunk = function () {
  if (this.pos > this.bufferWaterline) {
    this.lastCharPos -= this.pos;
    this.html = this.html.substring(this.pos);
    this.pos = 0;
    this.lastGapPos = -1;
    this.gapStack = [];
  }
};

Preprocessor.prototype._addGap = function () {
  this.gapStack.push(this.lastGapPos);
  this.lastGapPos = this.pos;
};

Preprocessor.prototype._processHighRangeCodePoint = function (cp) {
  if (this.pos !== this.lastCharPos) {
    var nextCp = this.html.charCodeAt(this.pos + 1);

    if (isSurrogatePair(cp, nextCp)) {
      this.pos++;
      cp = getSurrogatePairCodePoint(cp, nextCp);

      this._addGap();
    }
  } else if (!this.lastChunkWritten) {
      this.endOfChunkHit = true;
      return $.EOF;
    }

  return cp;
};

Preprocessor.prototype.write = function (chunk, isLastChunk) {
  if (this.html) this.html += chunk;else this.html = chunk;
  this.lastCharPos = this.html.length - 1;
  this.endOfChunkHit = false;
  this.lastChunkWritten = isLastChunk;
};

Preprocessor.prototype.insertHtmlAtCurrentPos = function (chunk) {
  this.html = this.html.substring(0, this.pos + 1) + chunk + this.html.substring(this.pos + 1, this.html.length);
  this.lastCharPos = this.html.length - 1;
  this.endOfChunkHit = false;
};

Preprocessor.prototype.advance = function () {
  this.pos++;

  if (this.pos > this.lastCharPos) {
    if (!this.lastChunkWritten) this.endOfChunkHit = true;
    return $.EOF;
  }

  var cp = this.html.charCodeAt(this.pos);

  if (this.skipNextNewLine && cp === $.LINE_FEED) {
    this.skipNextNewLine = false;

    this._addGap();

    return this.advance();
  }

  if (cp === $.CARRIAGE_RETURN) {
    this.skipNextNewLine = true;
    return $.LINE_FEED;
  }

  this.skipNextNewLine = false;
  return cp >= 0xD800 ? this._processHighRangeCodePoint(cp) : cp;
};

Preprocessor.prototype.retreat = function () {
  if (this.pos === this.lastGapPos) {
    this.lastGapPos = this.gapStack.pop();
    this.pos--;
  }

  this.pos--;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByZXByb2Nlc3Nvci5qcyJdLCJuYW1lcyI6WyJVTklDT0RFIiwicmVxdWlyZSIsIiQiLCJDT0RFX1BPSU5UUyIsImlzU3Vycm9nYXRlUGFpciIsImNwMSIsImNwMiIsImdldFN1cnJvZ2F0ZVBhaXJDb2RlUG9pbnQiLCJERUZBVUxUX0JVRkZFUl9XQVRFUkxJTkUiLCJQcmVwcm9jZXNzb3IiLCJtb2R1bGUiLCJleHBvcnRzIiwiaHRtbCIsInBvcyIsImxhc3RHYXBQb3MiLCJsYXN0Q2hhclBvcyIsImdhcFN0YWNrIiwic2tpcE5leHROZXdMaW5lIiwibGFzdENodW5rV3JpdHRlbiIsImVuZE9mQ2h1bmtIaXQiLCJidWZmZXJXYXRlcmxpbmUiLCJwcm90b3R5cGUiLCJkcm9wUGFyc2VkQ2h1bmsiLCJzdWJzdHJpbmciLCJfYWRkR2FwIiwicHVzaCIsIl9wcm9jZXNzSGlnaFJhbmdlQ29kZVBvaW50IiwiY3AiLCJuZXh0Q3AiLCJjaGFyQ29kZUF0IiwiRU9GIiwid3JpdGUiLCJjaHVuayIsImlzTGFzdENodW5rIiwibGVuZ3RoIiwiaW5zZXJ0SHRtbEF0Q3VycmVudFBvcyIsImFkdmFuY2UiLCJMSU5FX0ZFRUQiLCJDQVJSSUFHRV9SRVRVUk4iLCJyZXRyZWF0IiwicG9wIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFJQSxPQUFPLEdBQUdDLE9BQU8scUJBQXJCOztBQUdBLElBQUlDLENBQUMsR0FBR0YsT0FBTyxDQUFDRyxXQUFoQjs7QUFPQSxTQUFTQyxlQUFULENBQXlCQyxHQUF6QixFQUE4QkMsR0FBOUIsRUFBbUM7QUFDL0IsU0FBT0QsR0FBRyxJQUFJLE1BQVAsSUFBaUJBLEdBQUcsSUFBSSxNQUF4QixJQUFrQ0MsR0FBRyxJQUFJLE1BQXpDLElBQW1EQSxHQUFHLElBQUksTUFBakU7QUFDSDs7QUFFRCxTQUFTQyx5QkFBVCxDQUFtQ0YsR0FBbkMsRUFBd0NDLEdBQXhDLEVBQTZDO0FBQ3pDLFNBQU8sQ0FBQ0QsR0FBRyxHQUFHLE1BQVAsSUFB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LENBQWN3QixHQUFkLEVBQWxCO0FBQ0EsU0FBSzNCLEdBQUw7QUFDSDs7QUFFRCxPQUFLQSxHQUFMO0FBQ0gsQ0FQRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIFVOSUNPREUgPSByZXF1aXJlKCcuLi9jb21tb24vdW5pY29kZScpO1xuXG4vL0FsaWFzZXNcbnZhciAkID0gVU5JQ09ERS5DT0RFX1BPSU5UUztcblxuLy9VdGlsc1xuXG4vL09QVElNSVpBVElPTjogdGhlc2UgdXRpbGl0eSBmdW5jdGlvbnMgc2hvdWxkIG5vdCBiZSBtb3ZlZCBvdXQgb2YgdGhpcyBtb2R1bGUuIFY4IENyYW5rc2hhZnQgd2lsbCBub3QgaW5saW5lXG4vL3RoaXMgZnVuY3Rpb25zIGlmIHRoZXkgd2lsbCBiZSBzaXR1YXRlZCBpbiBhbm90aGVyIG1vZHVsZSBkdWUgdG8gY29udGV4dCBzd2l0Y2guXG4vL0Fsd2F5cyBwZXJmb3JtIGlubGluaW5nIGNoZWNrIGJlZm9yZSBtb2RpZnlpbmcgdGhpcyBmdW5jdGlvbnMgKCdub2RlIC0tdHJhY2UtaW5saW5pbmcnKS5cbmZ1bmN0aW9uIGlzU3Vycm9nYXRlUGFpcihjcDEsIGNwMikge1xuICAgIHJldHVybiBjcDEgPj0gMHhEODAwICYmIGNwMSA8PSAweERCRkYgJiYgY3AyID49IDB4REMwMCAmJiBjcDIgPD0gMHhERkZGO1xufVxuXG5mdW5jdGlvbiBnZXRTdXJyb2dhdGVQYWlyQ29kZVBvaW50KGNwMSwgY3AyKSB7XG4gICAgcmV0dXJuIChjcDEgLSAweEQ4MDApICogMHg0MDAgKyAweDI0MDAgKyBjcDI7XG59XG5cblxuLy9Db25zdFxudmFyIERFRkFVTFRfQlVGRkVSX1dBVEVSTElORSA9IDEgPDwgMTY7XG5cblxuLy9QcmVwcm9jZXNzb3Jcbi8vTk9URTogSFRNTCBpbnB1dCBwcmVwcm9jZXNzaW5nXG4vLyhzZWU6IGh0dHA6Ly93d3cud2hhdHdnLm9yZy9zcGVjcy93ZWItYXBwcy9jdXJyZW50LXdvcmsvbXVsdGlwYWdlL3BhcnNpbmcuaHRtbCNwcmVwcm9jZXNzaW5nLXRoZS1pbnB1dC1zdHJlYW0pXG52YXIgUHJlcHJvY2Vzc29yID0gbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5odG1sID0gbnVsbDtcblxuICAgIHRoaXMucG9zID0gLTE7XG4gICAgdGhpcy5sYXN0R2FwUG9zID0gLTE7XG4gICAgdGhpcy5sYXN0Q2hhclBvcyA9IC0xO1xuXG4gICAgdGhpcy5nYXBTdGFjayA9IFtdO1xuXG4gICAgdGhpcy5za2lwTmV4dE5ld0xpbmUgPSBmYWxzZTtcblxuICAgIHRoaXMubGFzdENodW5rV3JpdHRlbiA9IGZhbHNlO1xuICAgIHRoaXMuZW5kT2ZDaHVua0hpdCA9IGZhbHNlO1xuICAgIHRoaXMuYnVmZmVyV2F0ZXJsaW5lID0gREVGQVVMVF9CVUZGRVJfV0FURVJMSU5FO1xufTtcblxuUHJlcHJvY2Vzc29yLnByb3RvdHlwZS5kcm9wUGFyc2VkQ2h1bmsgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMucG9zID4gdGhpcy5idWZmZXJXYXRlcmxpbmUpIHtcbiAgICAgICAgdGhpcy5sYXN0Q2hhclBvcyAtPSB0aGlzLnBvcztcbiAgICAgICAgdGhpcy5odG1sID0gdGhpcy5odG1sLnN1YnN0cmluZyh0aGlzLnBvcyk7XG4gICAgICAgIHRoaXMucG9zID0gMDtcbiAgICAgICAgdGhpcy5sYXN0R2FwUG9zID0gLTE7XG4gICAgICAgIHRoaXMuZ2FwU3RhY2sgPSBbXTtcbiAgICB9XG59O1xuXG5QcmVwcm9jZXNzb3IucHJvdG90eXBlLl9hZGRHYXAgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5nYXBTdGFjay5wdXNoKHRoaXMubGFzdEdhcFBvcyk7XG4gICAgdGhpcy5sYXN0R2FwUG9zID0gdGhpcy5wb3M7XG59O1xuXG5QcmVwcm9jZXNzb3IucHJvdG90eXBlLl9wcm9jZXNzSGlnaFJhbmdlQ29kZVBvaW50ID0gZnVuY3Rpb24gKGNwKSB7XG4gICAgLy9OT1RFOiB0cnkgdG8gcGVlayBhIHN1cnJvZ2F0ZSBwYWlyXG4gICAgaWYgKHRoaXMucG9zICE9PSB0aGlzLmxhc3RDaGFyUG9zKSB7XG4gICAgICAgIHZhciBuZXh0Q3AgPSB0aGlzLmh0bWwuY2hhckNvZGVBdCh0aGlzLnBvcyArIDEpO1xuXG4gICAgICAgIGlmIChpc1N1cnJvZ2F0ZVBhaXIoY3AsIG5leHRDcCkpIHtcbiAgICAgICAgICAgIC8vTk9URTogd2UgaGF2ZSBhIHN1cnJvZ2F0ZSBwYWlyLiBQZWVrIHBhaXIgY2hhcmFjdGVyIGFuZCByZWNhbGN1bGF0ZSBjb2RlIHBvaW50LlxuICAgICAgICAgICAgdGhpcy5wb3MrKztcbiAgICAgICAgICAgIGNwID0gZ2V0U3Vycm9nYXRlUGFpckNvZGVQb2ludChjcCwgbmV4dENwKTtcblxuICAgICAgICAgICAgLy9OT1RFOiBhZGQgZ2FwIHRoYXQgc2hvdWxkIGJlIGF2b2lkZWQgZHVyaW5nIHJldHJlYXRcbiAgICAgICAgICAgIHRoaXMuX2FkZEdhcCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gTk9URTogd2UndmUgaGl0IHRoZSBlbmQgb2YgY2h1bmssIHN0b3AgcHJvY2Vzc2luZyBhdCB0aGlzIHBvaW50XG4gICAgZWxzZSBpZiAoIXRoaXMubGFzdENodW5rV3JpdHRlbikge1xuICAgICAgICB0aGlzLmVuZE9mQ2h1bmtIaXQgPSB0cnVlO1xuICAgICAgICByZXR1cm4gJC5FT0Y7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNwO1xufTtcblxuUHJlcHJvY2Vzc29yLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIChjaHVuaywgaXNMYXN0Q2h1bmspIHtcbiAgICBpZiAodGhpcy5odG1sKVxuICAgICAgICB0aGlzLmh0bWwgKz0gY2h1bms7XG5cbiAgICBlbHNlXG4gICAgICAgIHRoaXMuaHRtbCA9IGNodW5rO1xuXG4gICAgdGhpcy5sYXN0Q2hhclBvcyA9IHRoaXMuaHRtbC5sZW5ndGggLSAxO1xuICAgIHRoaXMuZW5kT2ZDaHVua0hpdCA9IGZhbHNlO1xuICAgIHRoaXMubGFzdENodW5rV3JpdHRlbiA9IGlzTGFzdENodW5rO1xufTtcblxuUHJlcHJvY2Vzc29yLnByb3RvdHlwZS5pbnNlcnRIdG1sQXRDdXJyZW50UG9zID0gZnVuY3Rpb24gKGNodW5rKSB7XG4gICAgdGhpcy5odG1sID0gdGhpcy5odG1sLnN1YnN0cmluZygwLCB0aGlzLnBvcyArIDEpICtcbiAgICAgICAgICAgICAgICBjaHVuayArXG4gICAgICAgICAgICAgICAgdGhpcy5odG1sLnN1YnN0cmluZyh0aGlzLnBvcyArIDEsIHRoaXMuaHRtbC5sZW5ndGgpO1xuXG4gICAgdGhpcy5sYXN0Q2hhclBvcyA9IHRoaXMuaHRtbC5sZW5ndGggLSAxO1xuICAgIHRoaXMuZW5kT2ZDaHVua0hpdCA9IGZhbHNlO1xufTtcblxuXG5QcmVwcm9jZXNzb3IucHJvdG90eXBlLmFkdmFuY2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5wb3MrKztcblxuICAgIGlmICh0aGlzLnBvcyA+IHRoaXMubGFzdENoYXJQb3MpIHtcbiAgICAgICAgaWYgKCF0aGlzLmxhc3RDaHVua1dyaXR0ZW4pXG4gICAgICAgICAgICB0aGlzLmVuZE9mQ2h1bmtIaXQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiAkLkVPRjtcbiAgICB9XG5cbiAgICB2YXIgY3AgPSB0aGlzLmh0bWwuY2hhckNvZGVBdCh0aGlzLnBvcyk7XG5cbiAgICAvL05PVEU6IGFueSBVKzAwMEEgTElORSBGRUVEIChMRikgY2hhcmFjdGVycyB0aGF0IGltbWVkaWF0ZWx5IGZvbGxvdyBhIFUrMDAwRCBDQVJSSUFHRSBSRVRVUk4gKENSKSBjaGFyYWN0ZXJcbiAgICAvL211c3QgYmUgaWdub3JlZC5cbiAgICBpZiAodGhpcy5za2lwTmV4dE5ld0xpbmUgJiYgY3AgPT09ICQuTElORV9GRUVEKSB7XG4gICAgICAgIHRoaXMuc2tpcE5leHROZXdMaW5lID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2FkZEdhcCgpO1xuICAgICAgICByZXR1cm4gdGhpcy5hZHZhbmNlKCk7XG4gICAgfVxuXG4gICAgLy9OT1RFOiBhbGwgVSswMDBEIENBUlJJQUdFIFJFVFVSTiAoQ1IpIGNoYXJhY3RlcnMgbXVzdCBiZSBjb252ZXJ0ZWQgdG8gVSswMDBBIExJTkUgRkVFRCAoTEYpIGNoYXJhY3RlcnNcbiAgICBpZiAoY3AgPT09ICQuQ0FSUklBR0VfUkVUVVJOKSB7XG4gICAgICAgIHRoaXMuc2tpcE5leHROZXdMaW5lID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuICQuTElORV9GRUVEO1xuICAgIH1cblxuICAgIHRoaXMuc2tpcE5leHROZXdMaW5lID0gZmFsc2U7XG5cbiAgICAvL09QVElNSVpBVElPTjogZmlyc3QgcGVyZm9ybSBjaGVjayBpZiB0aGUgY29kZSBwb2ludCBpbiB0aGUgYWxsb3dlZCByYW5nZSB0aGF0IGNvdmVycyBtb3N0IGNvbW1vblxuICAgIC8vSFRNTCBpbnB1dCAoZS5nLiBBU0NJSSBjb2RlcykgdG8gYXZvaWQgcGVyZm9ybWFuY2UtY29zdCBvcGVyYXRpb25zIGZvciBoaWdoLXJhbmdlIGNvZGUgcG9pbnRzLlxuICAgIHJldHVybiBjcCA+PSAweEQ4MDAgPyB0aGlzLl9wcm9jZXNzSGlnaFJhbmdlQ29kZVBvaW50KGNwKSA6IGNwO1xufTtcblxuUHJlcHJvY2Vzc29yLnByb3RvdHlwZS5yZXRyZWF0ID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICh0aGlzLnBvcyA9PT0gdGhpcy5sYXN0R2FwUG9zKSB7XG4gICAgICAgIHRoaXMubGFzdEdhcFBvcyA9IHRoaXMuZ2FwU3RhY2sucG9wKCk7XG4gICAgICAgIHRoaXMucG9zLS07XG4gICAgfVxuXG4gICAgdGhpcy5wb3MtLTtcbn07XG5cbiJdfQ==