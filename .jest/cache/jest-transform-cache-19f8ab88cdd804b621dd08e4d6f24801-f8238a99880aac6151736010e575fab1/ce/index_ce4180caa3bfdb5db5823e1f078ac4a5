a522c5b6e39f80f3781c0a0936e9b168
'use strict';

var defaultTreeAdapter = require("../tree_adapters/default"),
    mergeOptions = require("../utils/merge_options"),
    doctype = require("../common/doctype"),
    HTML = require("../common/html");

var $ = HTML.TAG_NAMES,
    NS = HTML.NAMESPACES;
var DEFAULT_OPTIONS = {
  treeAdapter: defaultTreeAdapter
};
var AMP_REGEX = /&/g,
    NBSP_REGEX = /\u00a0/g,
    DOUBLE_QUOTE_REGEX = /"/g,
    LT_REGEX = /</g,
    GT_REGEX = />/g;

var Serializer = module.exports = function (node, options) {
  this.options = mergeOptions(DEFAULT_OPTIONS, options);
  this.treeAdapter = this.options.treeAdapter;
  this.html = '';
  this.startNode = node;
};

Serializer.escapeString = function (str, attrMode) {
  str = str.replace(AMP_REGEX, '&amp;').replace(NBSP_REGEX, '&nbsp;');
  if (attrMode) str = str.replace(DOUBLE_QUOTE_REGEX, '&quot;');else {
    str = str.replace(LT_REGEX, '&lt;').replace(GT_REGEX, '&gt;');
  }
  return str;
};

Serializer.prototype.serialize = function () {
  this._serializeChildNodes(this.startNode);

  return this.html;
};

Serializer.prototype._serializeChildNodes = function (parentNode) {
  var childNodes = this.treeAdapter.getChildNodes(parentNode);

  if (childNodes) {
    for (var i = 0, cnLength = childNodes.length; i < cnLength; i++) {
      var currentNode = childNodes[i];
      if (this.treeAdapter.isElementNode(currentNode)) this._serializeElement(currentNode);else if (this.treeAdapter.isTextNode(currentNode)) this._serializeTextNode(currentNode);else if (this.treeAdapter.isCommentNode(currentNode)) this._serializeCommentNode(currentNode);else if (this.treeAdapter.isDocumentTypeNode(currentNode)) this._serializeDocumentTypeNode(currentNode);
    }
  }
};

Serializer.prototype._serializeElement = function (node) {
  var tn = this.treeAdapter.getTagName(node),
      ns = this.treeAdapter.getNamespaceURI(node);
  this.html += '<' + tn;

  this._serializeAttributes(node);

  this.html += '>';

  if (tn !== $.AREA && tn !== $.BASE && tn !== $.BASEFONT && tn !== $.BGSOUND && tn !== $.BR && tn !== $.BR && tn !== $.COL && tn !== $.EMBED && tn !== $.FRAME && tn !== $.HR && tn !== $.IMG && tn !== $.INPUT && tn !== $.KEYGEN && tn !== $.LINK && tn !== $.MENUITEM && tn !== $.META && tn !== $.PARAM && tn !== $.SOURCE && tn !== $.TRACK && tn !== $.WBR) {
    var childNodesHolder = tn === $.TEMPLATE && ns === NS.HTML ? this.treeAdapter.getTemplateContent(node) : node;

    this._serializeChildNodes(childNodesHolder);

    this.html += '</' + tn + '>';
  }
};

Serializer.prototype._serializeAttributes = function (node) {
  var attrs = this.treeAdapter.getAttrList(node);

  for (var i = 0, attrsLength = attrs.length; i < attrsLength; i++) {
    var attr = attrs[i],
        value = Serializer.escapeString(attr.value, true);
    this.html += ' ';
    if (!attr.namespace) this.html += attr.name;else if (attr.namespace === NS.XML) this.html += 'xml:' + attr.name;else if (attr.namespace === NS.XMLNS) {
      if (attr.name !== 'xmlns') this.html += 'xmlns:';
      this.html += attr.name;
    } else if (attr.namespace === NS.XLINK) this.html += 'xlink:' + attr.name;else this.html += attr.namespace + ':' + attr.name;
    this.html += '="' + value + '"';
  }
};

Serializer.prototype._serializeTextNode = function (node) {
  var content = this.treeAdapter.getTextNodeContent(node),
      parent = this.treeAdapter.getParentNode(node),
      parentTn = void 0;
  if (parent && this.treeAdapter.isElementNode(parent)) parentTn = this.treeAdapter.getTagName(parent);
  if (parentTn === $.STYLE || parentTn === $.SCRIPT || parentTn === $.XMP || parentTn === $.IFRAME || parentTn === $.NOEMBED || parentTn === $.NOFRAMES || parentTn === $.PLAINTEXT || parentTn === $.NOSCRIPT) this.html += content;else this.html += Serializer.escapeString(content, false);
};

Serializer.prototype._serializeCommentNode = function (node) {
  this.html += '<!--' + this.treeAdapter.getCommentNodeContent(node) + '-->';
};

Serializer.prototype._serializeDocumentTypeNode = function (node) {
  var name = this.treeAdapter.getDocumentTypeNodeName(node);
  this.html += '<' + doctype.serializeContent(name, null, null) + '>';
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbImRlZmF1bHRUcmVlQWRhcHRlciIsInJlcXVpcmUiLCJtZXJnZU9wdGlvbnMiLCJkb2N0eXBlIiwiSFRNTCIsIiQiLCJUQUdfTkFNRVMiLCJOUyIsIk5BTUVTUEFDRVMiLCJERUZBVUxUX09QVElPTlMiLCJ0cmVlQWRhcHRlciIsIkFNUF9SRUdFWCIsIk5CU1BfUkVHRVgiLCJET1VCTEVfUVVPVEVfUkVHRVgiLCJMVF9SRUdFWCIsIkdUX1JFR0VYIiwiU2VyaWFsaXplciIsIm1vZHVsZSIsImV4cG9ydHMiLCJub2RlIiwib3B0aW9ucyIsImh0bWwiLCJzdGFydE5vZGUiLCJlc2NhcGVTdHJpbmciLCJzdHIiLCJhdHRyTW9kZSIsInJlcGxhY2UiLCJwcm90b3R5cGUiLCJzZXJpYWxpemUiLCJfc2VyaWFsaXplQ2hpbGROb2RlcyIsInBhcmVudE5vZGUiLCJjaGlsZE5vZGVzIiwiZ2V0Q2hpbGROb2RlcyIsImkiLCJjbkxlbmd0aCIsImxlbmd0aCIsImN1cnJlbnROb2RlIiwiaXNFbGVtZW50Tm9kZSIsIl9zZXJpYWxpemVFbGVtZW50IiwiaXNUZXh0Tm9kZSIsIl9zZXJpYWxpemVUZXh0Tm9kZSIsImlzQ29tbWVudE5vZGUiLCJfc2VyaWFsaXplQ29tbWVudE5vZGUiLCJpc0RvY3VtZW50VHlwZU5vZGUiLCJfc2VyaWFsaXplRG9jdW1lbnRUeXBlTm9kZSIsInRuIiwiZ2V0VGFnTmFtZSIsIm5zIiwiZ2V0TmFtZXNwYWNlVVJJIiwiX3NlcmlhbGl6ZUF0dHJpYnV0ZXMiLCJBUkVBIiwiQkFTRSIsIkJBU0VGT05UIiwiQkdTT1VORCIsIkJSIiwiQ09MIiwiRU1CRUQiLCJGUkFNRSIsIkhSIiwiSU1HIiwiSU5QVVQiLCJLRVlHRU4iLCJMSU5LIiwiTUVOVUlURU0iLCJNRVRBIiwiUEFSQU0iLCJTT1VSQ0UiLCJUUkFDSyIsIldCUiIsImNoaWxkTm9kZXNIb2xkZXIiLCJURU1QTEFURSIsImdldFRlbXBsYXRlQ29udGVudCIsImF0dHJzIiwiZ2V0QXR0ckxpc3QiLCJhdHRyc0xlbmd0aCIsImF0dHIiLCJ2YWx1ZSIsIm5hbWVzcGFjZSIsIm5hbWUiLCJYTUwiLCJYTUxOUyIsIlhMSU5LIiwiY29udGVudCIsImdldFRleHROb2RlQ29udGVudCIsInBhcmVudCIsImdldFBhcmVudE5vZGUiLCJwYXJlbnRUbiIsIlNUWUxFIiwiU0NSSVBUIiwiWE1QIiwiSUZSQU1FIiwiTk9FTUJFRCIsIk5PRlJBTUVTIiwiUExBSU5URVhUIiwiTk9TQ1JJUFQiLCJnZXRDb21tZW50Tm9kZUNvbnRlbnQiLCJnZXREb2N1bWVudFR5cGVOb2RlTmFtZSIsInNlcmlhbGl6ZUNvbnRlbnQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLGtCQUFrQixHQUFHQyxPQUFPLDRCQUFoQztBQUFBLElBQ0lDLFlBQVksR0FBR0QsT0FBTywwQkFEMUI7QUFBQSxJQUVJRSxPQUFPLEdBQUdGLE9BQU8scUJBRnJCO0FBQUEsSUFHSUcsSUFBSSxHQUFHSCxPQUFPLGtCQUhsQjs7QUFNQSxJQUFJSSxDQUFDLEdBQUdELElBQUksQ0FBQ0UsU0FBYjtBQUFBLElBQ0lDLEVBQUUsR0FBR0gsSUFBSSxDQUFDSSxVQURkO0FBSUEsSUFBSUMsZUFBZSxHQUFHO0FBQ2xCQyxFQUFBQSxXQUFXLEVBQUVWO0FBREssQ0FBdEI7QUFLQSxJQUFJVyxTQUFTLEdBQUcsSUFBaEI7QUFBQSxJQUNJQyxVQUFVLEdBQUcsU0FEakI7QUFBQSxJQUVJQyxrQkFBa0IsR0FBRyxJQUZ6QjtBQUFBLElBR0lDLFFBQVEsR0FBRyxJQUhmO0FBQUEsSUFJSUMsUUFBUSxHQUFHLElBSmY7O0FBT0EsSUFBSUMsVUFBVSxHQUFHQyxNQUFNLENBQUNDLE9BQVAsR0FBaUIsVUFBVUMsSUFBVixFQUFnQkMsT0FBaEIsRUFBeUI7QUFDdkQsT0FBS0EsT0FBTCxHQUFlbEIsWUFBWSxDQUFDTyxlQUFELEVBQWtCVyxPQUFsQixDQUEzQjtBQUNBLE9BQUtWLFdBQUwsR0FBbUIsS0FBS1UsT0FBTCxDQUFh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QXFCaUIsMEJBQXJCLEdBQWtELFVBQVV6QixJQUFWLEVBQWdCO0FBQzlELE1BQUkyRCxJQUFJLEdBQUcsS0FBS3BFLFdBQUwsQ0FBaUJzRix1QkFBakIsQ0FBeUM3RSxJQUF6QyxDQUFYO0FBRUEsT0FBS0UsSUFBTCxJQUFhLE1BQU1sQixPQUFPLENBQUM4RixnQkFBUixDQUF5Qm5CLElBQXpCLEVBQStCLElBQS9CLEVBQXFDLElBQXJDLENBQU4sR0FBbUQsR0FBaEU7QUFDSCxDQUpEIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgZGVmYXVsdFRyZWVBZGFwdGVyID0gcmVxdWlyZSgnLi4vdHJlZV9hZGFwdGVycy9kZWZhdWx0JyksXG4gICAgbWVyZ2VPcHRpb25zID0gcmVxdWlyZSgnLi4vdXRpbHMvbWVyZ2Vfb3B0aW9ucycpLFxuICAgIGRvY3R5cGUgPSByZXF1aXJlKCcuLi9jb21tb24vZG9jdHlwZScpLFxuICAgIEhUTUwgPSByZXF1aXJlKCcuLi9jb21tb24vaHRtbCcpO1xuXG4vL0FsaWFzZXNcbnZhciAkID0gSFRNTC5UQUdfTkFNRVMsXG4gICAgTlMgPSBIVE1MLk5BTUVTUEFDRVM7XG5cbi8vRGVmYXVsdCBzZXJpYWxpemVyIG9wdGlvbnNcbnZhciBERUZBVUxUX09QVElPTlMgPSB7XG4gICAgdHJlZUFkYXB0ZXI6IGRlZmF1bHRUcmVlQWRhcHRlclxufTtcblxuLy9Fc2NhcGluZyByZWdleGVzXG52YXIgQU1QX1JFR0VYID0gLyYvZyxcbiAgICBOQlNQX1JFR0VYID0gL1xcdTAwYTAvZyxcbiAgICBET1VCTEVfUVVPVEVfUkVHRVggPSAvXCIvZyxcbiAgICBMVF9SRUdFWCA9IC88L2csXG4gICAgR1RfUkVHRVggPSAvPi9nO1xuXG4vL1NlcmlhbGl6ZXJcbnZhciBTZXJpYWxpemVyID0gbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAobm9kZSwgb3B0aW9ucykge1xuICAgIHRoaXMub3B0aW9ucyA9IG1lcmdlT3B0aW9ucyhERUZBVUxUX09QVElPTlMsIG9wdGlvbnMpO1xuICAgIHRoaXMudHJlZUFkYXB0ZXIgPSB0aGlzLm9wdGlvbnMudHJlZUFkYXB0ZXI7XG5cbiAgICB0aGlzLmh0bWwgPSAnJztcbiAgICB0aGlzLnN0YXJ0Tm9kZSA9IG5vZGU7XG59O1xuXG4vLyBOT1RFOiBleHBvcnRlZCBhcyBzdGF0aWMgbWV0aG9kIGZvciB0aGUgdGVzdGluZyBwdXJwb3Nlc1xuU2VyaWFsaXplci5lc2NhcGVTdHJpbmcgPSBmdW5jdGlvbiAoc3RyLCBhdHRyTW9kZSkge1xuICAgIHN0ciA9IHN0clxuICAgICAgICAucmVwbGFjZShBTVBfUkVHRVgsICcmYW1wOycpXG4gICAgICAgIC5yZXBsYWNlKE5CU1BfUkVHRVgsICcmbmJzcDsnKTtcblxuICAgIGlmIChhdHRyTW9kZSlcbiAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoRE9VQkxFX1FVT1RFX1JFR0VYLCAnJnF1b3Q7Jyk7XG5cbiAgICBlbHNlIHtcbiAgICAgICAgc3RyID0gc3RyXG4gICAgICAgICAgICAucmVwbGFjZShMVF9SRUdFWCwgJyZsdDsnKVxuICAgICAgICAgICAgLnJlcGxhY2UoR1RfUkVHRVgsICcmZ3Q7Jyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0cjtcbn07XG5cblxuLy9BUElcblNlcmlhbGl6ZXIucHJvdG90eXBlLnNlcmlhbGl6ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLl9zZXJpYWxpemVDaGlsZE5vZGVzKHRoaXMuc3RhcnROb2RlKTtcblxuICAgIHJldHVybiB0aGlzLmh0bWw7XG59O1xuXG5cbi8vSW50ZXJuYWxzXG5TZXJpYWxpemVyLnByb3RvdHlwZS5fc2VyaWFsaXplQ2hpbGROb2RlcyA9IGZ1bmN0aW9uIChwYXJlbnROb2RlKSB7XG4gICAgdmFyIGNoaWxkTm9kZXMgPSB0aGlzLnRyZWVBZGFwdGVyLmdldENoaWxkTm9kZXMocGFyZW50Tm9kZSk7XG5cbiAgICBpZiAoY2hpbGROb2Rlcykge1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgY25MZW5ndGggPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGNuTGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IGNoaWxkTm9kZXNbaV07XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnRyZWVBZGFwdGVyLmlzRWxlbWVudE5vZGUoY3VycmVudE5vZGUpKVxuICAgICAgICAgICAgICAgIHRoaXMuX3NlcmlhbGl6ZUVsZW1lbnQoY3VycmVudE5vZGUpO1xuXG4gICAgICAgICAgICBlbHNlIGlmICh0aGlzLnRyZWVBZGFwdGVyLmlzVGV4dE5vZGUoY3VycmVudE5vZGUpKVxuICAgICAgICAgICAgICAgIHRoaXMuX3NlcmlhbGl6ZVRleHROb2RlKGN1cnJlbnROb2RlKTtcblxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy50cmVlQWRhcHRlci5pc0NvbW1lbnROb2RlKGN1cnJlbnROb2RlKSlcbiAgICAgICAgICAgICAgICB0aGlzLl9zZXJpYWxpemVDb21tZW50Tm9kZShjdXJyZW50Tm9kZSk7XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudHJlZUFkYXB0ZXIuaXNEb2N1bWVudFR5cGVOb2RlKGN1cnJlbnROb2RlKSlcbiAgICAgICAgICAgICAgICB0aGlzLl9zZXJpYWxpemVEb2N1bWVudFR5cGVOb2RlKGN1cnJlbnROb2RlKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cblNlcmlhbGl6ZXIucHJvdG90eXBlLl9zZXJpYWxpemVFbGVtZW50ID0gZnVuY3Rpb24gKG5vZGUpIHtcbiAgICB2YXIgdG4gPSB0aGlzLnRyZWVBZGFwdGVyLmdldFRhZ05hbWUobm9kZSksXG4gICAgICAgIG5zID0gdGhpcy50cmVlQWRhcHRlci5nZXROYW1lc3BhY2VVUkkobm9kZSk7XG5cbiAgICB0aGlzLmh0bWwgKz0gJzwnICsgdG47XG4gICAgdGhpcy5fc2VyaWFsaXplQXR0cmlidXRlcyhub2RlKTtcbiAgICB0aGlzLmh0bWwgKz0gJz4nO1xuXG4gICAgaWYgKHRuICE9PSAkLkFSRUEgJiYgdG4gIT09ICQuQkFTRSAmJiB0biAhPT0gJC5CQVNFRk9OVCAmJiB0biAhPT0gJC5CR1NPVU5EICYmIHRuICE9PSAkLkJSICYmIHRuICE9PSAkLkJSICYmXG4gICAgICAgIHRuICE9PSAkLkNPTCAmJiB0biAhPT0gJC5FTUJFRCAmJiB0biAhPT0gJC5GUkFNRSAmJiB0biAhPT0gJC5IUiAmJiB0biAhPT0gJC5JTUcgJiYgdG4gIT09ICQuSU5QVVQgJiZcbiAgICAgICAgdG4gIT09ICQuS0VZR0VOICYmIHRuICE9PSAkLkxJTksgJiYgdG4gIT09ICQuTUVOVUlURU0gJiYgdG4gIT09ICQuTUVUQSAmJiB0biAhPT0gJC5QQVJBTSAmJiB0biAhPT0gJC5TT1VSQ0UgJiZcbiAgICAgICAgdG4gIT09ICQuVFJBQ0sgJiYgdG4gIT09ICQuV0JSKSB7XG5cbiAgICAgICAgdmFyIGNoaWxkTm9kZXNIb2xkZXIgPSB0biA9PT0gJC5URU1QTEFURSAmJiBucyA9PT0gTlMuSFRNTCA/XG4gICAgICAgICAgICB0aGlzLnRyZWVBZGFwdGVyLmdldFRlbXBsYXRlQ29udGVudChub2RlKSA6XG4gICAgICAgICAgICBub2RlO1xuXG4gICAgICAgIHRoaXMuX3NlcmlhbGl6ZUNoaWxkTm9kZXMoY2hpbGROb2Rlc0hvbGRlcik7XG4gICAgICAgIHRoaXMuaHRtbCArPSAnPC8nICsgdG4gKyAnPic7XG4gICAgfVxufTtcblxuU2VyaWFsaXplci5wcm90b3R5cGUuX3NlcmlhbGl6ZUF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAobm9kZSkge1xuICAgIHZhciBhdHRycyA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0QXR0ckxpc3Qobm9kZSk7XG5cbiAgICBmb3IgKHZhciBpID0gMCwgYXR0cnNMZW5ndGggPSBhdHRycy5sZW5ndGg7IGkgPCBhdHRyc0xlbmd0aDsgaSsrKSB7XG4gICAgICAgIHZhciBhdHRyID0gYXR0cnNbaV0sXG4gICAgICAgICAgICB2YWx1ZSA9IFNlcmlhbGl6ZXIuZXNjYXBlU3RyaW5nKGF0dHIudmFsdWUsIHRydWUpO1xuXG4gICAgICAgIHRoaXMuaHRtbCArPSAnICc7XG5cbiAgICAgICAgaWYgKCFhdHRyLm5hbWVzcGFjZSlcbiAgICAgICAgICAgIHRoaXMuaHRtbCArPSBhdHRyLm5hbWU7XG5cbiAgICAgICAgZWxzZSBpZiAoYXR0ci5uYW1lc3BhY2UgPT09IE5TLlhNTClcbiAgICAgICAgICAgIHRoaXMuaHRtbCArPSAneG1sOicgKyBhdHRyLm5hbWU7XG5cbiAgICAgICAgZWxzZSBpZiAoYXR0ci5uYW1lc3BhY2UgPT09IE5TLlhNTE5TKSB7XG4gICAgICAgICAgICBpZiAoYXR0ci5uYW1lICE9PSAneG1sbnMnKVxuICAgICAgICAgICAgICAgIHRoaXMuaHRtbCArPSAneG1sbnM6JztcblxuICAgICAgICAgICAgdGhpcy5odG1sICs9IGF0dHIubmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGVsc2UgaWYgKGF0dHIubmFtZXNwYWNlID09PSBOUy5YTElOSylcbiAgICAgICAgICAgIHRoaXMuaHRtbCArPSAneGxpbms6JyArIGF0dHIubmFtZTtcblxuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLmh0bWwgKz0gYXR0ci5uYW1lc3BhY2UgKyAnOicgKyBhdHRyLm5hbWU7XG5cbiAgICAgICAgdGhpcy5odG1sICs9ICc9XCInICsgdmFsdWUgKyAnXCInO1xuICAgIH1cbn07XG5cblNlcmlhbGl6ZXIucHJvdG90eXBlLl9zZXJpYWxpemVUZXh0Tm9kZSA9IGZ1bmN0aW9uIChub2RlKSB7XG4gICAgdmFyIGNvbnRlbnQgPSB0aGlzLnRyZWVBZGFwdGVyLmdldFRleHROb2RlQ29udGVudChub2RlKSxcbiAgICAgICAgcGFyZW50ID0gdGhpcy50cmVlQWRhcHRlci5nZXRQYXJlbnROb2RlKG5vZGUpLFxuICAgICAgICBwYXJlbnRUbiA9IHZvaWQgMDtcblxuICAgIGlmIChwYXJlbnQgJiYgdGhpcy50cmVlQWRhcHRlci5pc0VsZW1lbnROb2RlKHBhcmVudCkpXG4gICAgICAgIHBhcmVudFRuID0gdGhpcy50cmVlQWRhcHRlci5nZXRUYWdOYW1lKHBhcmVudCk7XG5cbiAgICBpZiAocGFyZW50VG4gPT09ICQuU1RZTEUgfHwgcGFyZW50VG4gPT09ICQuU0NSSVBUIHx8IHBhcmVudFRuID09PSAkLlhNUCB8fCBwYXJlbnRUbiA9PT0gJC5JRlJBTUUgfHxcbiAgICAgICAgcGFyZW50VG4gPT09ICQuTk9FTUJFRCB8fCBwYXJlbnRUbiA9PT0gJC5OT0ZSQU1FUyB8fCBwYXJlbnRUbiA9PT0gJC5QTEFJTlRFWFQgfHwgcGFyZW50VG4gPT09ICQuTk9TQ1JJUFQpXG5cbiAgICAgICAgdGhpcy5odG1sICs9IGNvbnRlbnQ7XG5cbiAgICBlbHNlXG4gICAgICAgIHRoaXMuaHRtbCArPSBTZXJpYWxpemVyLmVzY2FwZVN0cmluZyhjb250ZW50LCBmYWxzZSk7XG59O1xuXG5TZXJpYWxpemVyLnByb3RvdHlwZS5fc2VyaWFsaXplQ29tbWVudE5vZGUgPSBmdW5jdGlvbiAobm9kZSkge1xuICAgIHRoaXMuaHRtbCArPSAnPCEtLScgKyB0aGlzLnRyZWVBZGFwdGVyLmdldENvbW1lbnROb2RlQ29udGVudChub2RlKSArICctLT4nO1xufTtcblxuU2VyaWFsaXplci5wcm90b3R5cGUuX3NlcmlhbGl6ZURvY3VtZW50VHlwZU5vZGUgPSBmdW5jdGlvbiAobm9kZSkge1xuICAgIHZhciBuYW1lID0gdGhpcy50cmVlQWRhcHRlci5nZXREb2N1bWVudFR5cGVOb2RlTmFtZShub2RlKTtcblxuICAgIHRoaXMuaHRtbCArPSAnPCcgKyBkb2N0eXBlLnNlcmlhbGl6ZUNvbnRlbnQobmFtZSwgbnVsbCwgbnVsbCkgKyAnPic7XG59O1xuIl19