f9a08c10dc0ded0542f13e81a1637f25
'use strict';

var Mixin = require("../../utils/mixin"),
    Tokenizer = require("../../tokenizer"),
    PositionTrackingPreprocessorMixin = require("../position_tracking/preprocessor_mixin"),
    inherits = require('util').inherits;

var LocationInfoTokenizerMixin = module.exports = function (tokenizer) {
  Mixin.call(this, tokenizer);
  this.tokenizer = tokenizer;
  this.posTracker = new PositionTrackingPreprocessorMixin(tokenizer.preprocessor);
  this.currentAttrLocation = null;
  this.currentTokenLocation = null;
};

inherits(LocationInfoTokenizerMixin, Mixin);

LocationInfoTokenizerMixin.prototype._getCurrentLocation = function () {
  return {
    line: this.posTracker.line,
    col: this.posTracker.col,
    startOffset: this.posTracker.offset,
    endOffset: -1
  };
};

LocationInfoTokenizerMixin.prototype._attachCurrentAttrLocationInfo = function () {
  this.currentAttrLocation.endOffset = this.posTracker.offset;
  var currentToken = this.tokenizer.currentToken,
      currentAttr = this.tokenizer.currentAttr;
  if (!currentToken.location.attrs) currentToken.location.attrs = Object.create(null);
  currentToken.location.attrs[currentAttr.name] = this.currentAttrLocation;
};

LocationInfoTokenizerMixin.prototype._getOverriddenMethods = function (mxn, orig) {
  var methods = {
    _createStartTagToken: function _createStartTagToken() {
      orig._createStartTagToken.call(this);

      this.currentToken.location = mxn.currentTokenLocation;
    },
    _createEndTagToken: function _createEndTagToken() {
      orig._createEndTagToken.call(this);

      this.currentToken.location = mxn.currentTokenLocation;
    },
    _createCommentToken: function _createCommentToken() {
      orig._createCommentToken.call(this);

      this.currentToken.location = mxn.currentTokenLocation;
    },
    _createDoctypeToken: function _createDoctypeToken(initialName) {
      orig._createDoctypeToken.call(this, initialName);

      this.currentToken.location = mxn.currentTokenLocation;
    },
    _createCharacterToken: function _createCharacterToken(type, ch) {
      orig._createCharacterToken.call(this, type, ch);

      this.currentCharacterToken.location = mxn.currentTokenLocation;
    },
    _createAttr: function _createAttr(attrNameFirstCh) {
      orig._createAttr.call(this, attrNameFirstCh);

      mxn.currentAttrLocation = mxn._getCurrentLocation();
    },
    _leaveAttrName: function _leaveAttrName(toState) {
      orig._leaveAttrName.call(this, toState);

      mxn._attachCurrentAttrLocationInfo();
    },
    _leaveAttrValue: function _leaveAttrValue(toState) {
      orig._leaveAttrValue.call(this, toState);

      mxn._attachCurrentAttrLocationInfo();
    },
    _emitCurrentToken: function _emitCurrentToken() {
      if (this.currentCharacterToken) this.currentCharacterToken.location.endOffset = this.currentToken.location.startOffset;
      this.currentToken.location.endOffset = mxn.posTracker.offset + 1;

      orig._emitCurrentToken.call(this);
    },
    _emitCurrentCharacterToken: function _emitCurrentCharacterToken() {
      if (this.currentCharacterToken && this.currentCharacterToken.location.endOffset === -1) this.currentCharacterToken.location.endOffset = mxn.posTracker.offset;

      orig._emitCurrentCharacterToken.call(this);
    }
  };
  Object.keys(Tokenizer.MODE).forEach(function (modeName) {
    var state = Tokenizer.MODE[modeName];

    methods[state] = function (cp) {
      mxn.currentTokenLocation = mxn._getCurrentLocation();
      orig[state].call(this, cp);
    };
  });
  return methods;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRva2VuaXplcl9taXhpbi5qcyJdLCJuYW1lcyI6WyJNaXhpbiIsInJlcXVpcmUiLCJUb2tlbml6ZXIiLCJQb3NpdGlvblRyYWNraW5nUHJlcHJvY2Vzc29yTWl4aW4iLCJpbmhlcml0cyIsIkxvY2F0aW9uSW5mb1Rva2VuaXplck1peGluIiwibW9kdWxlIiwiZXhwb3J0cyIsInRva2VuaXplciIsImNhbGwiLCJwb3NUcmFja2VyIiwicHJlcHJvY2Vzc29yIiwiY3VycmVudEF0dHJMb2NhdGlvbiIsImN1cnJlbnRUb2tlbkxvY2F0aW9uIiwicHJvdG90eXBlIiwiX2dldEN1cnJlbnRMb2NhdGlvbiIsImxpbmUiLCJjb2wiLCJzdGFydE9mZnNldCIsIm9mZnNldCIsImVuZE9mZnNldCIsIl9hdHRhY2hDdXJyZW50QXR0ckxvY2F0aW9uSW5mbyIsImN1cnJlbnRUb2tlbiIsImN1cnJlbnRBdHRyIiwibG9jYXRpb24iLCJhdHRycyIsIk9iamVjdCIsImNyZWF0ZSIsIm5hbWUiLCJfZ2V0T3ZlcnJpZGRlbk1ldGhvZHMiLCJteG4iLCJvcmlnIiwibWV0aG9kcyIsIl9jcmVhdGVTdGFydFRhZ1Rva2VuIiwiX2NyZWF0ZUVuZFRhZ1Rva2VuIiwiX2NyZWF0ZUNvbW1lbnRUb2tlbiIsIl9jcmVhdGVEb2N0eXBlVG9rZW4iLCJpbml0aWFsTmFtZSIsIl9jcmVhdGVDaGFyYWN0ZXJUb2tlbiIsInR5cGUiLCJjaCIsImN1cnJlbnRDaGFyYWN0ZXJUb2tlbiIsIl9jcmVhdGVBdHRyIiwiYXR0ck5hbWVGaXJzdENoIiwiX2xlYXZlQXR0ck5hbWUiLCJ0b1N0YXRlIiwiX2xlYXZlQXR0clZhbHVlIiwiX2VtaXRDdXJyZW50VG9rZW4iLCJfZW1pdEN1cnJlbnRDaGFyYWN0ZXJUb2tlbiIsImtleXMiLCJNT0RFIiwiZm9yRWFjaCIsIm1vZGVOYW1lIiwic3RhdGUiLCJjcCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBSUEsS0FBSyxHQUFHQyxPQUFPLHFCQUFuQjtBQUFB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QWxCLENBQTJCSixTQUEzQixHQUF1Q1UsR0FBRyxDQUFDcEIsVUFBSixDQUFlUyxNQUFmLEdBQXdCLENBQS9EOztBQUNBWSxNQUFBQSxJQUFJLENBQUNnQixpQkFBTCxDQUF1QnRDLElBQXZCLENBQTRCLElBQTVCO0FBQ0gsS0FqRFM7QUFtRFZ1QyxJQUFBQSwwQkFBMEIsRUFBRSxzQ0FBWTtBQU1wQyxVQUFJLEtBQUtQLHFCQUFMLElBQThCLEtBQUtBLHFCQUFMLENBQTJCakIsUUFBM0IsQ0FBb0NKLFNBQXBDLEtBQWtELENBQUMsQ0FBckYsRUFDSSxLQUFLcUIscUJBQUwsQ0FBMkJqQixRQUEzQixDQUFvQ0osU0FBcEMsR0FBZ0RVLEdBQUcsQ0FBQ3BCLFVBQUosQ0FBZVMsTUFBL0Q7O0FBRUpZLE1BQUFBLElBQUksQ0FBQ2lCLDBCQUFMLENBQWdDdkMsSUFBaEMsQ0FBcUMsSUFBckM7QUFDSDtBQTdEUyxHQUFkO0FBaUVBaUIsRUFBQUEsTUFBTSxDQUFDdUIsSUFBUCxDQUFZL0MsU0FBUyxDQUFDZ0QsSUFBdEIsRUFBNEJDLE9BQTVCLENBQW9DLFVBQVVDLFFBQVYsRUFBb0I7QUFDcEQsUUFBSUMsS0FBSyxHQUFHbkQsU0FBUyxDQUFDZ0QsSUFBVixDQUFlRSxRQUFmLENBQVo7O0FBRUFwQixJQUFBQSxPQUFPLENBQUNxQixLQUFELENBQVAsR0FBaUIsVUFBVUMsRUFBVixFQUFjO0FBQzNCeEIsTUFBQUEsR0FBRyxDQUFDakIsb0JBQUosR0FBMkJpQixHQUFHLENBQUNmLG1CQUFKLEVBQTNCO0FBQ0FnQixNQUFBQSxJQUFJLENBQUNzQixLQUFELENBQUosQ0FBWTVDLElBQVosQ0FBaUIsSUFBakIsRUFBdUI2QyxFQUF2QjtBQUNILEtBSEQ7QUFJSCxHQVBEO0FBU0EsU0FBT3RCLE9BQVA7QUFDSCxDQTVFRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIE1peGluID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvbWl4aW4nKSxcbiAgICBUb2tlbml6ZXIgPSByZXF1aXJlKCcuLi8uLi90b2tlbml6ZXInKSxcbiAgICBQb3NpdGlvblRyYWNraW5nUHJlcHJvY2Vzc29yTWl4aW4gPSByZXF1aXJlKCcuLi9wb3NpdGlvbl90cmFja2luZy9wcmVwcm9jZXNzb3JfbWl4aW4nKSxcbiAgICBpbmhlcml0cyA9IHJlcXVpcmUoJ3V0aWwnKS5pbmhlcml0cztcblxudmFyIExvY2F0aW9uSW5mb1Rva2VuaXplck1peGluID0gbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAodG9rZW5pemVyKSB7XG4gICAgTWl4aW4uY2FsbCh0aGlzLCB0b2tlbml6ZXIpO1xuXG4gICAgdGhpcy50b2tlbml6ZXIgPSB0b2tlbml6ZXI7XG4gICAgdGhpcy5wb3NUcmFja2VyID0gbmV3IFBvc2l0aW9uVHJhY2tpbmdQcmVwcm9jZXNzb3JNaXhpbih0b2tlbml6ZXIucHJlcHJvY2Vzc29yKTtcbiAgICB0aGlzLmN1cnJlbnRBdHRyTG9jYXRpb24gPSBudWxsO1xuICAgIHRoaXMuY3VycmVudFRva2VuTG9jYXRpb24gPSBudWxsO1xufTtcblxuaW5oZXJpdHMoTG9jYXRpb25JbmZvVG9rZW5pemVyTWl4aW4sIE1peGluKTtcblxuTG9jYXRpb25JbmZvVG9rZW5pemVyTWl4aW4ucHJvdG90eXBlLl9nZXRDdXJyZW50TG9jYXRpb24gPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgbGluZTogdGhpcy5wb3NUcmFja2VyLmxpbmUsXG4gICAgICAgIGNvbDogdGhpcy5wb3NUcmFja2VyLmNvbCxcbiAgICAgICAgc3RhcnRPZmZzZXQ6IHRoaXMucG9zVHJhY2tlci5vZmZzZXQsXG4gICAgICAgIGVuZE9mZnNldDogLTFcbiAgICB9O1xufTtcblxuTG9jYXRpb25JbmZvVG9rZW5pemVyTWl4aW4ucHJvdG90eXBlLl9hdHRhY2hDdXJyZW50QXR0ckxvY2F0aW9uSW5mbyA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmN1cnJlbnRBdHRyTG9jYXRpb24uZW5kT2Zmc2V0ID0gdGhpcy5wb3NUcmFja2VyLm9mZnNldDtcblxuICAgIHZhciBjdXJyZW50VG9rZW4gPSB0aGlzLnRva2VuaXplci5jdXJyZW50VG9rZW4sXG4gICAgICAgIGN1cnJlbnRBdHRyID0gdGhpcy50b2tlbml6ZXIuY3VycmVudEF0dHI7XG5cbiAgICBpZiAoIWN1cnJlbnRUb2tlbi5sb2NhdGlvbi5hdHRycylcbiAgICAgICAgY3VycmVudFRva2VuLmxvY2F0aW9uLmF0dHJzID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAgIGN1cnJlbnRUb2tlbi5sb2NhdGlvbi5hdHRyc1tjdXJyZW50QXR0ci5uYW1lXSA9IHRoaXMuY3VycmVudEF0dHJMb2NhdGlvbjtcbn07XG5cbkxvY2F0aW9uSW5mb1Rva2VuaXplck1peGluLnByb3RvdHlwZS5fZ2V0T3ZlcnJpZGRlbk1ldGhvZHMgPSBmdW5jdGlvbiAobXhuLCBvcmlnKSB7XG4gICAgdmFyIG1ldGhvZHMgPSB7XG4gICAgICAgIF9jcmVhdGVTdGFydFRhZ1Rva2VuOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBvcmlnLl9jcmVhdGVTdGFydFRhZ1Rva2VuLmNhbGwodGhpcyk7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRUb2tlbi5sb2NhdGlvbiA9IG14bi5jdXJyZW50VG9rZW5Mb2NhdGlvbjtcbiAgICAgICAgfSxcblxuICAgICAgICBfY3JlYXRlRW5kVGFnVG9rZW46IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIG9yaWcuX2NyZWF0ZUVuZFRhZ1Rva2VuLmNhbGwodGhpcyk7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRUb2tlbi5sb2NhdGlvbiA9IG14bi5jdXJyZW50VG9rZW5Mb2NhdGlvbjtcbiAgICAgICAgfSxcblxuICAgICAgICBfY3JlYXRlQ29tbWVudFRva2VuOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBvcmlnLl9jcmVhdGVDb21tZW50VG9rZW4uY2FsbCh0aGlzKTtcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFRva2VuLmxvY2F0aW9uID0gbXhuLmN1cnJlbnRUb2tlbkxvY2F0aW9uO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9jcmVhdGVEb2N0eXBlVG9rZW46IGZ1bmN0aW9uIChpbml0aWFsTmFtZSkge1xuICAgICAgICAgICAgb3JpZy5fY3JlYXRlRG9jdHlwZVRva2VuLmNhbGwodGhpcywgaW5pdGlhbE5hbWUpO1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50VG9rZW4ubG9jYXRpb24gPSBteG4uY3VycmVudFRva2VuTG9jYXRpb247XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2NyZWF0ZUNoYXJhY3RlclRva2VuOiBmdW5jdGlvbiAodHlwZSwgY2gpIHtcbiAgICAgICAgICAgIG9yaWcuX2NyZWF0ZUNoYXJhY3RlclRva2VuLmNhbGwodGhpcywgdHlwZSwgY2gpO1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50Q2hhcmFjdGVyVG9rZW4ubG9jYXRpb24gPSBteG4uY3VycmVudFRva2VuTG9jYXRpb247XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2NyZWF0ZUF0dHI6IGZ1bmN0aW9uIChhdHRyTmFtZUZpcnN0Q2gpIHtcbiAgICAgICAgICAgIG9yaWcuX2NyZWF0ZUF0dHIuY2FsbCh0aGlzLCBhdHRyTmFtZUZpcnN0Q2gpO1xuICAgICAgICAgICAgbXhuLmN1cnJlbnRBdHRyTG9jYXRpb24gPSBteG4uX2dldEN1cnJlbnRMb2NhdGlvbigpO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9sZWF2ZUF0dHJOYW1lOiBmdW5jdGlvbiAodG9TdGF0ZSkge1xuICAgICAgICAgICAgb3JpZy5fbGVhdmVBdHRyTmFtZS5jYWxsKHRoaXMsIHRvU3RhdGUpO1xuICAgICAgICAgICAgbXhuLl9hdHRhY2hDdXJyZW50QXR0ckxvY2F0aW9uSW5mbygpO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9sZWF2ZUF0dHJWYWx1ZTogZnVuY3Rpb24gKHRvU3RhdGUpIHtcbiAgICAgICAgICAgIG9yaWcuX2xlYXZlQXR0clZhbHVlLmNhbGwodGhpcywgdG9TdGF0ZSk7XG4gICAgICAgICAgICBteG4uX2F0dGFjaEN1cnJlbnRBdHRyTG9jYXRpb25JbmZvKCk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2VtaXRDdXJyZW50VG9rZW46IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vTk9URTogaWYgd2UgaGF2ZSBwZW5kaW5nIGNoYXJhY3RlciB0b2tlbiBtYWtlIGl0J3MgZW5kIGxvY2F0aW9uIGVxdWFsIHRvIHRoZVxuICAgICAgICAgICAgLy9jdXJyZW50IHRva2VuJ3Mgc3RhcnQgbG9jYXRpb24uXG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50Q2hhcmFjdGVyVG9rZW4pXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50Q2hhcmFjdGVyVG9rZW4ubG9jYXRpb24uZW5kT2Zmc2V0ID0gdGhpcy5jdXJyZW50VG9rZW4ubG9jYXRpb24uc3RhcnRPZmZzZXQ7XG5cbiAgICAgICAgICAgIHRoaXMuY3VycmVudFRva2VuLmxvY2F0aW9uLmVuZE9mZnNldCA9IG14bi5wb3NUcmFja2VyLm9mZnNldCArIDE7XG4gICAgICAgICAgICBvcmlnLl9lbWl0Q3VycmVudFRva2VuLmNhbGwodGhpcyk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2VtaXRDdXJyZW50Q2hhcmFjdGVyVG9rZW46IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vTk9URTogaWYgd2UgaGF2ZSBjaGFyYWN0ZXIgdG9rZW4gYW5kIGl0J3MgbG9jYXRpb24gd2Fzbid0IHNldCBpbiB0aGUgX2VtaXRDdXJyZW50VG9rZW4oKSxcbiAgICAgICAgICAgIC8vdGhlbiBzZXQgaXQncyBsb2NhdGlvbiBhdCB0aGUgY3VycmVudCBwcmVwcm9jZXNzb3IgcG9zaXRpb24uXG4gICAgICAgICAgICAvL1dlIGRvbid0IG5lZWQgdG8gaW5jcmVtZW50IHByZXByb2Nlc3NvciBwb3NpdGlvbiwgc2luY2UgY2hhcmFjdGVyIHRva2VuXG4gICAgICAgICAgICAvL2VtaXNzaW9uIGlzIGFsd2F5cyBmb3JjZWQgYnkgdGhlIHN0YXJ0IG9mIHRoZSBuZXh0IGNoYXJhY3RlciB0b2tlbiBoZXJlLlxuICAgICAgICAgICAgLy9Tbywgd2UgYWxyZWFkeSBoYXZlIGFkdmFuY2VkIHBvc2l0aW9uLlxuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudENoYXJhY3RlclRva2VuICYmIHRoaXMuY3VycmVudENoYXJhY3RlclRva2VuLmxvY2F0aW9uLmVuZE9mZnNldCA9PT0gLTEpXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50Q2hhcmFjdGVyVG9rZW4ubG9jYXRpb24uZW5kT2Zmc2V0ID0gbXhuLnBvc1RyYWNrZXIub2Zmc2V0O1xuXG4gICAgICAgICAgICBvcmlnLl9lbWl0Q3VycmVudENoYXJhY3RlclRva2VuLmNhbGwodGhpcyk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgLy9OT1RFOiBwYXRjaCBpbml0aWFsIHN0YXRlcyBmb3IgZWFjaCBtb2RlIHRvIG9idGFpbiB0b2tlbiBzdGFydCBwb3NpdGlvblxuICAgIE9iamVjdC5rZXlzKFRva2VuaXplci5NT0RFKS5mb3JFYWNoKGZ1bmN0aW9uIChtb2RlTmFtZSkge1xuICAgICAgICB2YXIgc3RhdGUgPSBUb2tlbml6ZXIuTU9ERVttb2RlTmFtZV07XG5cbiAgICAgICAgbWV0aG9kc1tzdGF0ZV0gPSBmdW5jdGlvbiAoY3ApIHtcbiAgICAgICAgICAgIG14bi5jdXJyZW50VG9rZW5Mb2NhdGlvbiA9IG14bi5fZ2V0Q3VycmVudExvY2F0aW9uKCk7XG4gICAgICAgICAgICBvcmlnW3N0YXRlXS5jYWxsKHRoaXMsIGNwKTtcbiAgICAgICAgfTtcbiAgICB9KTtcblxuICAgIHJldHVybiBtZXRob2RzO1xufTtcblxuIl19