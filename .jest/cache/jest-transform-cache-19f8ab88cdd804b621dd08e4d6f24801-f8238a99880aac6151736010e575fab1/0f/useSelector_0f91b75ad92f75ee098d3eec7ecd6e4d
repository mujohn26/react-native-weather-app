bb50440fa22b5c060443ac89e043802f
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.createSelectorHook = createSelectorHook;
exports.useSelector = void 0;

var _react = require("react");

var _useReduxContext2 = require("./useReduxContext");

var _Subscription = _interopRequireDefault(require("../utils/Subscription"));

var _useIsomorphicLayoutEffect = require("../utils/useIsomorphicLayoutEffect");

var _Context = require("../components/Context");

var refEquality = function refEquality(a, b) {
  return a === b;
};

function useSelectorWithStoreAndSubscription(selector, equalityFn, store, contextSub) {
  var _useReducer = (0, _react.useReducer)(function (s) {
    return s + 1;
  }, 0),
      forceRender = _useReducer[1];

  var subscription = (0, _react.useMemo)(function () {
    return new _Subscription["default"](store, contextSub);
  }, [store, contextSub]);
  var latestSubscriptionCallbackError = (0, _react.useRef)();
  var latestSelector = (0, _react.useRef)();
  var latestStoreState = (0, _react.useRef)();
  var latestSelectedState = (0, _react.useRef)();
  var storeState = store.getState();
  var selectedState;

  try {
    if (selector !== latestSelector.current || storeState !== latestStoreState.current || latestSubscriptionCallbackError.current) {
      selectedState = selector(storeState);
    } else {
      selectedState = latestSelectedState.current;
    }
  } catch (err) {
    if (latestSubscriptionCallbackError.current) {
      err.message += "\nThe error may be correlated with this previous error:\n" + latestSubscriptionCallbackError.current.stack + "\n\n";
    }

    throw err;
  }

  (0, _useIsomorphicLayoutEffect.useIsomorphicLayoutEffect)(function () {
    latestSelector.current = selector;
    latestStoreState.current = storeState;
    latestSelectedState.current = selectedState;
    latestSubscriptionCallbackError.current = undefined;
  });
  (0, _useIsomorphicLayoutEffect.useIsomorphicLayoutEffect)(function () {
    function checkForUpdates() {
      try {
        var newSelectedState = latestSelector.current(store.getState());

        if (equalityFn(newSelectedState, latestSelectedState.current)) {
          return;
        }

        latestSelectedState.current = newSelectedState;
      } catch (err) {
        latestSubscriptionCallbackError.current = err;
      }

      forceRender();
    }

    subscription.onStateChange = checkForUpdates;
    subscription.trySubscribe();
    checkForUpdates();
    return function () {
      return subscription.tryUnsubscribe();
    };
  }, [store, subscription]);
  return selectedState;
}

function createSelectorHook(context) {
  if (context === void 0) {
    context = _Context.ReactReduxContext;
  }

  var useReduxContext = context === _Context.ReactReduxContext ? _useReduxContext2.useReduxContext : function () {
    return (0, _react.useContext)(context);
  };
  return function useSelector(selector, equalityFn) {
    if (equalityFn === void 0) {
      equalityFn = refEquality;
    }

    if (process.env.NODE_ENV !== 'production' && !selector) {
      throw new Error("You must pass a selector to useSelector");
    }

    var _useReduxContext = useReduxContext(),
        store = _useReduxContext.store,
        contextSub = _useReduxContext.subscription;

    var selectedState = useSelectorWithStoreAndSubscription(selector, equalityFn, store, contextSub);
    (0, _react.useDebugValue)(selectedState);
    return selectedState;
  };
}

var useSelector = createSelectorHook();
exports.useSelector = useSelector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVzZVNlbGVjdG9yLmpzIl0sIm5hbWVzIjpbIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiZXhwb3J0cyIsIl9fZXNNb2R1bGUiLCJjcmVhdGVTZWxlY3Rvckhvb2siLCJ1c2VTZWxlY3RvciIsIl9yZWFjdCIsIl91c2VSZWR1eENvbnRleHQyIiwiX1N1YnNjcmlwdGlvbiIsIl91c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0IiwiX0NvbnRleHQiLCJyZWZFcXVhbGl0eSIsImEiLCJiIiwidXNlU2VsZWN0b3JXaXRoU3RvcmVBbmRTdWJzY3JpcHRpb24iLCJzZWxlY3RvciIsImVxdWFsaXR5Rm4iLCJzdG9yZSIsImNvbnRleHRTdWIiLCJfdXNlUmVkdWNlciIsInVzZVJlZHVjZXIiLCJzIiwiZm9yY2VSZW5kZXIiLCJzdWJzY3JpcHRpb24iLCJ1c2VNZW1vIiwibGF0ZXN0U3Vic2NyaXB0aW9uQ2FsbGJhY2tFcnJvciIsInVzZVJlZiIsImxhdGVzdFNlbGVjdG9yIiwibGF0ZXN0U3RvcmVTdGF0ZSIsImxhdGVzdFNlbGVjdGVkU3RhdGUiLCJzdG9yZVN0YXRlIiwiZ2V0U3RhdGUiLCJzZWxlY3RlZFN0YXRlIiwiY3VycmVudCIsImVyciIsIm1lc3NhZ2UiLCJzdGFjayIsInVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QiLCJ1bmRlZmluZWQiLCJjaGVja0ZvclVwZGF0ZXMiLCJuZXdTZWxlY3RlZFN0YXRlIiwib25TdGF0ZUNoYW5nZSIsInRyeVN1YnNjcmliZSIsInRyeVVuc3Vic2NyaWJlIiwiY29udGV4dCIsIlJlYWN0UmVkdXhDb250ZXh0IiwidXNlUmVkdXhDb250ZXh0IiwidXNlQ29udGV4dCIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsIkVycm9yIiwiX3VzZVJlZHV4Q29udGV4dCIsInVzZURlYnVnVmFsdWUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLHNCQUFzQixHQUFHQyxPQUFPLENBQUMsOENBQUQsQ0FBcEM7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VSxRQUFyQixFQUErQkMsVUFBL0IsRUFBMkM7QUFDaEQsUUFBSUEsVUFBVSxLQUFLLEtBQUssQ0FBeEIsRUFBMkI7QUFDekJBLE1BQUFBLFVBQVUsR0FBR0wsV0FBYjtBQUNEOztBQUVELFFBQUlxQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsUUFBWixLQUF5QixZQUF6QixJQUF5QyxDQUFDbkMsUUFBOUMsRUFBd0Q7QUFDdEQsWUFBTSxJQUFJb0MsS0FBSixDQUFVLHlDQUFWLENBQU47QUFDRDs7QUFFRCxRQUFJQyxnQkFBZ0IsR0FBR04sZUFBZSxFQUF0QztBQUFBLFFBQ0k3QixLQUFLLEdBQUdtQyxnQkFBZ0IsQ0FBQ25DLEtBRDdCO0FBQUEsUUFFSUMsVUFBVSxHQUFHa0MsZ0JBQWdCLENBQUM3QixZQUZsQzs7QUFJQSxRQUFJUyxhQUFhLEdBQUdsQixtQ0FBbUMsQ0FBQ0MsUUFBRCxFQUFXQyxVQUFYLEVBQXVCQyxLQUF2QixFQUE4QkMsVUFBOUIsQ0FBdkQ7QUFDQSxLQUFDLEdBQUdaLE1BQU0sQ0FBQytDLGFBQVgsRUFBMEJyQixhQUExQjtBQUNBLFdBQU9BLGFBQVA7QUFDRCxHQWhCRDtBQWlCRDs7QUEwQkQsSUFBSTNCLFdBQVcsR0FBZ0JELGtCQUFrQixFQUFqRDtBQUNBRixPQUFPLENBQUNHLFdBQVIsR0FBc0JBLFdBQXRCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbnZhciBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0ID0gcmVxdWlyZShcIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvaW50ZXJvcFJlcXVpcmVEZWZhdWx0XCIpO1xuXG5leHBvcnRzLl9fZXNNb2R1bGUgPSB0cnVlO1xuZXhwb3J0cy5jcmVhdGVTZWxlY3Rvckhvb2sgPSBjcmVhdGVTZWxlY3Rvckhvb2s7XG5leHBvcnRzLnVzZVNlbGVjdG9yID0gdm9pZCAwO1xuXG52YXIgX3JlYWN0ID0gcmVxdWlyZShcInJlYWN0XCIpO1xuXG52YXIgX3VzZVJlZHV4Q29udGV4dDIgPSByZXF1aXJlKFwiLi91c2VSZWR1eENvbnRleHRcIik7XG5cbnZhciBfU3Vic2NyaXB0aW9uID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi4vdXRpbHMvU3Vic2NyaXB0aW9uXCIpKTtcblxudmFyIF91c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gcmVxdWlyZShcIi4uL3V0aWxzL3VzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3RcIik7XG5cbnZhciBfQ29udGV4dCA9IHJlcXVpcmUoXCIuLi9jb21wb25lbnRzL0NvbnRleHRcIik7XG5cbnZhciByZWZFcXVhbGl0eSA9IGZ1bmN0aW9uIHJlZkVxdWFsaXR5KGEsIGIpIHtcbiAgcmV0dXJuIGEgPT09IGI7XG59O1xuXG5mdW5jdGlvbiB1c2VTZWxlY3RvcldpdGhTdG9yZUFuZFN1YnNjcmlwdGlvbihzZWxlY3RvciwgZXF1YWxpdHlGbiwgc3RvcmUsIGNvbnRleHRTdWIpIHtcbiAgdmFyIF91c2VSZWR1Y2VyID0gKDAsIF9yZWFjdC51c2VSZWR1Y2VyKShmdW5jdGlvbiAocykge1xuICAgIHJldHVybiBzICsgMTtcbiAgfSwgMCksXG4gICAgICBmb3JjZVJlbmRlciA9IF91c2VSZWR1Y2VyWzFdO1xuXG4gIHZhciBzdWJzY3JpcHRpb24gPSAoMCwgX3JlYWN0LnVzZU1lbW8pKGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gbmV3IF9TdWJzY3JpcHRpb25bXCJkZWZhdWx0XCJdKHN0b3JlLCBjb250ZXh0U3ViKTtcbiAgfSwgW3N0b3JlLCBjb250ZXh0U3ViXSk7XG4gIHZhciBsYXRlc3RTdWJzY3JpcHRpb25DYWxsYmFja0Vycm9yID0gKDAsIF9yZWFjdC51c2VSZWYpKCk7XG4gIHZhciBsYXRlc3RTZWxlY3RvciA9ICgwLCBfcmVhY3QudXNlUmVmKSgpO1xuICB2YXIgbGF0ZXN0U3RvcmVTdGF0ZSA9ICgwLCBfcmVhY3QudXNlUmVmKSgpO1xuICB2YXIgbGF0ZXN0U2VsZWN0ZWRTdGF0ZSA9ICgwLCBfcmVhY3QudXNlUmVmKSgpO1xuICB2YXIgc3RvcmVTdGF0ZSA9IHN0b3JlLmdldFN0YXRlKCk7XG4gIHZhciBzZWxlY3RlZFN0YXRlO1xuXG4gIHRyeSB7XG4gICAgaWYgKHNlbGVjdG9yICE9PSBsYXRlc3RTZWxlY3Rvci5jdXJyZW50IHx8IHN0b3JlU3RhdGUgIT09IGxhdGVzdFN0b3JlU3RhdGUuY3VycmVudCB8fCBsYXRlc3RTdWJzY3JpcHRpb25DYWxsYmFja0Vycm9yLmN1cnJlbnQpIHtcbiAgICAgIHNlbGVjdGVkU3RhdGUgPSBzZWxlY3RvcihzdG9yZVN0YXRlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2VsZWN0ZWRTdGF0ZSA9IGxhdGVzdFNlbGVjdGVkU3RhdGUuY3VycmVudDtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChsYXRlc3RTdWJzY3JpcHRpb25DYWxsYmFja0Vycm9yLmN1cnJlbnQpIHtcbiAgICAgIGVyci5tZXNzYWdlICs9IFwiXFxuVGhlIGVycm9yIG1heSBiZSBjb3JyZWxhdGVkIHdpdGggdGhpcyBwcmV2aW91cyBlcnJvcjpcXG5cIiArIGxhdGVzdFN1YnNjcmlwdGlvbkNhbGxiYWNrRXJyb3IuY3VycmVudC5zdGFjayArIFwiXFxuXFxuXCI7XG4gICAgfVxuXG4gICAgdGhyb3cgZXJyO1xuICB9XG5cbiAgKDAsIF91c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0LnVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QpKGZ1bmN0aW9uICgpIHtcbiAgICBsYXRlc3RTZWxlY3Rvci5jdXJyZW50ID0gc2VsZWN0b3I7XG4gICAgbGF0ZXN0U3RvcmVTdGF0ZS5jdXJyZW50ID0gc3RvcmVTdGF0ZTtcbiAgICBsYXRlc3RTZWxlY3RlZFN0YXRlLmN1cnJlbnQgPSBzZWxlY3RlZFN0YXRlO1xuICAgIGxhdGVzdFN1YnNjcmlwdGlvbkNhbGxiYWNrRXJyb3IuY3VycmVudCA9IHVuZGVmaW5lZDtcbiAgfSk7XG4gICgwLCBfdXNlSXNvbW9ycGhpY0xheW91dEVmZmVjdC51c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0KShmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gY2hlY2tGb3JVcGRhdGVzKCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdmFyIG5ld1NlbGVjdGVkU3RhdGUgPSBsYXRlc3RTZWxlY3Rvci5jdXJyZW50KHN0b3JlLmdldFN0YXRlKCkpO1xuXG4gICAgICAgIGlmIChlcXVhbGl0eUZuKG5ld1NlbGVjdGVkU3RhdGUsIGxhdGVzdFNlbGVjdGVkU3RhdGUuY3VycmVudCkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsYXRlc3RTZWxlY3RlZFN0YXRlLmN1cnJlbnQgPSBuZXdTZWxlY3RlZFN0YXRlO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIHdlIGlnbm9yZSBhbGwgZXJyb3JzIGhlcmUsIHNpbmNlIHdoZW4gdGhlIGNvbXBvbmVudFxuICAgICAgICAvLyBpcyByZS1yZW5kZXJlZCwgdGhlIHNlbGVjdG9ycyBhcmUgY2FsbGVkIGFnYWluLCBhbmRcbiAgICAgICAgLy8gd2lsbCB0aHJvdyBhZ2FpbiwgaWYgbmVpdGhlciBwcm9wcyBub3Igc3RvcmUgc3RhdGVcbiAgICAgICAgLy8gY2hhbmdlZFxuICAgICAgICBsYXRlc3RTdWJzY3JpcHRpb25DYWxsYmFja0Vycm9yLmN1cnJlbnQgPSBlcnI7XG4gICAgICB9XG5cbiAgICAgIGZvcmNlUmVuZGVyKCk7XG4gICAgfVxuXG4gICAgc3Vic2NyaXB0aW9uLm9uU3RhdGVDaGFuZ2UgPSBjaGVja0ZvclVwZGF0ZXM7XG4gICAgc3Vic2NyaXB0aW9uLnRyeVN1YnNjcmliZSgpO1xuICAgIGNoZWNrRm9yVXBkYXRlcygpO1xuICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gc3Vic2NyaXB0aW9uLnRyeVVuc3Vic2NyaWJlKCk7XG4gICAgfTtcbiAgfSwgW3N0b3JlLCBzdWJzY3JpcHRpb25dKTtcbiAgcmV0dXJuIHNlbGVjdGVkU3RhdGU7XG59XG4vKipcbiAqIEhvb2sgZmFjdG9yeSwgd2hpY2ggY3JlYXRlcyBhIGB1c2VTZWxlY3RvcmAgaG9vayBib3VuZCB0byBhIGdpdmVuIGNvbnRleHQuXG4gKlxuICogQHBhcmFtIHtSZWFjdC5Db250ZXh0fSBbY29udGV4dD1SZWFjdFJlZHV4Q29udGV4dF0gQ29udGV4dCBwYXNzZWQgdG8geW91ciBgPFByb3ZpZGVyPmAuXG4gKiBAcmV0dXJucyB7RnVuY3Rpb259IEEgYHVzZVNlbGVjdG9yYCBob29rIGJvdW5kIHRvIHRoZSBzcGVjaWZpZWQgY29udGV4dC5cbiAqL1xuXG5cbmZ1bmN0aW9uIGNyZWF0ZVNlbGVjdG9ySG9vayhjb250ZXh0KSB7XG4gIGlmIChjb250ZXh0ID09PSB2b2lkIDApIHtcbiAgICBjb250ZXh0ID0gX0NvbnRleHQuUmVhY3RSZWR1eENvbnRleHQ7XG4gIH1cblxuICB2YXIgdXNlUmVkdXhDb250ZXh0ID0gY29udGV4dCA9PT0gX0NvbnRleHQuUmVhY3RSZWR1eENvbnRleHQgPyBfdXNlUmVkdXhDb250ZXh0Mi51c2VSZWR1eENvbnRleHQgOiBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuICgwLCBfcmVhY3QudXNlQ29udGV4dCkoY29udGV4dCk7XG4gIH07XG4gIHJldHVybiBmdW5jdGlvbiB1c2VTZWxlY3RvcihzZWxlY3RvciwgZXF1YWxpdHlGbikge1xuICAgIGlmIChlcXVhbGl0eUZuID09PSB2b2lkIDApIHtcbiAgICAgIGVxdWFsaXR5Rm4gPSByZWZFcXVhbGl0eTtcbiAgICB9XG5cbiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhc2VsZWN0b3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIllvdSBtdXN0IHBhc3MgYSBzZWxlY3RvciB0byB1c2VTZWxlY3RvclwiKTtcbiAgICB9XG5cbiAgICB2YXIgX3VzZVJlZHV4Q29udGV4dCA9IHVzZVJlZHV4Q29udGV4dCgpLFxuICAgICAgICBzdG9yZSA9IF91c2VSZWR1eENvbnRleHQuc3RvcmUsXG4gICAgICAgIGNvbnRleHRTdWIgPSBfdXNlUmVkdXhDb250ZXh0LnN1YnNjcmlwdGlvbjtcblxuICAgIHZhciBzZWxlY3RlZFN0YXRlID0gdXNlU2VsZWN0b3JXaXRoU3RvcmVBbmRTdWJzY3JpcHRpb24oc2VsZWN0b3IsIGVxdWFsaXR5Rm4sIHN0b3JlLCBjb250ZXh0U3ViKTtcbiAgICAoMCwgX3JlYWN0LnVzZURlYnVnVmFsdWUpKHNlbGVjdGVkU3RhdGUpO1xuICAgIHJldHVybiBzZWxlY3RlZFN0YXRlO1xuICB9O1xufVxuLyoqXG4gKiBBIGhvb2sgdG8gYWNjZXNzIHRoZSByZWR1eCBzdG9yZSdzIHN0YXRlLiBUaGlzIGhvb2sgdGFrZXMgYSBzZWxlY3RvciBmdW5jdGlvblxuICogYXMgYW4gYXJndW1lbnQuIFRoZSBzZWxlY3RvciBpcyBjYWxsZWQgd2l0aCB0aGUgc3RvcmUgc3RhdGUuXG4gKlxuICogVGhpcyBob29rIHRha2VzIGFuIG9wdGlvbmFsIGVxdWFsaXR5IGNvbXBhcmlzb24gZnVuY3Rpb24gYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXJcbiAqIHRoYXQgYWxsb3dzIHlvdSB0byBjdXN0b21pemUgdGhlIHdheSB0aGUgc2VsZWN0ZWQgc3RhdGUgaXMgY29tcGFyZWQgdG8gZGV0ZXJtaW5lXG4gKiB3aGV0aGVyIHRoZSBjb21wb25lbnQgbmVlZHMgdG8gYmUgcmUtcmVuZGVyZWQuXG4gKlxuICogQHBhcmFtIHtGdW5jdGlvbn0gc2VsZWN0b3IgdGhlIHNlbGVjdG9yIGZ1bmN0aW9uXG4gKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZXF1YWxpdHlGbiB0aGUgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIGVxdWFsaXR5XG4gKlxuICogQHJldHVybnMge2FueX0gdGhlIHNlbGVjdGVkIHN0YXRlXG4gKlxuICogQGV4YW1wbGVcbiAqXG4gKiBpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG4gKiBpbXBvcnQgeyB1c2VTZWxlY3RvciB9IGZyb20gJ3JlYWN0LXJlZHV4J1xuICpcbiAqIGV4cG9ydCBjb25zdCBDb3VudGVyQ29tcG9uZW50ID0gKCkgPT4ge1xuICogICBjb25zdCBjb3VudGVyID0gdXNlU2VsZWN0b3Ioc3RhdGUgPT4gc3RhdGUuY291bnRlcilcbiAqICAgcmV0dXJuIDxkaXY+e2NvdW50ZXJ9PC9kaXY+XG4gKiB9XG4gKi9cblxuXG52YXIgdXNlU2VsZWN0b3IgPSAvKiNfX1BVUkVfXyovY3JlYXRlU2VsZWN0b3JIb29rKCk7XG5leHBvcnRzLnVzZVNlbGVjdG9yID0gdXNlU2VsZWN0b3I7Il19