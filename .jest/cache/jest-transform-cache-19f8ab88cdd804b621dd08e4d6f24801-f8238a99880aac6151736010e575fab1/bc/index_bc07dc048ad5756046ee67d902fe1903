1cd516e834c500cda01da06b60a3d41d
var ElementType = require("domelementtype");

var re_whitespace = /\s+/g;

var NodePrototype = require("./lib/node");

var ElementPrototype = require("./lib/element");

function DomHandler(callback, options, elementCB) {
  if (typeof callback === "object") {
    elementCB = options;
    options = callback;
    callback = null;
  } else if (typeof options === "function") {
    elementCB = options;
    options = defaultOpts;
  }

  this._callback = callback;
  this._options = options || defaultOpts;
  this._elementCB = elementCB;
  this.dom = [];
  this._done = false;
  this._tagStack = [];
  this._parser = this._parser || null;
}

var defaultOpts = {
  normalizeWhitespace: false,
  withStartIndices: false,
  withEndIndices: false
};

DomHandler.prototype.onparserinit = function (parser) {
  this._parser = parser;
};

DomHandler.prototype.onreset = function () {
  DomHandler.call(this, this._callback, this._options, this._elementCB);
};

DomHandler.prototype.onend = function () {
  if (this._done) return;
  this._done = true;
  this._parser = null;

  this._handleCallback(null);
};

DomHandler.prototype._handleCallback = DomHandler.prototype.onerror = function (error) {
  if (typeof this._callback === "function") {
    this._callback(error, this.dom);
  } else {
    if (error) throw error;
  }
};

DomHandler.prototype.onclosetag = function () {
  var elem = this._tagStack.pop();

  if (this._options.withEndIndices && elem) {
    elem.endIndex = this._parser.endIndex;
  }

  if (this._elementCB) this._elementCB(elem);
};

DomHandler.prototype._createDomElement = function (properties) {
  if (!this._options.withDomLvl1) return properties;
  var element;

  if (properties.type === "tag") {
    element = Object.create(ElementPrototype);
  } else {
    element = Object.create(NodePrototype);
  }

  for (var key in properties) {
    if (properties.hasOwnProperty(key)) {
      element[key] = properties[key];
    }
  }

  return element;
};

DomHandler.prototype._addDomElement = function (element) {
  var parent = this._tagStack[this._tagStack.length - 1];
  var siblings = parent ? parent.children : this.dom;
  var previousSibling = siblings[siblings.length - 1];
  element.next = null;

  if (this._options.withStartIndices) {
    element.startIndex = this._parser.startIndex;
  }

  if (this._options.withEndIndices) {
    element.endIndex = this._parser.endIndex;
  }

  if (previousSibling) {
    element.prev = previousSibling;
    previousSibling.next = element;
  } else {
    element.prev = null;
  }

  siblings.push(element);
  element.parent = parent || null;
};

DomHandler.prototype.onopentag = function (name, attribs) {
  var properties = {
    type: name === "script" ? ElementType.Script : name === "style" ? ElementType.Style : ElementType.Tag,
    name: name,
    attribs: attribs,
    children: []
  };

  var element = this._createDomElement(properties);

  this._addDomElement(element);

  this._tagStack.push(element);
};

DomHandler.prototype.ontext = function (data) {
  var normalize = this._options.normalizeWhitespace || this._options.ignoreWhitespace;
  var lastTag;

  if (!this._tagStack.length && this.dom.length && (lastTag = this.dom[this.dom.length - 1]).type === ElementType.Text) {
    if (normalize) {
      lastTag.data = (lastTag.data + data).replace(re_whitespace, " ");
    } else {
      lastTag.data += data;
    }
  } else {
    if (this._tagStack.length && (lastTag = this._tagStack[this._tagStack.length - 1]) && (lastTag = lastTag.children[lastTag.children.length - 1]) && lastTag.type === ElementType.Text) {
      if (normalize) {
        lastTag.data = (lastTag.data + data).replace(re_whitespace, " ");
      } else {
        lastTag.data += data;
      }
    } else {
      if (normalize) {
        data = data.replace(re_whitespace, " ");
      }

      var element = this._createDomElement({
        data: data,
        type: ElementType.Text
      });

      this._addDomElement(element);
    }
  }
};

DomHandler.prototype.oncomment = function (data) {
  var lastTag = this._tagStack[this._tagStack.length - 1];

  if (lastTag && lastTag.type === ElementType.Comment) {
    lastTag.data += data;
    return;
  }

  var properties = {
    data: data,
    type: ElementType.Comment
  };

  var element = this._createDomElement(properties);

  this._addDomElement(element);

  this._tagStack.push(element);
};

DomHandler.prototype.oncdatastart = function () {
  var properties = {
    children: [{
      data: "",
      type: ElementType.Text
    }],
    type: ElementType.CDATA
  };

  var element = this._createDomElement(properties);

  this._addDomElement(element);

  this._tagStack.push(element);
};

DomHandler.prototype.oncommentend = DomHandler.prototype.oncdataend = function () {
  this._tagStack.pop();
};

DomHandler.prototype.onprocessinginstruction = function (name, data) {
  var element = this._createDomElement({
    name: name,
    data: data,
    type: ElementType.Directive
  });

  this._addDomElement(element);
};

module.exports = DomHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIkVsZW1lbnRUeXBlIiwicmVxdWlyZSIsInJlX3doaXRlc3BhY2UiLCJOb2RlUHJvdG90eXBlIiwiRWxlbWVudFByb3RvdHlwZSIsIkRvbUhhbmRsZXIiLCJjYWxsYmFjayIsIm9wdGlvbnMiLCJlbGVtZW50Q0IiLCJkZWZhdWx0T3B0cyIsIl9jYWxsYmFjayIsIl9vcHRpb25zIiwiX2VsZW1lbnRDQiIsImRvbSIsIl9kb25lIiwiX3RhZ1N0YWNrIiwiX3BhcnNlciIsIm5vcm1hbGl6ZVdoaXRlc3BhY2UiLCJ3aXRoU3RhcnRJbmRpY2VzIiwid2l0aEVuZEluZGljZXMiLCJwcm90b3R5cGUiLCJvbnBhcnNlcmluaXQiLCJwYXJzZXIiLCJvbnJlc2V0IiwiY2FsbCIsIm9uZW5kIiwiX2hhbmRsZUNhbGxiYWNrIiwib25lcnJvciIsImVycm9yIiwib25jbG9zZXRhZyIsImVsZW0iLCJwb3AiLCJlbmRJbmRleCIsIl9jcmVhdGVEb21FbGVtZW50IiwicHJvcGVydGllcyIsIndpdGhEb21MdmwxIiwiZWxlbWVudCIsInR5cGUiLCJPYmplY3QiLCJjcmVhdGUiLCJrZXkiLCJoYXNPd25Qcm9wZXJ0eSIsIl9hZGREb21FbGVtZW50IiwicGFyZW50IiwibGVuZ3RoIiwic2libGluZ3MiLCJjaGlsZHJlbiIsInByZXZpb3VzU2libGluZyIsIm5leHQiLCJzdGFydEluZGV4IiwicHJldiIsInB1c2giLCJvbm9wZW50YWciLCJuYW1lIiwiYXR0cmlicyIsIlNjcmlwdCIsIlN0eWxlIiwiVGFnIiwib250ZXh0IiwiZGF0YSIsIm5vcm1hbGl6ZSIsImlnbm9yZVdoaXRlc3BhY2UiLCJsYXN0VGFnIiwiVGV4dCIsInJlcGxhY2UiLCJvbmNvbW1lbnQiLCJDb21tZW50Iiwib25jZGF0YXN0YXJ0IiwiQ0RBVEEiLCJvbmNvbW1lbnRlbmQiLCJvbmNkYXRhZW5kIiwib25wcm9jZXNzaW5naW5zdHJ1Y3Rpb24iLCJEaXJlY3RpdmUiLCJtb2R1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QUFDaEJZLElBQUFBLFFBQVEsRUFBRSxDQUFDO0FBQ1ZhLE1BQUFBLElBQUksRUFBRSxFQURJO0FBRVZ0QixNQUFBQSxJQUFJLEVBQUVyQyxXQUFXLENBQUMrRDtBQUZSLEtBQUQsQ0FETTtBQUtoQjFCLElBQUFBLElBQUksRUFBRXJDLFdBQVcsQ0FBQ29FO0FBTEYsR0FBakI7O0FBUUEsTUFBSWhDLE9BQU8sR0FBRyxLQUFLSCxpQkFBTCxDQUF1QkMsVUFBdkIsQ0FBZDs7QUFFQSxPQUFLUSxjQUFMLENBQW9CTixPQUFwQjs7QUFDQSxPQUFLckIsU0FBTCxDQUFlb0MsSUFBZixDQUFvQmYsT0FBcEI7QUFDQSxDQWJEOztBQWVBL0IsVUFBVSxDQUFDZSxTQUFYLENBQXFCaUQsWUFBckIsR0FBb0NoRSxVQUFVLENBQUNlLFNBQVgsQ0FBcUJrRCxVQUFyQixHQUFrQyxZQUFVO0FBQy9FLE9BQUt2RCxTQUFMLENBQWVnQixHQUFmO0FBQ0EsQ0FGRDs7QUFJQTFCLFVBQVUsQ0FBQ2UsU0FBWCxDQUFxQm1ELHVCQUFyQixHQUErQyxVQUFTbEIsSUFBVCxFQUFlTSxJQUFmLEVBQW9CO0FBQ2xFLE1BQUl2QixPQUFPLEdBQUcsS0FBS0gsaUJBQUwsQ0FBdUI7QUFDcENvQixJQUFBQSxJQUFJLEVBQUVBLElBRDhCO0FBRXBDTSxJQUFBQSxJQUFJLEVBQUVBLElBRjhCO0FBR3BDdEIsSUFBQUEsSUFBSSxFQUFFckMsV0FBVyxDQUFDd0U7QUFIa0IsR0FBdkIsQ0FBZDs7QUFNQSxPQUFLOUIsY0FBTCxDQUFvQk4sT0FBcEI7QUFDQSxDQVJEOztBQVVBcUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCckUsVUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgRWxlbWVudFR5cGUgPSByZXF1aXJlKFwiZG9tZWxlbWVudHR5cGVcIik7XG5cbnZhciByZV93aGl0ZXNwYWNlID0gL1xccysvZztcbnZhciBOb2RlUHJvdG90eXBlID0gcmVxdWlyZShcIi4vbGliL25vZGVcIik7XG52YXIgRWxlbWVudFByb3RvdHlwZSA9IHJlcXVpcmUoXCIuL2xpYi9lbGVtZW50XCIpO1xuXG5mdW5jdGlvbiBEb21IYW5kbGVyKGNhbGxiYWNrLCBvcHRpb25zLCBlbGVtZW50Q0Ipe1xuXHRpZih0eXBlb2YgY2FsbGJhY2sgPT09IFwib2JqZWN0XCIpe1xuXHRcdGVsZW1lbnRDQiA9IG9wdGlvbnM7XG5cdFx0b3B0aW9ucyA9IGNhbGxiYWNrO1xuXHRcdGNhbGxiYWNrID0gbnVsbDtcblx0fSBlbHNlIGlmKHR5cGVvZiBvcHRpb25zID09PSBcImZ1bmN0aW9uXCIpe1xuXHRcdGVsZW1lbnRDQiA9IG9wdGlvbnM7XG5cdFx0b3B0aW9ucyA9IGRlZmF1bHRPcHRzO1xuXHR9XG5cdHRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2s7XG5cdHRoaXMuX29wdGlvbnMgPSBvcHRpb25zIHx8IGRlZmF1bHRPcHRzO1xuXHR0aGlzLl9lbGVtZW50Q0IgPSBlbGVtZW50Q0I7XG5cdHRoaXMuZG9tID0gW107XG5cdHRoaXMuX2RvbmUgPSBmYWxzZTtcblx0dGhpcy5fdGFnU3RhY2sgPSBbXTtcblx0dGhpcy5fcGFyc2VyID0gdGhpcy5fcGFyc2VyIHx8IG51bGw7XG59XG5cbi8vZGVmYXVsdCBvcHRpb25zXG52YXIgZGVmYXVsdE9wdHMgPSB7XG5cdG5vcm1hbGl6ZVdoaXRlc3BhY2U6IGZhbHNlLCAvL1JlcGxhY2UgYWxsIHdoaXRlc3BhY2Ugd2l0aCBzaW5nbGUgc3BhY2VzXG5cdHdpdGhTdGFydEluZGljZXM6IGZhbHNlLCAvL0FkZCBzdGFydEluZGV4IHByb3BlcnRpZXMgdG8gbm9kZXNcblx0d2l0aEVuZEluZGljZXM6IGZhbHNlLCAvL0FkZCBlbmRJbmRleCBwcm9wZXJ0aWVzIHRvIG5vZGVzXG59O1xuXG5Eb21IYW5kbGVyLnByb3RvdHlwZS5vbnBhcnNlcmluaXQgPSBmdW5jdGlvbihwYXJzZXIpe1xuXHR0aGlzLl9wYXJzZXIgPSBwYXJzZXI7XG59O1xuXG4vL1Jlc2V0cyB0aGUgaGFuZGxlciBiYWNrIHRvIHN0YXJ0aW5nIHN0YXRlXG5Eb21IYW5kbGVyLnByb3RvdHlwZS5vbnJlc2V0ID0gZnVuY3Rpb24oKXtcblx0RG9tSGFuZGxlci5jYWxsKHRoaXMsIHRoaXMuX2NhbGxiYWNrLCB0aGlzLl9vcHRpb25zLCB0aGlzLl9lbGVtZW50Q0IpO1xufTtcblxuLy9TaWduYWxzIHRoZSBoYW5kbGVyIHRoYXQgcGFyc2luZyBpcyBkb25lXG5Eb21IYW5kbGVyLnByb3RvdHlwZS5vbmVuZCA9IGZ1bmN0aW9uKCl7XG5cdGlmKHRoaXMuX2RvbmUpIHJldHVybjtcblx0dGhpcy5fZG9uZSA9IHRydWU7XG5cdHRoaXMuX3BhcnNlciA9IG51bGw7XG5cdHRoaXMuX2hhbmRsZUNhbGxiYWNrKG51bGwpO1xufTtcblxuRG9tSGFuZGxlci5wcm90b3R5cGUuX2hhbmRsZUNhbGxiYWNrID1cbkRvbUhhbmRsZXIucHJvdG90eXBlLm9uZXJyb3IgPSBmdW5jdGlvbihlcnJvcil7XG5cdGlmKHR5cGVvZiB0aGlzLl9jYWxsYmFjayA9PT0gXCJmdW5jdGlvblwiKXtcblx0XHR0aGlzLl9jYWxsYmFjayhlcnJvciwgdGhpcy5kb20pO1xuXHR9IGVsc2Uge1xuXHRcdGlmKGVycm9yKSB0aHJvdyBlcnJvcjtcblx0fVxufTtcblxuRG9tSGFuZGxlci5wcm90b3R5cGUub25jbG9zZXRhZyA9IGZ1bmN0aW9uKCl7XG5cdC8vaWYodGhpcy5fdGFnU3RhY2sucG9wKCkubmFtZSAhPT0gbmFtZSkgdGhpcy5faGFuZGxlQ2FsbGJhY2soRXJyb3IoXCJUYWduYW1lIGRpZG4ndCBtYXRjaCFcIikpO1xuXHRcblx0dmFyIGVsZW0gPSB0aGlzLl90YWdTdGFjay5wb3AoKTtcblxuXHRpZih0aGlzLl9vcHRpb25zLndpdGhFbmRJbmRpY2VzICYmIGVsZW0pe1xuXHRcdGVsZW0uZW5kSW5kZXggPSB0aGlzLl9wYXJzZXIuZW5kSW5kZXg7XG5cdH1cblxuXHRpZih0aGlzLl9lbGVtZW50Q0IpIHRoaXMuX2VsZW1lbnRDQihlbGVtKTtcbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLl9jcmVhdGVEb21FbGVtZW50ID0gZnVuY3Rpb24ocHJvcGVydGllcyl7XG5cdGlmICghdGhpcy5fb3B0aW9ucy53aXRoRG9tTHZsMSkgcmV0dXJuIHByb3BlcnRpZXM7XG5cblx0dmFyIGVsZW1lbnQ7XG5cdGlmIChwcm9wZXJ0aWVzLnR5cGUgPT09IFwidGFnXCIpIHtcblx0XHRlbGVtZW50ID0gT2JqZWN0LmNyZWF0ZShFbGVtZW50UHJvdG90eXBlKTtcblx0fSBlbHNlIHtcblx0XHRlbGVtZW50ID0gT2JqZWN0LmNyZWF0ZShOb2RlUHJvdG90eXBlKTtcblx0fVxuXG5cdGZvciAodmFyIGtleSBpbiBwcm9wZXJ0aWVzKSB7XG5cdFx0aWYgKHByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuXHRcdFx0ZWxlbWVudFtrZXldID0gcHJvcGVydGllc1trZXldO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiBlbGVtZW50O1xufTtcblxuRG9tSGFuZGxlci5wcm90b3R5cGUuX2FkZERvbUVsZW1lbnQgPSBmdW5jdGlvbihlbGVtZW50KXtcblx0dmFyIHBhcmVudCA9IHRoaXMuX3RhZ1N0YWNrW3RoaXMuX3RhZ1N0YWNrLmxlbmd0aCAtIDFdO1xuXHR2YXIgc2libGluZ3MgPSBwYXJlbnQgPyBwYXJlbnQuY2hpbGRyZW4gOiB0aGlzLmRvbTtcblx0dmFyIHByZXZpb3VzU2libGluZyA9IHNpYmxpbmdzW3NpYmxpbmdzLmxlbmd0aCAtIDFdO1xuXG5cdGVsZW1lbnQubmV4dCA9IG51bGw7XG5cblx0aWYodGhpcy5fb3B0aW9ucy53aXRoU3RhcnRJbmRpY2VzKXtcblx0XHRlbGVtZW50LnN0YXJ0SW5kZXggPSB0aGlzLl9wYXJzZXIuc3RhcnRJbmRleDtcblx0fVxuXHRpZih0aGlzLl9vcHRpb25zLndpdGhFbmRJbmRpY2VzKXtcblx0XHRlbGVtZW50LmVuZEluZGV4ID0gdGhpcy5fcGFyc2VyLmVuZEluZGV4O1xuXHR9XG5cblx0aWYocHJldmlvdXNTaWJsaW5nKXtcblx0XHRlbGVtZW50LnByZXYgPSBwcmV2aW91c1NpYmxpbmc7XG5cdFx0cHJldmlvdXNTaWJsaW5nLm5leHQgPSBlbGVtZW50O1xuXHR9IGVsc2Uge1xuXHRcdGVsZW1lbnQucHJldiA9IG51bGw7XG5cdH1cblxuXHRzaWJsaW5ncy5wdXNoKGVsZW1lbnQpO1xuXHRlbGVtZW50LnBhcmVudCA9IHBhcmVudCB8fCBudWxsO1xufTtcblxuRG9tSGFuZGxlci5wcm90b3R5cGUub25vcGVudGFnID0gZnVuY3Rpb24obmFtZSwgYXR0cmlicyl7XG5cdHZhciBwcm9wZXJ0aWVzID0ge1xuXHRcdHR5cGU6IG5hbWUgPT09IFwic2NyaXB0XCIgPyBFbGVtZW50VHlwZS5TY3JpcHQgOiBuYW1lID09PSBcInN0eWxlXCIgPyBFbGVtZW50VHlwZS5TdHlsZSA6IEVsZW1lbnRUeXBlLlRhZyxcblx0XHRuYW1lOiBuYW1lLFxuXHRcdGF0dHJpYnM6IGF0dHJpYnMsXG5cdFx0Y2hpbGRyZW46IFtdXG5cdH07XG5cblx0dmFyIGVsZW1lbnQgPSB0aGlzLl9jcmVhdGVEb21FbGVtZW50KHByb3BlcnRpZXMpO1xuXG5cdHRoaXMuX2FkZERvbUVsZW1lbnQoZWxlbWVudCk7XG5cblx0dGhpcy5fdGFnU3RhY2sucHVzaChlbGVtZW50KTtcbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLm9udGV4dCA9IGZ1bmN0aW9uKGRhdGEpe1xuXHQvL3RoZSBpZ25vcmVXaGl0ZXNwYWNlIGlzIG9mZmljaWFsbHkgZHJvcHBlZCwgYnV0IGZvciBub3csXG5cdC8vaXQncyBhbiBhbGlhcyBmb3Igbm9ybWFsaXplV2hpdGVzcGFjZVxuXHR2YXIgbm9ybWFsaXplID0gdGhpcy5fb3B0aW9ucy5ub3JtYWxpemVXaGl0ZXNwYWNlIHx8IHRoaXMuX29wdGlvbnMuaWdub3JlV2hpdGVzcGFjZTtcblxuXHR2YXIgbGFzdFRhZztcblxuXHRpZighdGhpcy5fdGFnU3RhY2subGVuZ3RoICYmIHRoaXMuZG9tLmxlbmd0aCAmJiAobGFzdFRhZyA9IHRoaXMuZG9tW3RoaXMuZG9tLmxlbmd0aC0xXSkudHlwZSA9PT0gRWxlbWVudFR5cGUuVGV4dCl7XG5cdFx0aWYobm9ybWFsaXplKXtcblx0XHRcdGxhc3RUYWcuZGF0YSA9IChsYXN0VGFnLmRhdGEgKyBkYXRhKS5yZXBsYWNlKHJlX3doaXRlc3BhY2UsIFwiIFwiKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0bGFzdFRhZy5kYXRhICs9IGRhdGE7XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdGlmKFxuXHRcdFx0dGhpcy5fdGFnU3RhY2subGVuZ3RoICYmXG5cdFx0XHQobGFzdFRhZyA9IHRoaXMuX3RhZ1N0YWNrW3RoaXMuX3RhZ1N0YWNrLmxlbmd0aCAtIDFdKSAmJlxuXHRcdFx0KGxhc3RUYWcgPSBsYXN0VGFnLmNoaWxkcmVuW2xhc3RUYWcuY2hpbGRyZW4ubGVuZ3RoIC0gMV0pICYmXG5cdFx0XHRsYXN0VGFnLnR5cGUgPT09IEVsZW1lbnRUeXBlLlRleHRcblx0XHQpe1xuXHRcdFx0aWYobm9ybWFsaXplKXtcblx0XHRcdFx0bGFzdFRhZy5kYXRhID0gKGxhc3RUYWcuZGF0YSArIGRhdGEpLnJlcGxhY2UocmVfd2hpdGVzcGFjZSwgXCIgXCIpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0bGFzdFRhZy5kYXRhICs9IGRhdGE7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdGlmKG5vcm1hbGl6ZSl7XG5cdFx0XHRcdGRhdGEgPSBkYXRhLnJlcGxhY2UocmVfd2hpdGVzcGFjZSwgXCIgXCIpO1xuXHRcdFx0fVxuXG5cdFx0XHR2YXIgZWxlbWVudCA9IHRoaXMuX2NyZWF0ZURvbUVsZW1lbnQoe1xuXHRcdFx0XHRkYXRhOiBkYXRhLFxuXHRcdFx0XHR0eXBlOiBFbGVtZW50VHlwZS5UZXh0XG5cdFx0XHR9KTtcblxuXHRcdFx0dGhpcy5fYWRkRG9tRWxlbWVudChlbGVtZW50KTtcblx0XHR9XG5cdH1cbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLm9uY29tbWVudCA9IGZ1bmN0aW9uKGRhdGEpe1xuXHR2YXIgbGFzdFRhZyA9IHRoaXMuX3RhZ1N0YWNrW3RoaXMuX3RhZ1N0YWNrLmxlbmd0aCAtIDFdO1xuXG5cdGlmKGxhc3RUYWcgJiYgbGFzdFRhZy50eXBlID09PSBFbGVtZW50VHlwZS5Db21tZW50KXtcblx0XHRsYXN0VGFnLmRhdGEgKz0gZGF0YTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHR2YXIgcHJvcGVydGllcyA9IHtcblx0XHRkYXRhOiBkYXRhLFxuXHRcdHR5cGU6IEVsZW1lbnRUeXBlLkNvbW1lbnRcblx0fTtcblxuXHR2YXIgZWxlbWVudCA9IHRoaXMuX2NyZWF0ZURvbUVsZW1lbnQocHJvcGVydGllcyk7XG5cblx0dGhpcy5fYWRkRG9tRWxlbWVudChlbGVtZW50KTtcblx0dGhpcy5fdGFnU3RhY2sucHVzaChlbGVtZW50KTtcbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLm9uY2RhdGFzdGFydCA9IGZ1bmN0aW9uKCl7XG5cdHZhciBwcm9wZXJ0aWVzID0ge1xuXHRcdGNoaWxkcmVuOiBbe1xuXHRcdFx0ZGF0YTogXCJcIixcblx0XHRcdHR5cGU6IEVsZW1lbnRUeXBlLlRleHRcblx0XHR9XSxcblx0XHR0eXBlOiBFbGVtZW50VHlwZS5DREFUQVxuXHR9O1xuXG5cdHZhciBlbGVtZW50ID0gdGhpcy5fY3JlYXRlRG9tRWxlbWVudChwcm9wZXJ0aWVzKTtcblxuXHR0aGlzLl9hZGREb21FbGVtZW50KGVsZW1lbnQpO1xuXHR0aGlzLl90YWdTdGFjay5wdXNoKGVsZW1lbnQpO1xufTtcblxuRG9tSGFuZGxlci5wcm90b3R5cGUub25jb21tZW50ZW5kID0gRG9tSGFuZGxlci5wcm90b3R5cGUub25jZGF0YWVuZCA9IGZ1bmN0aW9uKCl7XG5cdHRoaXMuX3RhZ1N0YWNrLnBvcCgpO1xufTtcblxuRG9tSGFuZGxlci5wcm90b3R5cGUub25wcm9jZXNzaW5naW5zdHJ1Y3Rpb24gPSBmdW5jdGlvbihuYW1lLCBkYXRhKXtcblx0dmFyIGVsZW1lbnQgPSB0aGlzLl9jcmVhdGVEb21FbGVtZW50KHtcblx0XHRuYW1lOiBuYW1lLFxuXHRcdGRhdGE6IGRhdGEsXG5cdFx0dHlwZTogRWxlbWVudFR5cGUuRGlyZWN0aXZlXG5cdH0pO1xuXG5cdHRoaXMuX2FkZERvbUVsZW1lbnQoZWxlbWVudCk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IERvbUhhbmRsZXI7XG4iXX0=