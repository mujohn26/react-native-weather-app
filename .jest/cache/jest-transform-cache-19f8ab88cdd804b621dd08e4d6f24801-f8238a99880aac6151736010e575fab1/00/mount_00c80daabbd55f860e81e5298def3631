b4d7b33848af4dc0d45128b1dbdd8041
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _omitBy = _interopRequireDefault(require("lodash/omitBy"));

var _isNil = _interopRequireDefault(require("lodash/isNil"));

var _reactIs = require("react-is");

var _Debug = require("enzyme/build/Debug");

var _RSTTraversal = require("enzyme/build/RSTTraversal");

var _utils = require("./utils");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function ownKeys(object, enumerableOnly) {
  var keys = Object.keys(object);

  if (Object.getOwnPropertySymbols) {
    var symbols = Object.getOwnPropertySymbols(object);
    if (enumerableOnly) symbols = symbols.filter(function (sym) {
      return Object.getOwnPropertyDescriptor(object, sym).enumerable;
    });
    keys.push.apply(keys, symbols);
  }

  return keys;
}

function _objectSpread(target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i] != null ? arguments[i] : {};

    if (i % 2) {
      ownKeys(Object(source), true).forEach(function (key) {
        _defineProperty(target, key, source[key]);
      });
    } else if (Object.getOwnPropertyDescriptors) {
      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));
    } else {
      ownKeys(Object(source)).forEach(function (key) {
        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));
      });
    }
  }

  return target;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

function getChildren(node, options) {
  if (options.mode === 'shallow' && typeof node.type === 'function') {
    return null;
  }

  var children = (0, _utils.compact)((0, _RSTTraversal.childrenOfNode)(node).map(function (n) {
    return internalNodeToJson(n, options);
  }));
  return children.length > 0 ? children : null;
}

function getProps(node, options) {
  var props = (0, _omitBy.default)(_objectSpread({}, (0, _RSTTraversal.propsOfNode)(node)), function (val, key) {
    return key === 'children' || val === undefined;
  });

  if (!(0, _isNil.default)(node.key) && options.noKey !== true) {
    props.key = node.key;
  }

  return props;
}

function internalNodeToJson(node, options) {
  if (typeof node === 'string' || typeof node === 'number') {
    return node;
  }

  if ((0, _isNil.default)(node) || node === false) {
    return '';
  }

  if (Array.isArray(node)) {
    if (node.length === 1) {
      return internalNodeToJson(node[0], options);
    }

    return node.map(function (child) {
      return internalNodeToJson(child, options);
    });
  }

  if (options.mode === 'deep' && (typeof node.type === 'function' || node.type.$$typeof === _reactIs.ForwardRef || node.type.$$typeof === _reactIs.Memo)) {
    return internalNodeToJson(node.rendered, options);
  }

  return (0, _utils.applyMap)({
    node: node,
    type: (0, _Debug.typeName)(node),
    props: getProps(node, options),
    children: getChildren(node, options),
    $$typeof: Symbol.for('react.test.json')
  }, options);
}

var mountToJson = function mountToJson(wrapper) {
  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

  if ((0, _isNil.default)(wrapper) || wrapper.length === 0) {
    return null;
  }

  if (wrapper.length > 1 && typeof wrapper.getNodesInternal === 'function') {
    var nodes = wrapper.getNodesInternal();
    return nodes.map(function (node) {
      return internalNodeToJson(node, options);
    });
  }

  if (typeof wrapper.getNodeInternal === 'function') {
    var node = wrapper.getNodeInternal();
    return internalNodeToJson(node, options);
  }

  return null;
};

var _default = mountToJson;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vdW50LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZGVmYXVsdCIsIl9vbWl0QnkiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9pc05pbCIsIl9yZWFjdElzIiwiX0RlYnVnIiwiX1JTVFRyYXZlcnNhbCIsIl91dGlscyIsIm9iaiIsIl9fZXNNb2R1bGUiLCJvd25LZXlzIiwib2JqZWN0IiwiZW51bWVyYWJsZU9ubHkiLCJrZXlzIiwiZ2V0T3duUHJvcGVydHlTeW1ib2xzIiwic3ltYm9scyIsImZpbHRlciIsInN5bSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImVudW1lcmFibGUiLCJwdXNoIiwiYXBwbHkiLCJfb2JqZWN0U3ByZWFkIiwidGFyZ2V0IiwiaSIsImFyZ3VtZW50cyIsImxlbmd0aCIsInNvdXJjZSIsImZvckVhY2giLCJrZXkiLCJfZGVmaW5lUHJvcGVydHkiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzIiwiZGVmaW5lUHJvcGVydGllcyIsImNvbmZpZ3VyYWJsZSIsIndyaXRhYmxlIiwiZ2V0Q2hpbGRyZW4iLCJub2RlIiwib3B0aW9ucyIsIm1vZGUiLCJ0eXBlIiwiY2hpbGRyZW4iLCJjb21wYWN0IiwiY2hpbGRyZW5PZk5vZGUiLCJtYXAiLCJuIiwiaW50ZXJuYWxOb2RlVG9Kc29uIiwiZ2V0UHJvcHMiLCJwcm9wcyIsInByb3BzT2ZOb2RlIiwidmFsIiwidW5kZWZpbmVkIiwibm9LZXkiLCJBcnJheSIsImlzQXJyYXkiLCJjaGlsZCIsIiQkdHlwZW9mIiwiRm9yd2FyZFJlZiIsIk1lbW8iLCJyZW5kZXJlZCIsImFwcGx5TWFwIiwidHlwZU5hbWUiLCJTeW1ib2wiLCJmb3IiLCJtb3VudFRvSnNvbiIsIndyYXBwZXIiLCJnZXROb2Rlc0ludGVybmFsIiwibm9kZXMiLCJnZXROb2RlSW50ZXJuYWwiLCJfZGVmYXVsdCJdLCJtYXBwaW5ncyI6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TyxDQUFDdEMsTUFBUixHQUFpQixDQUFqQixJQUFzQixPQUFPc0MsT0FBTyxDQUFDQyxnQkFBZixLQUFvQyxVQUE5RCxFQUEwRTtBQUN4RSxRQUFNQyxLQUFLLEdBQUdGLE9BQU8sQ0FBQ0MsZ0JBQVIsRUFBZDtBQUNBLFdBQU9DLEtBQUssQ0FBQ3ZCLEdBQU4sQ0FBVSxVQUFBUCxJQUFJO0FBQUEsYUFBSVMsa0JBQWtCLENBQUNULElBQUQsRUFBT0MsT0FBUCxDQUF0QjtBQUFBLEtBQWQsQ0FBUDtBQUNEOztBQUVELE1BQUksT0FBTzJCLE9BQU8sQ0FBQ0csZUFBZixLQUFtQyxVQUF2QyxFQUFtRDtBQUNqRCxRQUFNL0IsSUFBSSxHQUFHNEIsT0FBTyxDQUFDRyxlQUFSLEVBQWI7QUFDQSxXQUFPdEIsa0JBQWtCLENBQUNULElBQUQsRUFBT0MsT0FBUCxDQUF6QjtBQUNEOztBQUVELFNBQU8sSUFBUDtBQUNELENBaEJEOztBQWtCQSxJQUFJK0IsUUFBUSxHQUFHTCxXQUFmO0FBQ0FsRSxPQUFPLENBQUNFLE9BQVIsR0FBa0JxRSxRQUFsQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwO1xuXG52YXIgX29taXRCeSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcImxvZGFzaC9vbWl0QnlcIikpO1xuXG52YXIgX2lzTmlsID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwibG9kYXNoL2lzTmlsXCIpKTtcblxudmFyIF9yZWFjdElzID0gcmVxdWlyZShcInJlYWN0LWlzXCIpO1xuXG52YXIgX0RlYnVnID0gcmVxdWlyZShcImVuenltZS9idWlsZC9EZWJ1Z1wiKTtcblxudmFyIF9SU1RUcmF2ZXJzYWwgPSByZXF1aXJlKFwiZW56eW1lL2J1aWxkL1JTVFRyYXZlcnNhbFwiKTtcblxudmFyIF91dGlscyA9IHJlcXVpcmUoXCIuL3V0aWxzXCIpO1xuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfVxuXG5mdW5jdGlvbiBvd25LZXlzKG9iamVjdCwgZW51bWVyYWJsZU9ubHkpIHsgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmplY3QpOyBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgeyB2YXIgc3ltYm9scyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMob2JqZWN0KTsgaWYgKGVudW1lcmFibGVPbmx5KSBzeW1ib2xzID0gc3ltYm9scy5maWx0ZXIoZnVuY3Rpb24gKHN5bSkgeyByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHN5bSkuZW51bWVyYWJsZTsgfSk7IGtleXMucHVzaC5hcHBseShrZXlzLCBzeW1ib2xzKTsgfSByZXR1cm4ga2V5czsgfVxuXG5mdW5jdGlvbiBfb2JqZWN0U3ByZWFkKHRhcmdldCkgeyBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgeyB2YXIgc291cmNlID0gYXJndW1lbnRzW2ldICE9IG51bGwgPyBhcmd1bWVudHNbaV0gOiB7fTsgaWYgKGkgJSAyKSB7IG93bktleXMoT2JqZWN0KHNvdXJjZSksIHRydWUpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeyBfZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNvdXJjZVtrZXldKTsgfSk7IH0gZWxzZSBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMpIHsgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhzb3VyY2UpKTsgfSBlbHNlIHsgb3duS2V5cyhPYmplY3Qoc291cmNlKSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihzb3VyY2UsIGtleSkpOyB9KTsgfSB9IHJldHVybiB0YXJnZXQ7IH1cblxuZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KG9iaiwga2V5LCB2YWx1ZSkgeyBpZiAoa2V5IGluIG9iaikgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsgdmFsdWU6IHZhbHVlLCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pOyB9IGVsc2UgeyBvYmpba2V5XSA9IHZhbHVlOyB9IHJldHVybiBvYmo7IH1cblxuZnVuY3Rpb24gZ2V0Q2hpbGRyZW4obm9kZSwgb3B0aW9ucykge1xuICBpZiAob3B0aW9ucy5tb2RlID09PSAnc2hhbGxvdycgJiYgdHlwZW9mIG5vZGUudHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgY2hpbGRyZW4gPSAoMCwgX3V0aWxzLmNvbXBhY3QpKCgwLCBfUlNUVHJhdmVyc2FsLmNoaWxkcmVuT2ZOb2RlKShub2RlKS5tYXAobiA9PiBpbnRlcm5hbE5vZGVUb0pzb24obiwgb3B0aW9ucykpKTtcbiAgcmV0dXJuIGNoaWxkcmVuLmxlbmd0aCA+IDAgPyBjaGlsZHJlbiA6IG51bGw7XG59XG5cbmZ1bmN0aW9uIGdldFByb3BzKG5vZGUsIG9wdGlvbnMpIHtcbiAgY29uc3QgcHJvcHMgPSAoMCwgX29taXRCeS5kZWZhdWx0KShfb2JqZWN0U3ByZWFkKHt9LCAoMCwgX1JTVFRyYXZlcnNhbC5wcm9wc09mTm9kZSkobm9kZSkpLCAodmFsLCBrZXkpID0+IHtcbiAgICByZXR1cm4ga2V5ID09PSAnY2hpbGRyZW4nIHx8IHZhbCA9PT0gdW5kZWZpbmVkO1xuICB9KTtcblxuICBpZiAoISgwLCBfaXNOaWwuZGVmYXVsdCkobm9kZS5rZXkpICYmIG9wdGlvbnMubm9LZXkgIT09IHRydWUpIHtcbiAgICBwcm9wcy5rZXkgPSBub2RlLmtleTtcbiAgfVxuXG4gIHJldHVybiBwcm9wcztcbn1cblxuZnVuY3Rpb24gaW50ZXJuYWxOb2RlVG9Kc29uKG5vZGUsIG9wdGlvbnMpIHtcbiAgaWYgKHR5cGVvZiBub2RlID09PSAnc3RyaW5nJyB8fCB0eXBlb2Ygbm9kZSA9PT0gJ251bWJlcicpIHtcbiAgICByZXR1cm4gbm9kZTtcbiAgfVxuXG4gIGlmICgoMCwgX2lzTmlsLmRlZmF1bHQpKG5vZGUpIHx8IG5vZGUgPT09IGZhbHNlKSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkobm9kZSkpIHtcbiAgICAvLyBlbnp5bWUgZG9lcyBzb21lIGZ1bm55IHN0dWZmIHdpdGggbWVtbyBmdW5jdGlvbiBjb21wb25lbnRzIHR1cm5pbmcgdGhlIGNoaWxkcmVuXG4gICAgLy8gaW50byBhbiBhcnJheSByZXN1bHRpbmcgaW4gdW5kZXNpcmFibGUgc25hcHNob3RzXG4gICAgaWYgKG5vZGUubGVuZ3RoID09PSAxKSB7XG4gICAgICByZXR1cm4gaW50ZXJuYWxOb2RlVG9Kc29uKG5vZGVbMF0sIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHJldHVybiBub2RlLm1hcChjaGlsZCA9PiBpbnRlcm5hbE5vZGVUb0pzb24oY2hpbGQsIG9wdGlvbnMpKTtcbiAgfVxuXG4gIGlmIChvcHRpb25zLm1vZGUgPT09ICdkZWVwJyAmJiAodHlwZW9mIG5vZGUudHlwZSA9PT0gJ2Z1bmN0aW9uJyB8fCBub2RlLnR5cGUuJCR0eXBlb2YgPT09IF9yZWFjdElzLkZvcndhcmRSZWYgfHwgbm9kZS50eXBlLiQkdHlwZW9mID09PSBfcmVhY3RJcy5NZW1vKSkge1xuICAgIHJldHVybiBpbnRlcm5hbE5vZGVUb0pzb24obm9kZS5yZW5kZXJlZCwgb3B0aW9ucyk7XG4gIH1cblxuICByZXR1cm4gKDAsIF91dGlscy5hcHBseU1hcCkoe1xuICAgIG5vZGUsXG4gICAgdHlwZTogKDAsIF9EZWJ1Zy50eXBlTmFtZSkobm9kZSksXG4gICAgcHJvcHM6IGdldFByb3BzKG5vZGUsIG9wdGlvbnMpLFxuICAgIGNoaWxkcmVuOiBnZXRDaGlsZHJlbihub2RlLCBvcHRpb25zKSxcbiAgICAkJHR5cGVvZjogU3ltYm9sLmZvcigncmVhY3QudGVzdC5qc29uJylcbiAgfSwgb3B0aW9ucyk7XG59XG5cbmNvbnN0IG1vdW50VG9Kc29uID0gKHdyYXBwZXIsIG9wdGlvbnMgPSB7fSkgPT4ge1xuICBpZiAoKDAsIF9pc05pbC5kZWZhdWx0KSh3cmFwcGVyKSB8fCB3cmFwcGVyLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgaWYgKHdyYXBwZXIubGVuZ3RoID4gMSAmJiB0eXBlb2Ygd3JhcHBlci5nZXROb2Rlc0ludGVybmFsID09PSAnZnVuY3Rpb24nKSB7XG4gICAgY29uc3Qgbm9kZXMgPSB3cmFwcGVyLmdldE5vZGVzSW50ZXJuYWwoKTtcbiAgICByZXR1cm4gbm9kZXMubWFwKG5vZGUgPT4gaW50ZXJuYWxOb2RlVG9Kc29uKG5vZGUsIG9wdGlvbnMpKTtcbiAgfVxuXG4gIGlmICh0eXBlb2Ygd3JhcHBlci5nZXROb2RlSW50ZXJuYWwgPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb25zdCBub2RlID0gd3JhcHBlci5nZXROb2RlSW50ZXJuYWwoKTtcbiAgICByZXR1cm4gaW50ZXJuYWxOb2RlVG9Kc29uKG5vZGUsIG9wdGlvbnMpO1xuICB9XG5cbiAgcmV0dXJuIG51bGw7XG59O1xuXG52YXIgX2RlZmF1bHQgPSBtb3VudFRvSnNvbjtcbmV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0OyJdfQ==