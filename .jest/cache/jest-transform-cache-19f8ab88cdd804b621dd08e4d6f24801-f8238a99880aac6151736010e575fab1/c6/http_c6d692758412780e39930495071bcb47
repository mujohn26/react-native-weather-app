0e6b35923ca36888e8859bc44f4d09ff
'use strict';

var utils = require("./../utils");

var settle = require("./../core/settle");

var buildFullPath = require("../core/buildFullPath");

var buildURL = require("./../helpers/buildURL");

var http = require('http');

var https = require('https');

var httpFollow = require('follow-redirects').http;

var httpsFollow = require('follow-redirects').https;

var url = require('url');

var zlib = require('zlib');

var pkg = require("./../../package.json");

var createError = require("../core/createError");

var enhanceError = require("../core/enhanceError");

var isHttps = /https:?/;

module.exports = function httpAdapter(config) {
  return new Promise(function dispatchHttpRequest(resolvePromise, rejectPromise) {
    var resolve = function resolve(value) {
      resolvePromise(value);
    };

    var reject = function reject(value) {
      rejectPromise(value);
    };

    var data = config.data;
    var headers = config.headers;

    if (!headers['User-Agent'] && !headers['user-agent']) {
      headers['User-Agent'] = 'axios/' + pkg.version;
    }

    if (data && !utils.isStream(data)) {
      if (Buffer.isBuffer(data)) {} else if (utils.isArrayBuffer(data)) {
        data = Buffer.from(new Uint8Array(data));
      } else if (utils.isString(data)) {
        data = Buffer.from(data, 'utf-8');
      } else {
        return reject(createError('Data after transformation must be a string, an ArrayBuffer, a Buffer, or a Stream', config));
      }

      headers['Content-Length'] = data.length;
    }

    var auth = undefined;

    if (config.auth) {
      var username = config.auth.username || '';
      var password = config.auth.password || '';
      auth = username + ':' + password;
    }

    var fullPath = buildFullPath(config.baseURL, config.url);
    var parsed = url.parse(fullPath);
    var protocol = parsed.protocol || 'http:';

    if (!auth && parsed.auth) {
      var urlAuth = parsed.auth.split(':');
      var urlUsername = urlAuth[0] || '';
      var urlPassword = urlAuth[1] || '';
      auth = urlUsername + ':' + urlPassword;
    }

    if (auth) {
      delete headers.Authorization;
    }

    var isHttpsRequest = isHttps.test(protocol);
    var agent = isHttpsRequest ? config.httpsAgent : config.httpAgent;
    var options = {
      path: buildURL(parsed.path, config.params, config.paramsSerializer).replace(/^\?/, ''),
      method: config.method.toUpperCase(),
      headers: headers,
      agent: agent,
      agents: {
        http: config.httpAgent,
        https: config.httpsAgent
      },
      auth: auth
    };

    if (config.socketPath) {
      options.socketPath = config.socketPath;
    } else {
      options.hostname = parsed.hostname;
      options.port = parsed.port;
    }

    var proxy = config.proxy;

    if (!proxy && proxy !== false) {
      var proxyEnv = protocol.slice(0, -1) + '_proxy';
      var proxyUrl = process.env[proxyEnv] || process.env[proxyEnv.toUpperCase()];

      if (proxyUrl) {
        var parsedProxyUrl = url.parse(proxyUrl);
        var noProxyEnv = process.env.no_proxy || process.env.NO_PROXY;
        var shouldProxy = true;

        if (noProxyEnv) {
          var noProxy = noProxyEnv.split(',').map(function trim(s) {
            return s.trim();
          });
          shouldProxy = !noProxy.some(function proxyMatch(proxyElement) {
            if (!proxyElement) {
              return false;
            }

            if (proxyElement === '*') {
              return true;
            }

            if (proxyElement[0] === '.' && parsed.hostname.substr(parsed.hostname.length - proxyElement.length) === proxyElement) {
              return true;
            }

            return parsed.hostname === proxyElement;
          });
        }

        if (shouldProxy) {
          proxy = {
            host: parsedProxyUrl.hostname,
            port: parsedProxyUrl.port
          };

          if (parsedProxyUrl.auth) {
            var proxyUrlAuth = parsedProxyUrl.auth.split(':');
            proxy.auth = {
              username: proxyUrlAuth[0],
              password: proxyUrlAuth[1]
            };
          }
        }
      }
    }

    if (proxy) {
      options.hostname = proxy.host;
      options.host = proxy.host;
      options.headers.host = parsed.hostname + (parsed.port ? ':' + parsed.port : '');
      options.port = proxy.port;
      options.path = protocol + '//' + parsed.hostname + (parsed.port ? ':' + parsed.port : '') + options.path;

      if (proxy.auth) {
        var base64 = Buffer.from(proxy.auth.username + ':' + proxy.auth.password, 'utf8').toString('base64');
        options.headers['Proxy-Authorization'] = 'Basic ' + base64;
      }
    }

    var transport;
    var isHttpsProxy = isHttpsRequest && (proxy ? isHttps.test(proxy.protocol) : true);

    if (config.transport) {
      transport = config.transport;
    } else if (config.maxRedirects === 0) {
      transport = isHttpsProxy ? https : http;
    } else {
      if (config.maxRedirects) {
        options.maxRedirects = config.maxRedirects;
      }

      transport = isHttpsProxy ? httpsFollow : httpFollow;
    }

    if (config.maxBodyLength > -1) {
      options.maxBodyLength = config.maxBodyLength;
    }

    var req = transport.request(options, function handleResponse(res) {
      if (req.aborted) return;
      var stream = res;
      var lastRequest = res.req || req;

      if (res.statusCode !== 204 && lastRequest.method !== 'HEAD' && config.decompress !== false) {
        switch (res.headers['content-encoding']) {
          case 'gzip':
          case 'compress':
          case 'deflate':
            stream = stream.pipe(zlib.createUnzip());
            delete res.headers['content-encoding'];
            break;
        }
      }

      var response = {
        status: res.statusCode,
        statusText: res.statusMessage,
        headers: res.headers,
        config: config,
        request: lastRequest
      };

      if (config.responseType === 'stream') {
        response.data = stream;
        settle(resolve, reject, response);
      } else {
        var responseBuffer = [];
        stream.on('data', function handleStreamData(chunk) {
          responseBuffer.push(chunk);

          if (config.maxContentLength > -1 && Buffer.concat(responseBuffer).length > config.maxContentLength) {
            stream.destroy();
            reject(createError('maxContentLength size of ' + config.maxContentLength + ' exceeded', config, null, lastRequest));
          }
        });
        stream.on('error', function handleStreamError(err) {
          if (req.aborted) return;
          reject(enhanceError(err, config, null, lastRequest));
        });
        stream.on('end', function handleStreamEnd() {
          var responseData = Buffer.concat(responseBuffer);

          if (config.responseType !== 'arraybuffer') {
            responseData = responseData.toString(config.responseEncoding);

            if (!config.responseEncoding || config.responseEncoding === 'utf8') {
              responseData = utils.stripBOM(responseData);
            }
          }

          response.data = responseData;
          settle(resolve, reject, response);
        });
      }
    });
    req.on('error', function handleRequestError(err) {
      if (req.aborted && err.code !== 'ERR_FR_TOO_MANY_REDIRECTS') return;
      reject(enhanceError(err, config, null, req));
    });

    if (config.timeout) {
      req.setTimeout(config.timeout, function handleRequestTimeout() {
        req.abort();
        reject(createError('timeout of ' + config.timeout + 'ms exceeded', config, 'ECONNABORTED', req));
      });
    }

    if (config.cancelToken) {
      config.cancelToken.promise.then(function onCanceled(cancel) {
        if (req.aborted) return;
        req.abort();
        reject(cancel);
      });
    }

    if (utils.isStream(data)) {
      data.on('error', function handleStreamError(err) {
        reject(enhanceError(err, config, null, req));
      }).pipe(req);
    } else {
      req.end(data);
    }
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHAuanMiXSwibmFtZXMiOlsidXRpbHMiLCJyZXF1aXJlIiwic2V0dGxlIiwiYnVpbGRGdWxsUGF0aCIsImJ1aWxkVVJMIiwiaHR0cCIsImh0dHBzIiwiaHR0cEZvbGxvdyIsImh0dHBzRm9sbG93IiwidXJsIiwiemxpYiIsInBrZyIsImNyZWF0ZUVycm9yIiwiZW5oYW5jZUVycm9yIiwiaXNIdHRwcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJodHRwQWRhcHRlciIsImNvbmZpZyIsIlByb21pc2UiLCJkaXNwYXRjaEh0dHBSZXF1ZXN0IiwicmVzb2x2ZVByb21pc2UiLCJyZWplY3RQcm9taXNlIiwicmVzb2x2ZSIsInZhbHVlIiwicmVqZWN0IiwiZGF0YSIsImhlYWRlcnMiLCJ2ZXJzaW9uIiwiaXNTdHJlYW0iLCJCdWZmZXIiLCJpc0J1ZmZlciIsImlzQXJyYXlCdWZmZXIiLCJmcm9tIiwiVWludDhBcnJheSIsImlzU3RyaW5nIiwibGVuZ3RoIiwiYXV0aCIsInVuZGVmaW5lZCIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJmdWxsUGF0aCIsImJhc2VVUkwiLCJwYXJzZWQiLCJwYXJzZSIsInByb3RvY29sIiwidXJsQXV0aCIsInNwbGl0IiwidXJsVXNlcm5hbWUiLCJ1cmxQYXNzd29yZCIsIkF1dGhvcml6YXRpb24iLCJpc0h0dHBzUmVxdWVzdCIsInRlc3QiLCJhZ2VudCIsImh0dHBzQWdlbnQiLCJodHRwQWdlbnQiLCJvcHRpb25zIiwicGF0aCIsInBhcmFtcyIsInBhcmFtc1NlcmlhbGl6ZXIiLCJyZXBsYWNlIiwibWV0aG9kIiwidG9VcHBlckNhc2UiLCJhZ2VudHMiLCJzb2NrZXRQYXRoIiwiaG9zdG5hbWUiLCJwb3J0IiwicHJveHkiLCJwcm94eUVudiIsInNsaWNlIiwicHJveHlVcmwiLCJwcm9jZXNzIiwiZW52IiwicGFyc2VkUHJveHlVcmwiLCJub1Byb3h5RW52Iiwibm9fcHJveHkiLCJOT19QUk9YWSIsInNob3VsZFByb3h5Iiwibm9Qcm94eSIsIm1hcCIsInRyaW0iLCJzIiwic29tZSIsInByb3h5TWF0Y2giLCJwcm94eUVsZW1lbnQiLCJzdWJzdHIiLCJob3N0IiwicHJveHlVcmxBdXRoIiwiYmFzZTY0IiwidG9TdHJpbmciLCJ0cmFuc3BvcnQiLCJpc0h0dHBzUHJveHkiLCJtYXhSZWRpcmVjdHMiLCJtYXhCb2R5TGVuZ3RoIiwicmVxIiwicmVxdWVzdCIsImhhbmRsZVJlc3BvbnNlIiwicmVzIiwiYWJvcnRlZCIsInN0cmVhbSIsImxhc3RSZXF1ZXN0Iiwic3RhdHVzQ29kZSIsImRlY29tcHJlc3MiLCJwaXBlIiwiY3JlYXRlVW56aXAiLCJyZXNwb25zZSIsInN0YXR1cyIsInN0YXR1c1RleHQiLCJzdGF0dXNNZXNzYWdlIiwicmVzcG9uc2VUeXBlIiwicmVzcG9uc2VCdWZmZXIiLCJvbiIsImhhbmRsZVN0cmVhbURhdGEiLCJjaHVuayIsInB1c2giLCJtYXhDb250ZW50TGVuZ3RoIiwiY29uY2F0IiwiZGVzdHJveSIsImhhbmRsZVN0cmVhbUVycm9yIiwiZXJyIiwiaGFuZGxlU3RyZWFtRW5kIiwicmVzcG9uc2VEYXRhIiwicmVzcG9uc2VFbmNvZGluZyIsInN0cmlwQk9NIiwiaGFuZGxlUmVxdWVzdEVycm9yIiwiY29kZSIsInRpbWVvdXQiLCJzZXRUaW1lb3V0IiwiaGFuZGxlUmVxdWVzdFRpbWVvdXQiLCJhYm9ydCIsImNhbmNlbFRva2VuIiwicHJvbWlzZSIsInRoZW4iLCJvbkNhbmNlbGVkIiwiY2FuY2VsIiwiZW5kIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFJQSxLQUFLLEdBQUdDLE9BQU8sY0FBbkI7O0FBQ0EsSUFBSUMsTUFBTSxHQUFHRCxPQUFPLG9CQUFwQjs7QUFDQSxJQUFJRSxhQUFhLEdBQUdGLE9BQU8seUJBQTNCOztBQUNBLElBQUlHLFFBQVEsR0FBR0gsT0FBTyx5QkFBdEI7O0FBQ0EsSUFBSUksSUFBSSxHQUFHSixPQUFPLENBQUMsTUFBRCxDQUFsQjs7QUFDQSxJQUFJSyxLQUFLLEdBQUdMLE9BQU8s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QXpRTSxDQUFQO0FBMFFELENBM1FEIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgdXRpbHMgPSByZXF1aXJlKCcuLy4uL3V0aWxzJyk7XG52YXIgc2V0dGxlID0gcmVxdWlyZSgnLi8uLi9jb3JlL3NldHRsZScpO1xudmFyIGJ1aWxkRnVsbFBhdGggPSByZXF1aXJlKCcuLi9jb3JlL2J1aWxkRnVsbFBhdGgnKTtcbnZhciBidWlsZFVSTCA9IHJlcXVpcmUoJy4vLi4vaGVscGVycy9idWlsZFVSTCcpO1xudmFyIGh0dHAgPSByZXF1aXJlKCdodHRwJyk7XG52YXIgaHR0cHMgPSByZXF1aXJlKCdodHRwcycpO1xudmFyIGh0dHBGb2xsb3cgPSByZXF1aXJlKCdmb2xsb3ctcmVkaXJlY3RzJykuaHR0cDtcbnZhciBodHRwc0ZvbGxvdyA9IHJlcXVpcmUoJ2ZvbGxvdy1yZWRpcmVjdHMnKS5odHRwcztcbnZhciB1cmwgPSByZXF1aXJlKCd1cmwnKTtcbnZhciB6bGliID0gcmVxdWlyZSgnemxpYicpO1xudmFyIHBrZyA9IHJlcXVpcmUoJy4vLi4vLi4vcGFja2FnZS5qc29uJyk7XG52YXIgY3JlYXRlRXJyb3IgPSByZXF1aXJlKCcuLi9jb3JlL2NyZWF0ZUVycm9yJyk7XG52YXIgZW5oYW5jZUVycm9yID0gcmVxdWlyZSgnLi4vY29yZS9lbmhhbmNlRXJyb3InKTtcblxudmFyIGlzSHR0cHMgPSAvaHR0cHM6Py87XG5cbi8qZXNsaW50IGNvbnNpc3RlbnQtcmV0dXJuOjAqL1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBodHRwQWRhcHRlcihjb25maWcpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIGRpc3BhdGNoSHR0cFJlcXVlc3QocmVzb2x2ZVByb21pc2UsIHJlamVjdFByb21pc2UpIHtcbiAgICB2YXIgcmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUodmFsdWUpIHtcbiAgICAgIHJlc29sdmVQcm9taXNlKHZhbHVlKTtcbiAgICB9O1xuICAgIHZhciByZWplY3QgPSBmdW5jdGlvbiByZWplY3QodmFsdWUpIHtcbiAgICAgIHJlamVjdFByb21pc2UodmFsdWUpO1xuICAgIH07XG4gICAgdmFyIGRhdGEgPSBjb25maWcuZGF0YTtcbiAgICB2YXIgaGVhZGVycyA9IGNvbmZpZy5oZWFkZXJzO1xuXG4gICAgLy8gU2V0IFVzZXItQWdlbnQgKHJlcXVpcmVkIGJ5IHNvbWUgc2VydmVycylcbiAgICAvLyBPbmx5IHNldCBoZWFkZXIgaWYgaXQgaGFzbid0IGJlZW4gc2V0IGluIGNvbmZpZ1xuICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYXhpb3MvYXhpb3MvaXNzdWVzLzY5XG4gICAgaWYgKCFoZWFkZXJzWydVc2VyLUFnZW50J10gJiYgIWhlYWRlcnNbJ3VzZXItYWdlbnQnXSkge1xuICAgICAgaGVhZGVyc1snVXNlci1BZ2VudCddID0gJ2F4aW9zLycgKyBwa2cudmVyc2lvbjtcbiAgICB9XG5cbiAgICBpZiAoZGF0YSAmJiAhdXRpbHMuaXNTdHJlYW0oZGF0YSkpIHtcbiAgICAgIGlmIChCdWZmZXIuaXNCdWZmZXIoZGF0YSkpIHtcbiAgICAgICAgLy8gTm90aGluZyB0byBkby4uLlxuICAgICAgfSBlbHNlIGlmICh1dGlscy5pc0FycmF5QnVmZmVyKGRhdGEpKSB7XG4gICAgICAgIGRhdGEgPSBCdWZmZXIuZnJvbShuZXcgVWludDhBcnJheShkYXRhKSk7XG4gICAgICB9IGVsc2UgaWYgKHV0aWxzLmlzU3RyaW5nKGRhdGEpKSB7XG4gICAgICAgIGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCAndXRmLTgnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZWplY3QoY3JlYXRlRXJyb3IoXG4gICAgICAgICAgJ0RhdGEgYWZ0ZXIgdHJhbnNmb3JtYXRpb24gbXVzdCBiZSBhIHN0cmluZywgYW4gQXJyYXlCdWZmZXIsIGEgQnVmZmVyLCBvciBhIFN0cmVhbScsXG4gICAgICAgICAgY29uZmlnXG4gICAgICAgICkpO1xuICAgICAgfVxuXG4gICAgICAvLyBBZGQgQ29udGVudC1MZW5ndGggaGVhZGVyIGlmIGRhdGEgZXhpc3RzXG4gICAgICBoZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gZGF0YS5sZW5ndGg7XG4gICAgfVxuXG4gICAgLy8gSFRUUCBiYXNpYyBhdXRoZW50aWNhdGlvblxuICAgIHZhciBhdXRoID0gdW5kZWZpbmVkO1xuICAgIGlmIChjb25maWcuYXV0aCkge1xuICAgICAgdmFyIHVzZXJuYW1lID0gY29uZmlnLmF1dGgudXNlcm5hbWUgfHwgJyc7XG4gICAgICB2YXIgcGFzc3dvcmQgPSBjb25maWcuYXV0aC5wYXNzd29yZCB8fCAnJztcbiAgICAgIGF1dGggPSB1c2VybmFtZSArICc6JyArIHBhc3N3b3JkO1xuICAgIH1cblxuICAgIC8vIFBhcnNlIHVybFxuICAgIHZhciBmdWxsUGF0aCA9IGJ1aWxkRnVsbFBhdGgoY29uZmlnLmJhc2VVUkwsIGNvbmZpZy51cmwpO1xuICAgIHZhciBwYXJzZWQgPSB1cmwucGFyc2UoZnVsbFBhdGgpO1xuICAgIHZhciBwcm90b2NvbCA9IHBhcnNlZC5wcm90b2NvbCB8fCAnaHR0cDonO1xuXG4gICAgaWYgKCFhdXRoICYmIHBhcnNlZC5hdXRoKSB7XG4gICAgICB2YXIgdXJsQXV0aCA9IHBhcnNlZC5hdXRoLnNwbGl0KCc6Jyk7XG4gICAgICB2YXIgdXJsVXNlcm5hbWUgPSB1cmxBdXRoWzBdIHx8ICcnO1xuICAgICAgdmFyIHVybFBhc3N3b3JkID0gdXJsQXV0aFsxXSB8fCAnJztcbiAgICAgIGF1dGggPSB1cmxVc2VybmFtZSArICc6JyArIHVybFBhc3N3b3JkO1xuICAgIH1cblxuICAgIGlmIChhdXRoKSB7XG4gICAgICBkZWxldGUgaGVhZGVycy5BdXRob3JpemF0aW9uO1xuICAgIH1cblxuICAgIHZhciBpc0h0dHBzUmVxdWVzdCA9IGlzSHR0cHMudGVzdChwcm90b2NvbCk7XG4gICAgdmFyIGFnZW50ID0gaXNIdHRwc1JlcXVlc3QgPyBjb25maWcuaHR0cHNBZ2VudCA6IGNvbmZpZy5odHRwQWdlbnQ7XG5cbiAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgIHBhdGg6IGJ1aWxkVVJMKHBhcnNlZC5wYXRoLCBjb25maWcucGFyYW1zLCBjb25maWcucGFyYW1zU2VyaWFsaXplcikucmVwbGFjZSgvXlxcPy8sICcnKSxcbiAgICAgIG1ldGhvZDogY29uZmlnLm1ldGhvZC50b1VwcGVyQ2FzZSgpLFxuICAgICAgaGVhZGVyczogaGVhZGVycyxcbiAgICAgIGFnZW50OiBhZ2VudCxcbiAgICAgIGFnZW50czogeyBodHRwOiBjb25maWcuaHR0cEFnZW50LCBodHRwczogY29uZmlnLmh0dHBzQWdlbnQgfSxcbiAgICAgIGF1dGg6IGF1dGhcbiAgICB9O1xuXG4gICAgaWYgKGNvbmZpZy5zb2NrZXRQYXRoKSB7XG4gICAgICBvcHRpb25zLnNvY2tldFBhdGggPSBjb25maWcuc29ja2V0UGF0aDtcbiAgICB9IGVsc2Uge1xuICAgICAgb3B0aW9ucy5ob3N0bmFtZSA9IHBhcnNlZC5ob3N0bmFtZTtcbiAgICAgIG9wdGlvbnMucG9ydCA9IHBhcnNlZC5wb3J0O1xuICAgIH1cblxuICAgIHZhciBwcm94eSA9IGNvbmZpZy5wcm94eTtcbiAgICBpZiAoIXByb3h5ICYmIHByb3h5ICE9PSBmYWxzZSkge1xuICAgICAgdmFyIHByb3h5RW52ID0gcHJvdG9jb2wuc2xpY2UoMCwgLTEpICsgJ19wcm94eSc7XG4gICAgICB2YXIgcHJveHlVcmwgPSBwcm9jZXNzLmVudltwcm94eUVudl0gfHwgcHJvY2Vzcy5lbnZbcHJveHlFbnYudG9VcHBlckNhc2UoKV07XG4gICAgICBpZiAocHJveHlVcmwpIHtcbiAgICAgICAgdmFyIHBhcnNlZFByb3h5VXJsID0gdXJsLnBhcnNlKHByb3h5VXJsKTtcbiAgICAgICAgdmFyIG5vUHJveHlFbnYgPSBwcm9jZXNzLmVudi5ub19wcm94eSB8fCBwcm9jZXNzLmVudi5OT19QUk9YWTtcbiAgICAgICAgdmFyIHNob3VsZFByb3h5ID0gdHJ1ZTtcblxuICAgICAgICBpZiAobm9Qcm94eUVudikge1xuICAgICAgICAgIHZhciBub1Byb3h5ID0gbm9Qcm94eUVudi5zcGxpdCgnLCcpLm1hcChmdW5jdGlvbiB0cmltKHMpIHtcbiAgICAgICAgICAgIHJldHVybiBzLnRyaW0oKTtcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHNob3VsZFByb3h5ID0gIW5vUHJveHkuc29tZShmdW5jdGlvbiBwcm94eU1hdGNoKHByb3h5RWxlbWVudCkge1xuICAgICAgICAgICAgaWYgKCFwcm94eUVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHByb3h5RWxlbWVudCA9PT0gJyonKSB7XG4gICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHByb3h5RWxlbWVudFswXSA9PT0gJy4nICYmXG4gICAgICAgICAgICAgICAgcGFyc2VkLmhvc3RuYW1lLnN1YnN0cihwYXJzZWQuaG9zdG5hbWUubGVuZ3RoIC0gcHJveHlFbGVtZW50Lmxlbmd0aCkgPT09IHByb3h5RWxlbWVudCkge1xuICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHBhcnNlZC5ob3N0bmFtZSA9PT0gcHJveHlFbGVtZW50O1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cblxuICAgICAgICBpZiAoc2hvdWxkUHJveHkpIHtcbiAgICAgICAgICBwcm94eSA9IHtcbiAgICAgICAgICAgIGhvc3Q6IHBhcnNlZFByb3h5VXJsLmhvc3RuYW1lLFxuICAgICAgICAgICAgcG9ydDogcGFyc2VkUHJveHlVcmwucG9ydFxuICAgICAgICAgIH07XG5cbiAgICAgICAgICBpZiAocGFyc2VkUHJveHlVcmwuYXV0aCkge1xuICAgICAgICAgICAgdmFyIHByb3h5VXJsQXV0aCA9IHBhcnNlZFByb3h5VXJsLmF1dGguc3BsaXQoJzonKTtcbiAgICAgICAgICAgIHByb3h5LmF1dGggPSB7XG4gICAgICAgICAgICAgIHVzZXJuYW1lOiBwcm94eVVybEF1dGhbMF0sXG4gICAgICAgICAgICAgIHBhc3N3b3JkOiBwcm94eVVybEF1dGhbMV1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHByb3h5KSB7XG4gICAgICBvcHRpb25zLmhvc3RuYW1lID0gcHJveHkuaG9zdDtcbiAgICAgIG9wdGlvbnMuaG9zdCA9IHByb3h5Lmhvc3Q7XG4gICAgICBvcHRpb25zLmhlYWRlcnMuaG9zdCA9IHBhcnNlZC5ob3N0bmFtZSArIChwYXJzZWQucG9ydCA/ICc6JyArIHBhcnNlZC5wb3J0IDogJycpO1xuICAgICAgb3B0aW9ucy5wb3J0ID0gcHJveHkucG9ydDtcbiAgICAgIG9wdGlvbnMucGF0aCA9IHByb3RvY29sICsgJy8vJyArIHBhcnNlZC5ob3N0bmFtZSArIChwYXJzZWQucG9ydCA/ICc6JyArIHBhcnNlZC5wb3J0IDogJycpICsgb3B0aW9ucy5wYXRoO1xuXG4gICAgICAvLyBCYXNpYyBwcm94eSBhdXRob3JpemF0aW9uXG4gICAgICBpZiAocHJveHkuYXV0aCkge1xuICAgICAgICB2YXIgYmFzZTY0ID0gQnVmZmVyLmZyb20ocHJveHkuYXV0aC51c2VybmFtZSArICc6JyArIHByb3h5LmF1dGgucGFzc3dvcmQsICd1dGY4JykudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgICAgICBvcHRpb25zLmhlYWRlcnNbJ1Byb3h5LUF1dGhvcml6YXRpb24nXSA9ICdCYXNpYyAnICsgYmFzZTY0O1xuICAgICAgfVxuICAgIH1cblxuICAgIHZhciB0cmFuc3BvcnQ7XG4gICAgdmFyIGlzSHR0cHNQcm94eSA9IGlzSHR0cHNSZXF1ZXN0ICYmIChwcm94eSA/IGlzSHR0cHMudGVzdChwcm94eS5wcm90b2NvbCkgOiB0cnVlKTtcbiAgICBpZiAoY29uZmlnLnRyYW5zcG9ydCkge1xuICAgICAgdHJhbnNwb3J0ID0gY29uZmlnLnRyYW5zcG9ydDtcbiAgICB9IGVsc2UgaWYgKGNvbmZpZy5tYXhSZWRpcmVjdHMgPT09IDApIHtcbiAgICAgIHRyYW5zcG9ydCA9IGlzSHR0cHNQcm94eSA/IGh0dHBzIDogaHR0cDtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGNvbmZpZy5tYXhSZWRpcmVjdHMpIHtcbiAgICAgICAgb3B0aW9ucy5tYXhSZWRpcmVjdHMgPSBjb25maWcubWF4UmVkaXJlY3RzO1xuICAgICAgfVxuICAgICAgdHJhbnNwb3J0ID0gaXNIdHRwc1Byb3h5ID8gaHR0cHNGb2xsb3cgOiBodHRwRm9sbG93O1xuICAgIH1cblxuICAgIGlmIChjb25maWcubWF4Qm9keUxlbmd0aCA+IC0xKSB7XG4gICAgICBvcHRpb25zLm1heEJvZHlMZW5ndGggPSBjb25maWcubWF4Qm9keUxlbmd0aDtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgdGhlIHJlcXVlc3RcbiAgICB2YXIgcmVxID0gdHJhbnNwb3J0LnJlcXVlc3Qob3B0aW9ucywgZnVuY3Rpb24gaGFuZGxlUmVzcG9uc2UocmVzKSB7XG4gICAgICBpZiAocmVxLmFib3J0ZWQpIHJldHVybjtcblxuICAgICAgLy8gdW5jb21wcmVzcyB0aGUgcmVzcG9uc2UgYm9keSB0cmFuc3BhcmVudGx5IGlmIHJlcXVpcmVkXG4gICAgICB2YXIgc3RyZWFtID0gcmVzO1xuXG4gICAgICAvLyByZXR1cm4gdGhlIGxhc3QgcmVxdWVzdCBpbiBjYXNlIG9mIHJlZGlyZWN0c1xuICAgICAgdmFyIGxhc3RSZXF1ZXN0ID0gcmVzLnJlcSB8fCByZXE7XG5cblxuICAgICAgLy8gaWYgbm8gY29udGVudCwgaXMgSEVBRCByZXF1ZXN0IG9yIGRlY29tcHJlc3MgZGlzYWJsZWQgd2Ugc2hvdWxkIG5vdCBkZWNvbXByZXNzXG4gICAgICBpZiAocmVzLnN0YXR1c0NvZGUgIT09IDIwNCAmJiBsYXN0UmVxdWVzdC5tZXRob2QgIT09ICdIRUFEJyAmJiBjb25maWcuZGVjb21wcmVzcyAhPT0gZmFsc2UpIHtcbiAgICAgICAgc3dpdGNoIChyZXMuaGVhZGVyc1snY29udGVudC1lbmNvZGluZyddKSB7XG4gICAgICAgIC8qZXNsaW50IGRlZmF1bHQtY2FzZTowKi9cbiAgICAgICAgY2FzZSAnZ3ppcCc6XG4gICAgICAgIGNhc2UgJ2NvbXByZXNzJzpcbiAgICAgICAgY2FzZSAnZGVmbGF0ZSc6XG4gICAgICAgIC8vIGFkZCB0aGUgdW56aXBwZXIgdG8gdGhlIGJvZHkgc3RyZWFtIHByb2Nlc3NpbmcgcGlwZWxpbmVcbiAgICAgICAgICBzdHJlYW0gPSBzdHJlYW0ucGlwZSh6bGliLmNyZWF0ZVVuemlwKCkpO1xuXG4gICAgICAgICAgLy8gcmVtb3ZlIHRoZSBjb250ZW50LWVuY29kaW5nIGluIG9yZGVyIHRvIG5vdCBjb25mdXNlIGRvd25zdHJlYW0gb3BlcmF0aW9uc1xuICAgICAgICAgIGRlbGV0ZSByZXMuaGVhZGVyc1snY29udGVudC1lbmNvZGluZyddO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHZhciByZXNwb25zZSA9IHtcbiAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzQ29kZSxcbiAgICAgICAgc3RhdHVzVGV4dDogcmVzLnN0YXR1c01lc3NhZ2UsXG4gICAgICAgIGhlYWRlcnM6IHJlcy5oZWFkZXJzLFxuICAgICAgICBjb25maWc6IGNvbmZpZyxcbiAgICAgICAgcmVxdWVzdDogbGFzdFJlcXVlc3RcbiAgICAgIH07XG5cbiAgICAgIGlmIChjb25maWcucmVzcG9uc2VUeXBlID09PSAnc3RyZWFtJykge1xuICAgICAgICByZXNwb25zZS5kYXRhID0gc3RyZWFtO1xuICAgICAgICBzZXR0bGUocmVzb2x2ZSwgcmVqZWN0LCByZXNwb25zZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgcmVzcG9uc2VCdWZmZXIgPSBbXTtcbiAgICAgICAgc3RyZWFtLm9uKCdkYXRhJywgZnVuY3Rpb24gaGFuZGxlU3RyZWFtRGF0YShjaHVuaykge1xuICAgICAgICAgIHJlc3BvbnNlQnVmZmVyLnB1c2goY2h1bmspO1xuXG4gICAgICAgICAgLy8gbWFrZSBzdXJlIHRoZSBjb250ZW50IGxlbmd0aCBpcyBub3Qgb3ZlciB0aGUgbWF4Q29udGVudExlbmd0aCBpZiBzcGVjaWZpZWRcbiAgICAgICAgICBpZiAoY29uZmlnLm1heENvbnRlbnRMZW5ndGggPiAtMSAmJiBCdWZmZXIuY29uY2F0KHJlc3BvbnNlQnVmZmVyKS5sZW5ndGggPiBjb25maWcubWF4Q29udGVudExlbmd0aCkge1xuICAgICAgICAgICAgc3RyZWFtLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIHJlamVjdChjcmVhdGVFcnJvcignbWF4Q29udGVudExlbmd0aCBzaXplIG9mICcgKyBjb25maWcubWF4Q29udGVudExlbmd0aCArICcgZXhjZWVkZWQnLFxuICAgICAgICAgICAgICBjb25maWcsIG51bGwsIGxhc3RSZXF1ZXN0KSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgZnVuY3Rpb24gaGFuZGxlU3RyZWFtRXJyb3IoZXJyKSB7XG4gICAgICAgICAgaWYgKHJlcS5hYm9ydGVkKSByZXR1cm47XG4gICAgICAgICAgcmVqZWN0KGVuaGFuY2VFcnJvcihlcnIsIGNvbmZpZywgbnVsbCwgbGFzdFJlcXVlc3QpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgc3RyZWFtLm9uKCdlbmQnLCBmdW5jdGlvbiBoYW5kbGVTdHJlYW1FbmQoKSB7XG4gICAgICAgICAgdmFyIHJlc3BvbnNlRGF0YSA9IEJ1ZmZlci5jb25jYXQocmVzcG9uc2VCdWZmZXIpO1xuICAgICAgICAgIGlmIChjb25maWcucmVzcG9uc2VUeXBlICE9PSAnYXJyYXlidWZmZXInKSB7XG4gICAgICAgICAgICByZXNwb25zZURhdGEgPSByZXNwb25zZURhdGEudG9TdHJpbmcoY29uZmlnLnJlc3BvbnNlRW5jb2RpbmcpO1xuICAgICAgICAgICAgaWYgKCFjb25maWcucmVzcG9uc2VFbmNvZGluZyB8fCBjb25maWcucmVzcG9uc2VFbmNvZGluZyA9PT0gJ3V0ZjgnKSB7XG4gICAgICAgICAgICAgIHJlc3BvbnNlRGF0YSA9IHV0aWxzLnN0cmlwQk9NKHJlc3BvbnNlRGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmVzcG9uc2UuZGF0YSA9IHJlc3BvbnNlRGF0YTtcbiAgICAgICAgICBzZXR0bGUocmVzb2x2ZSwgcmVqZWN0LCByZXNwb25zZSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gSGFuZGxlIGVycm9yc1xuICAgIHJlcS5vbignZXJyb3InLCBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0RXJyb3IoZXJyKSB7XG4gICAgICBpZiAocmVxLmFib3J0ZWQgJiYgZXJyLmNvZGUgIT09ICdFUlJfRlJfVE9PX01BTllfUkVESVJFQ1RTJykgcmV0dXJuO1xuICAgICAgcmVqZWN0KGVuaGFuY2VFcnJvcihlcnIsIGNvbmZpZywgbnVsbCwgcmVxKSk7XG4gICAgfSk7XG5cbiAgICAvLyBIYW5kbGUgcmVxdWVzdCB0aW1lb3V0XG4gICAgaWYgKGNvbmZpZy50aW1lb3V0KSB7XG4gICAgICAvLyBTb21ldGltZSwgdGhlIHJlc3BvbnNlIHdpbGwgYmUgdmVyeSBzbG93LCBhbmQgZG9lcyBub3QgcmVzcG9uZCwgdGhlIGNvbm5lY3QgZXZlbnQgd2lsbCBiZSBibG9jayBieSBldmVudCBsb29wIHN5c3RlbS5cbiAgICAgIC8vIEFuZCB0aW1lciBjYWxsYmFjayB3aWxsIGJlIGZpcmVkLCBhbmQgYWJvcnQoKSB3aWxsIGJlIGludm9rZWQgYmVmb3JlIGNvbm5lY3Rpb24sIHRoZW4gZ2V0IFwic29ja2V0IGhhbmcgdXBcIiBhbmQgY29kZSBFQ09OTlJFU0VULlxuICAgICAgLy8gQXQgdGhpcyB0aW1lLCBpZiB3ZSBoYXZlIGEgbGFyZ2UgbnVtYmVyIG9mIHJlcXVlc3QsIG5vZGVqcyB3aWxsIGhhbmcgdXAgc29tZSBzb2NrZXQgb24gYmFja2dyb3VuZC4gYW5kIHRoZSBudW1iZXIgd2lsbCB1cCBhbmQgdXAuXG4gICAgICAvLyBBbmQgdGhlbiB0aGVzZSBzb2NrZXQgd2hpY2ggYmUgaGFuZyB1cCB3aWxsIGRldm9yaW5nIENQVSBsaXR0bGUgYnkgbGl0dGxlLlxuICAgICAgLy8gQ2xpZW50UmVxdWVzdC5zZXRUaW1lb3V0IHdpbGwgYmUgZmlyZWQgb24gdGhlIHNwZWNpZnkgbWlsbGlzZWNvbmRzLCBhbmQgY2FuIG1ha2Ugc3VyZSB0aGF0IGFib3J0KCkgd2lsbCBiZSBmaXJlZCBhZnRlciBjb25uZWN0LlxuICAgICAgcmVxLnNldFRpbWVvdXQoY29uZmlnLnRpbWVvdXQsIGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3RUaW1lb3V0KCkge1xuICAgICAgICByZXEuYWJvcnQoKTtcbiAgICAgICAgcmVqZWN0KGNyZWF0ZUVycm9yKCd0aW1lb3V0IG9mICcgKyBjb25maWcudGltZW91dCArICdtcyBleGNlZWRlZCcsIGNvbmZpZywgJ0VDT05OQUJPUlRFRCcsIHJlcSkpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy5jYW5jZWxUb2tlbikge1xuICAgICAgLy8gSGFuZGxlIGNhbmNlbGxhdGlvblxuICAgICAgY29uZmlnLmNhbmNlbFRva2VuLnByb21pc2UudGhlbihmdW5jdGlvbiBvbkNhbmNlbGVkKGNhbmNlbCkge1xuICAgICAgICBpZiAocmVxLmFib3J0ZWQpIHJldHVybjtcblxuICAgICAgICByZXEuYWJvcnQoKTtcbiAgICAgICAgcmVqZWN0KGNhbmNlbCk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBTZW5kIHRoZSByZXF1ZXN0XG4gICAgaWYgKHV0aWxzLmlzU3RyZWFtKGRhdGEpKSB7XG4gICAgICBkYXRhLm9uKCdlcnJvcicsIGZ1bmN0aW9uIGhhbmRsZVN0cmVhbUVycm9yKGVycikge1xuICAgICAgICByZWplY3QoZW5oYW5jZUVycm9yKGVyciwgY29uZmlnLCBudWxsLCByZXEpKTtcbiAgICAgIH0pLnBpcGUocmVxKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVxLmVuZChkYXRhKTtcbiAgICB9XG4gIH0pO1xufTtcbiJdfQ==