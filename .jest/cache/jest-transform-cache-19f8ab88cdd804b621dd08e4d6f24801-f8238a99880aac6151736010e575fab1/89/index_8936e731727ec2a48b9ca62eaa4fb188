158f8dbc0dbbb21d2205a800fb555ac6
'use strict';

var TransformStream = require('stream').Transform,
    DevNullStream = require("./dev_null_stream"),
    inherits = require('util').inherits,
    Tokenizer = require("../tokenizer"),
    LocationInfoTokenizerMixin = require("../extensions/location_info/tokenizer_mixin"),
    ParserFeedbackSimulator = require("./parser_feedback_simulator"),
    mergeOptions = require("../utils/merge_options");

var DEFAULT_OPTIONS = {
  locationInfo: false
};

var SAXParser = module.exports = function (options) {
  TransformStream.call(this);
  this.options = mergeOptions(DEFAULT_OPTIONS, options);
  this.tokenizer = new Tokenizer(options);
  if (this.options.locationInfo) new LocationInfoTokenizerMixin(this.tokenizer);
  this.parserFeedbackSimulator = new ParserFeedbackSimulator(this.tokenizer);
  this.pendingText = null;
  this.currentTokenLocation = void 0;
  this.lastChunkWritten = false;
  this.stopped = false;
  this.pipe(new DevNullStream());
};

inherits(SAXParser, TransformStream);

SAXParser.prototype._transform = function (chunk, encoding, callback) {
  if (!this.stopped) {
    this.tokenizer.write(chunk.toString('utf8'), this.lastChunkWritten);

    this._runParsingLoop();
  }

  this.push(chunk);
  callback();
};

SAXParser.prototype._flush = function (callback) {
  callback();
};

SAXParser.prototype.end = function (chunk, encoding, callback) {
  this.lastChunkWritten = true;
  TransformStream.prototype.end.call(this, chunk, encoding, callback);
};

SAXParser.prototype.stop = function () {
  this.stopped = true;
};

SAXParser.prototype._runParsingLoop = function () {
  do {
    var token = this.parserFeedbackSimulator.getNextToken();
    if (token.type === Tokenizer.HIBERNATION_TOKEN) break;

    if (token.type === Tokenizer.CHARACTER_TOKEN || token.type === Tokenizer.WHITESPACE_CHARACTER_TOKEN || token.type === Tokenizer.NULL_CHARACTER_TOKEN) {
      if (this.options.locationInfo) {
        if (this.pendingText === null) this.currentTokenLocation = token.location;else this.currentTokenLocation.endOffset = token.location.endOffset;
      }

      this.pendingText = (this.pendingText || '') + token.chars;
    } else {
      this._emitPendingText();

      this._handleToken(token);
    }
  } while (!this.stopped && token.type !== Tokenizer.EOF_TOKEN);
};

SAXParser.prototype._handleToken = function (token) {
  if (this.options.locationInfo) this.currentTokenLocation = token.location;
  if (token.type === Tokenizer.START_TAG_TOKEN) this.emit('startTag', token.tagName, token.attrs, token.selfClosing, this.currentTokenLocation);else if (token.type === Tokenizer.END_TAG_TOKEN) this.emit('endTag', token.tagName, this.currentTokenLocation);else if (token.type === Tokenizer.COMMENT_TOKEN) this.emit('comment', token.data, this.currentTokenLocation);else if (token.type === Tokenizer.DOCTYPE_TOKEN) this.emit('doctype', token.name, token.publicId, token.systemId, this.currentTokenLocation);
};

SAXParser.prototype._emitPendingText = function () {
  if (this.pendingText !== null) {
    this.emit('text', this.pendingText, this.currentTokenLocation);
    this.pendingText = null;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIlRyYW5zZm9ybVN0cmVhbSIsInJlcXVpcmUiLCJUcmFuc2Zvcm0iLCJEZXZOdWxsU3RyZWFtIiwiaW5oZXJpdHMiLCJUb2tlbml6ZXIiLCJMb2NhdGlvbkluZm9Ub2tlbml6ZXJNaXhpbiIsIlBhcnNlckZlZWRiYWNrU2ltdWxhdG9yIiwibWVyZ2VPcHRpb25zIiwiREVGQVVMVF9PUFRJT05TIiwibG9jYXRpb25JbmZvIiwiU0FYUGFyc2VyIiwibW9kdWxlIiwiZXhwb3J0cyIsIm9wdGlvbnMiLCJjYWxsIiwidG9rZW5pemVyIiwicGFyc2VyRmVlZGJhY2tTaW11bGF0b3IiLCJwZW5kaW5nVGV4dCIsImN1cnJlbnRUb2tlbkxvY2F0aW9uIiwibGFzdENodW5rV3JpdHRlbiIsInN0b3BwZWQiLCJwaXBlIiwicHJvdG90eXBlIiwiX3RyYW5zZm9ybSIsImNodW5rIiwiZW5jb2RpbmciLCJjYWxsYmFjayIsIndyaXRlIiwidG9TdHJpbmciLCJfcnVuUGFyc2luZ0xvb3AiLCJwdXNoIiwiX2ZsdXNoIiwiZW5kIiwic3RvcCIsInRva2VuIiwiZ2V0TmV4dFRva2VuIiwidHlwZSIsIkhJQkVSTkFUSU9OX1RPS0VOIiwiQ0hBUkFDVEVSX1RPS0VOIiwiV0hJVEVTUEFDRV9DSEFSQUNURVJfVE9LRU4iLCJOVUxMX0NIQVJBQ1RFUl9UT0tFTiIsImxvY2F0aW9uIiwiZW5kT2Zmc2V0IiwiY2hhcnMiLCJfZW1pdFBlbmRpbmdUZXh0IiwiX2hhbmRsZVRva2VuIiwiRU9GX1RPS0VOIiwiU1RBUlRfVEFHX1RPS0VOIiwiZW1pdCIsInRhZ05hbWUiLCJhdHRycyIsInNlbGZDbG9zaW5nIiwiRU5EX1RBR19UT0tFTiIsIkNPTU1FTlRfVE9LRU4iLCJkYXRhIiwiRE9DVFlQRV9UT0tFTiIsIm5hbWUiLCJwdWJsaWNJZCIsInN5c3RlbUlkIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFJQSxlQUFlLEdBQUdDLE9BQU8sQ0FBQyxRQUFE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Q0FBQ2UsT0FBMUIsRUFBbUMsS0FBSy9CLG9CQUF4QyxFQURDLEtBR0EsSUFBSWdCLEtBQUssQ0FBQ0UsSUFBTixLQUFlaEMsU0FBUyxDQUFDaUQsYUFBN0IsRUFDRCxLQUFLTCxJQUFMLENBQVUsU0FBVixFQUFxQmQsS0FBSyxDQUFDb0IsSUFBM0IsRUFBaUMsS0FBS3BDLG9CQUF0QyxFQURDLEtBR0EsSUFBSWdCLEtBQUssQ0FBQ0UsSUFBTixLQUFlaEMsU0FBUyxDQUFDbUQsYUFBN0IsRUFDRCxLQUFLUCxJQUFMLENBQVUsU0FBVixFQUFxQmQsS0FBSyxDQUFDc0IsSUFBM0IsRUFBaUN0QixLQUFLLENBQUN1QixRQUF2QyxFQUFpRHZCLEtBQUssQ0FBQ3dCLFFBQXZELEVBQWlFLEtBQUt4QyxvQkFBdEU7QUFDUCxDQWZEOztBQWlCQVIsU0FBUyxDQUFDWSxTQUFWLENBQW9Cc0IsZ0JBQXBCLEdBQXVDLFlBQVk7QUFDL0MsTUFBSSxLQUFLM0IsV0FBTCxLQUFxQixJQUF6QixFQUErQjtBQUMzQixTQUFLK0IsSUFBTCxDQUFVLE1BQVYsRUFBa0IsS0FBSy9CLFdBQXZCLEVBQW9DLEtBQUtDLG9CQUF6QztBQUNBLFNBQUtELFdBQUwsR0FBbUIsSUFBbkI7QUFDSDtBQUNKLENBTEQiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBUcmFuc2Zvcm1TdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKS5UcmFuc2Zvcm0sXG4gICAgRGV2TnVsbFN0cmVhbSA9IHJlcXVpcmUoJy4vZGV2X251bGxfc3RyZWFtJyksXG4gICAgaW5oZXJpdHMgPSByZXF1aXJlKCd1dGlsJykuaW5oZXJpdHMsXG4gICAgVG9rZW5pemVyID0gcmVxdWlyZSgnLi4vdG9rZW5pemVyJyksXG4gICAgTG9jYXRpb25JbmZvVG9rZW5pemVyTWl4aW4gPSByZXF1aXJlKCcuLi9leHRlbnNpb25zL2xvY2F0aW9uX2luZm8vdG9rZW5pemVyX21peGluJyksXG4gICAgUGFyc2VyRmVlZGJhY2tTaW11bGF0b3IgPSByZXF1aXJlKCcuL3BhcnNlcl9mZWVkYmFja19zaW11bGF0b3InKSxcbiAgICBtZXJnZU9wdGlvbnMgPSByZXF1aXJlKCcuLi91dGlscy9tZXJnZV9vcHRpb25zJyk7XG5cbnZhciBERUZBVUxUX09QVElPTlMgPSB7XG4gICAgbG9jYXRpb25JbmZvOiBmYWxzZVxufTtcblxudmFyIFNBWFBhcnNlciA9IG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICBUcmFuc2Zvcm1TdHJlYW0uY2FsbCh0aGlzKTtcblxuICAgIHRoaXMub3B0aW9ucyA9IG1lcmdlT3B0aW9ucyhERUZBVUxUX09QVElPTlMsIG9wdGlvbnMpO1xuXG4gICAgdGhpcy50b2tlbml6ZXIgPSBuZXcgVG9rZW5pemVyKG9wdGlvbnMpO1xuXG4gICAgaWYgKHRoaXMub3B0aW9ucy5sb2NhdGlvbkluZm8pXG4gICAgICAgIG5ldyBMb2NhdGlvbkluZm9Ub2tlbml6ZXJNaXhpbih0aGlzLnRva2VuaXplcik7XG5cbiAgICB0aGlzLnBhcnNlckZlZWRiYWNrU2ltdWxhdG9yID0gbmV3IFBhcnNlckZlZWRiYWNrU2ltdWxhdG9yKHRoaXMudG9rZW5pemVyKTtcblxuICAgIHRoaXMucGVuZGluZ1RleHQgPSBudWxsO1xuICAgIHRoaXMuY3VycmVudFRva2VuTG9jYXRpb24gPSB2b2lkIDA7XG5cbiAgICB0aGlzLmxhc3RDaHVua1dyaXR0ZW4gPSBmYWxzZTtcbiAgICB0aGlzLnN0b3BwZWQgPSBmYWxzZTtcblxuICAgIC8vIE5PVEU6IGFsd2F5cyBwaXBlIHN0cmVhbSB0byB0aGUgL2Rldi9udWxsIHN0cmVhbSB0byBhdm9pZFxuICAgIC8vIGBoaWdoV2F0ZXJNYXJrYCBoaXQgZXZlbiBpZiB3ZSBkb24ndCBoYXZlIGNvbnN1bWVycy5cbiAgICAvLyAoc2VlOiBodHRwczovL2dpdGh1Yi5jb20vaW5pa3VsaW4vcGFyc2U1L2lzc3Vlcy85NyNpc3N1ZWNvbW1lbnQtMTcxOTQwNzc0KVxuICAgIHRoaXMucGlwZShuZXcgRGV2TnVsbFN0cmVhbSgpKTtcbn07XG5cbmluaGVyaXRzKFNBWFBhcnNlciwgVHJhbnNmb3JtU3RyZWFtKTtcblxuLy9UcmFuc2Zvcm1TdHJlYW0gaW1wbGVtZW50YXRpb25cblNBWFBhcnNlci5wcm90b3R5cGUuX3RyYW5zZm9ybSA9IGZ1bmN0aW9uIChjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCF0aGlzLnN0b3BwZWQpIHtcbiAgICAgICAgdGhpcy50b2tlbml6ZXIud3JpdGUoY2h1bmsudG9TdHJpbmcoJ3V0ZjgnKSwgdGhpcy5sYXN0Q2h1bmtXcml0dGVuKTtcbiAgICAgICAgdGhpcy5fcnVuUGFyc2luZ0xvb3AoKTtcbiAgICB9XG5cbiAgICB0aGlzLnB1c2goY2h1bmspO1xuXG4gICAgY2FsbGJhY2soKTtcbn07XG5cblNBWFBhcnNlci5wcm90b3R5cGUuX2ZsdXNoID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XG4gICAgY2FsbGJhY2soKTtcbn07XG5cblNBWFBhcnNlci5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24gKGNodW5rLCBlbmNvZGluZywgY2FsbGJhY2spIHtcbiAgICB0aGlzLmxhc3RDaHVua1dyaXR0ZW4gPSB0cnVlO1xuICAgIFRyYW5zZm9ybVN0cmVhbS5wcm90b3R5cGUuZW5kLmNhbGwodGhpcywgY2h1bmssIGVuY29kaW5nLCBjYWxsYmFjayk7XG59O1xuXG5TQVhQYXJzZXIucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5zdG9wcGVkID0gdHJ1ZTtcbn07XG5cbi8vSW50ZXJuYWxzXG5TQVhQYXJzZXIucHJvdG90eXBlLl9ydW5QYXJzaW5nTG9vcCA9IGZ1bmN0aW9uICgpIHtcbiAgICBkbyB7XG4gICAgICAgIHZhciB0b2tlbiA9IHRoaXMucGFyc2VyRmVlZGJhY2tTaW11bGF0b3IuZ2V0TmV4dFRva2VuKCk7XG5cbiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuaXplci5ISUJFUk5BVElPTl9UT0tFTilcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUb2tlbml6ZXIuQ0hBUkFDVEVSX1RPS0VOIHx8XG4gICAgICAgICAgICB0b2tlbi50eXBlID09PSBUb2tlbml6ZXIuV0hJVEVTUEFDRV9DSEFSQUNURVJfVE9LRU4gfHxcbiAgICAgICAgICAgIHRva2VuLnR5cGUgPT09IFRva2VuaXplci5OVUxMX0NIQVJBQ1RFUl9UT0tFTikge1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvY2F0aW9uSW5mbykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnBlbmRpbmdUZXh0ID09PSBudWxsKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUb2tlbkxvY2F0aW9uID0gdG9rZW4ubG9jYXRpb247XG5cbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFRva2VuTG9jYXRpb24uZW5kT2Zmc2V0ID0gdG9rZW4ubG9jYXRpb24uZW5kT2Zmc2V0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLnBlbmRpbmdUZXh0ID0gKHRoaXMucGVuZGluZ1RleHQgfHwgJycpICsgdG9rZW4uY2hhcnM7XG4gICAgICAgIH1cblxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2VtaXRQZW5kaW5nVGV4dCgpO1xuICAgICAgICAgICAgdGhpcy5faGFuZGxlVG9rZW4odG9rZW4pO1xuICAgICAgICB9XG4gICAgfSB3aGlsZSAoIXRoaXMuc3RvcHBlZCAmJiB0b2tlbi50eXBlICE9PSBUb2tlbml6ZXIuRU9GX1RPS0VOKTtcbn07XG5cblNBWFBhcnNlci5wcm90b3R5cGUuX2hhbmRsZVRva2VuID0gZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgaWYgKHRoaXMub3B0aW9ucy5sb2NhdGlvbkluZm8pXG4gICAgICAgIHRoaXMuY3VycmVudFRva2VuTG9jYXRpb24gPSB0b2tlbi5sb2NhdGlvbjtcblxuICAgIGlmICh0b2tlbi50eXBlID09PSBUb2tlbml6ZXIuU1RBUlRfVEFHX1RPS0VOKVxuICAgICAgICB0aGlzLmVtaXQoJ3N0YXJ0VGFnJywgdG9rZW4udGFnTmFtZSwgdG9rZW4uYXR0cnMsIHRva2VuLnNlbGZDbG9zaW5nLCB0aGlzLmN1cnJlbnRUb2tlbkxvY2F0aW9uKTtcblxuICAgIGVsc2UgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuaXplci5FTkRfVEFHX1RPS0VOKVxuICAgICAgICB0aGlzLmVtaXQoJ2VuZFRhZycsIHRva2VuLnRhZ05hbWUsIHRoaXMuY3VycmVudFRva2VuTG9jYXRpb24pO1xuXG4gICAgZWxzZSBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLkNPTU1FTlRfVE9LRU4pXG4gICAgICAgIHRoaXMuZW1pdCgnY29tbWVudCcsIHRva2VuLmRhdGEsIHRoaXMuY3VycmVudFRva2VuTG9jYXRpb24pO1xuXG4gICAgZWxzZSBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLkRPQ1RZUEVfVE9LRU4pXG4gICAgICAgIHRoaXMuZW1pdCgnZG9jdHlwZScsIHRva2VuLm5hbWUsIHRva2VuLnB1YmxpY0lkLCB0b2tlbi5zeXN0ZW1JZCwgdGhpcy5jdXJyZW50VG9rZW5Mb2NhdGlvbik7XG59O1xuXG5TQVhQYXJzZXIucHJvdG90eXBlLl9lbWl0UGVuZGluZ1RleHQgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMucGVuZGluZ1RleHQgIT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5lbWl0KCd0ZXh0JywgdGhpcy5wZW5kaW5nVGV4dCwgdGhpcy5jdXJyZW50VG9rZW5Mb2NhdGlvbik7XG4gICAgICAgIHRoaXMucGVuZGluZ1RleHQgPSBudWxsO1xuICAgIH1cbn07XG4iXX0=