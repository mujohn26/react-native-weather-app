51680d5a5743bf7ed97f8a0b7b7b9d24
'use strict';

var Mixin = require("../../utils/mixin"),
    Tokenizer = require("../../tokenizer"),
    LocationInfoTokenizerMixin = require("./tokenizer_mixin"),
    PositionTrackingPreprocessorMixin = require("../position_tracking/preprocessor_mixin"),
    LocationInfoOpenElementStackMixin = require("./open_element_stack_mixin"),
    HTML = require("../../common/html"),
    inherits = require('util').inherits;

var $ = HTML.TAG_NAMES;

var LocationInfoParserMixin = module.exports = function (parser) {
  Mixin.call(this, parser);
  this.parser = parser;
  this.posTracker = null;
  this.lastStartTagToken = null;
  this.lastFosterParentingLocation = null;
  this.currentToken = null;
};

inherits(LocationInfoParserMixin, Mixin);

LocationInfoParserMixin.prototype._setStartLocation = function (element) {
  if (this.lastStartTagToken) {
    element.__location = Object.create(this.lastStartTagToken.location);
    element.__location.startTag = this.lastStartTagToken.location;
  } else element.__location = null;
};

LocationInfoParserMixin.prototype._setEndLocation = function (element, closingToken) {
  var loc = element.__location;

  if (loc) {
    if (closingToken.location) {
      var ctLoc = closingToken.location,
          tn = this.parser.treeAdapter.getTagName(element);
      var isClosingEndTag = closingToken.type === Tokenizer.END_TAG_TOKEN && tn === closingToken.tagName;

      if (isClosingEndTag) {
        loc.endTag = Object.create(ctLoc);
        loc.endOffset = ctLoc.endOffset;
      } else loc.endOffset = ctLoc.startOffset;
    } else if (closingToken.type === Tokenizer.EOF_TOKEN) loc.endOffset = this.posTracker.offset;
  }
};

LocationInfoParserMixin.prototype._getOverriddenMethods = function (mxn, orig) {
  return {
    _bootstrap: function _bootstrap(document, fragmentContext) {
      orig._bootstrap.call(this, document, fragmentContext);

      mxn.lastStartTagToken = null;
      mxn.lastFosterParentingLocation = null;
      mxn.currentToken = null;
      mxn.posTracker = new PositionTrackingPreprocessorMixin(this.tokenizer.preprocessor);
      new LocationInfoTokenizerMixin(this.tokenizer);
      new LocationInfoOpenElementStackMixin(this.openElements, {
        onItemPop: function onItemPop(element) {
          mxn._setEndLocation(element, mxn.currentToken);
        }
      });
    },
    _runParsingLoop: function _runParsingLoop(scriptHandler) {
      orig._runParsingLoop.call(this, scriptHandler);

      for (var i = this.openElements.stackTop; i >= 0; i--) {
        mxn._setEndLocation(this.openElements.items[i], mxn.currentToken);
      }
    },
    _processTokenInForeignContent: function _processTokenInForeignContent(token) {
      mxn.currentToken = token;

      orig._processTokenInForeignContent.call(this, token);
    },
    _processToken: function _processToken(token) {
      mxn.currentToken = token;

      orig._processToken.call(this, token);

      var requireExplicitUpdate = token.type === Tokenizer.END_TAG_TOKEN && (token.tagName === $.HTML || token.tagName === $.BODY && this.openElements.hasInScope($.BODY));

      if (requireExplicitUpdate) {
        for (var i = this.openElements.stackTop; i >= 0; i--) {
          var element = this.openElements.items[i];

          if (this.treeAdapter.getTagName(element) === token.tagName) {
            mxn._setEndLocation(element, token);

            break;
          }
        }
      }
    },
    _setDocumentType: function _setDocumentType(token) {
      orig._setDocumentType.call(this, token);

      var documentChildren = this.treeAdapter.getChildNodes(this.document),
          cnLength = documentChildren.length;

      for (var i = 0; i < cnLength; i++) {
        var node = documentChildren[i];

        if (this.treeAdapter.isDocumentTypeNode(node)) {
          node.__location = token.location;
          break;
        }
      }
    },
    _attachElementToTree: function _attachElementToTree(element) {
      mxn._setStartLocation(element);

      mxn.lastStartTagToken = null;

      orig._attachElementToTree.call(this, element);
    },
    _appendElement: function _appendElement(token, namespaceURI) {
      mxn.lastStartTagToken = token;

      orig._appendElement.call(this, token, namespaceURI);
    },
    _insertElement: function _insertElement(token, namespaceURI) {
      mxn.lastStartTagToken = token;

      orig._insertElement.call(this, token, namespaceURI);
    },
    _insertTemplate: function _insertTemplate(token) {
      mxn.lastStartTagToken = token;

      orig._insertTemplate.call(this, token);

      var tmplContent = this.treeAdapter.getTemplateContent(this.openElements.current);
      tmplContent.__location = null;
    },
    _insertFakeRootElement: function _insertFakeRootElement() {
      orig._insertFakeRootElement.call(this);

      this.openElements.current.__location = null;
    },
    _appendCommentNode: function _appendCommentNode(token, parent) {
      orig._appendCommentNode.call(this, token, parent);

      var children = this.treeAdapter.getChildNodes(parent),
          commentNode = children[children.length - 1];
      commentNode.__location = token.location;
    },
    _findFosterParentingLocation: function _findFosterParentingLocation() {
      mxn.lastFosterParentingLocation = orig._findFosterParentingLocation.call(this);
      return mxn.lastFosterParentingLocation;
    },
    _insertCharacters: function _insertCharacters(token) {
      orig._insertCharacters.call(this, token);

      var hasFosterParent = this._shouldFosterParentOnInsertion(),
          parent = hasFosterParent && mxn.lastFosterParentingLocation.parent || this.openElements.currentTmplContent || this.openElements.current,
          siblings = this.treeAdapter.getChildNodes(parent),
          textNodeIdx = hasFosterParent && mxn.lastFosterParentingLocation.beforeElement ? siblings.indexOf(mxn.lastFosterParentingLocation.beforeElement) - 1 : siblings.length - 1,
          textNode = siblings[textNodeIdx];

      if (textNode.__location) textNode.__location.endOffset = token.location.endOffset;else textNode.__location = token.location;
    }
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcnNlcl9taXhpbi5qcyJdLCJuYW1lcyI6WyJNaXhpbiIsInJlcXVpcmUiLCJUb2tlbml6ZXIiLCJMb2NhdGlvbkluZm9Ub2tlbml6ZXJNaXhpbiIsIlBvc2l0aW9uVHJhY2tpbmdQcmVwcm9jZXNzb3JNaXhpbiIsIkxvY2F0aW9uSW5mb09wZW5FbGVtZW50U3RhY2tNaXhpbiIsIkhUTUwiLCJpbmhlcml0cyIsIiQiLCJUQUdfTkFNRVMiLCJMb2NhdGlvbkluZm9QYXJzZXJNaXhpbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJwYXJzZXIiLCJjYWxsIiwicG9zVHJhY2tlciIsImxhc3RTdGFydFRhZ1Rva2VuIiwibGFzdEZvc3RlclBhcmVudGluZ0xvY2F0aW9uIiwiY3VycmVudFRva2VuIiwicHJvdG90eXBlIiwiX3NldFN0YXJ0TG9jYXRpb24iLCJlbGVtZW50IiwiX19sb2NhdGlvbiIsIk9iamVjdCIsImNyZWF0ZSIsImxvY2F0aW9uIiwic3RhcnRUYWciLCJfc2V0RW5kTG9jYXRpb24iLCJjbG9zaW5nVG9rZW4iLCJsb2MiLCJjdExvYyIsInRuIiwidHJlZUFkYXB0ZXIiLCJnZXRUYWdOYW1lIiwiaXNDbG9zaW5nRW5kVGFnIiwidHlwZSIsIkVORF9UQUdfVE9LRU4iLCJ0YWdOYW1lIiwiZW5kVGFnIiwiZW5kT2Zmc2V0Iiwic3RhcnRPZmZzZXQiLCJFT0ZfVE9LRU4iLCJvZmZzZXQiLCJfZ2V0T3ZlcnJpZGRlbk1ldGhvZHMiLCJteG4iLCJvcmlnIiwiX2Jvb3RzdHJhcCIsImRvY3VtZW50IiwiZnJhZ21lbnRDb250ZXh0IiwidG9rZW5pemVyIiwicHJlcHJvY2Vzc29yIiwib3BlbkVsZW1lbnRzIiwib25JdGVtUG9wIiwiX3J1blBhcnNpbmdMb29wIiwic2NyaXB0SGFuZGxlciIsImkiLCJzdGFja1RvcCIsIml0ZW1zIiwiX3Byb2Nlc3NUb2tlbkluRm9yZWlnbkNvbnRlbnQiLCJ0b2tlbiIsIl9wcm9jZXNzVG9rZW4iLCJyZXF1aXJlRXhwbGljaXRVcGRhdGUiLCJCT0RZIiwiaGFzSW5TY29wZSIsIl9zZXREb2N1bWVudFR5cGUiLCJkb2N1bWVudENoaWxkcmVuIiwiZ2V0Q2hpbGROb2RlcyIsImNuTGVuZ3RoIiwibGVuZ3RoIiwibm9kZSIsImlzRG9jdW1lbnRUeXBlTm9kZSIsIl9hdHRhY2hFbGVtZW50VG9UcmVlIiwiX2FwcGVuZEVsZW1lbnQiLCJuYW1lc3BhY2VVUkkiLCJfaW5zZXJ0RWxlbWVudCIsIl9pbnNlcnRUZW1wbGF0ZSIsInRtcGxDb250ZW50IiwiZ2V0VGVtcGxhdGVDb250ZW50IiwiY3VycmVudCIsIl9pbnNlcnRGYWtlUm9vdEVsZW1lbnQiLCJfYXBwZW5kQ29tbWVudE5vZGUiLCJwYXJlbnQiLCJjaGlsZHJlbiIsImNvbW1lbnROb2RlIiwiX2ZpbmRGb3N0ZXJQYXJlbnRpbmdMb2NhdGlvbiIsIl9pbnNlcnRDaGFyYWN0ZXJzIiwiaGFzRm9zdGVyUGFyZW50IiwiX3Nob3VsZEZvc3RlclBhcmVudE9uSW5zZXJ0aW9uIiwiY3VycmVudFRtcGxDb250ZW50Iiwic2libGluZ3MiLCJ0ZXh0Tm9kZUlkeCIsImJlZm9yZUVsZW1lbnQiLCJpbmRleE9mIiwidGV4dE5vZGUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLEtBQUssR0FBR0MsT0FBTyxxQkFBbkI7QUFBQSxJQUNJQyxTQUFTLEdBQUdELE9BQU8sbUJBRHZCO0FBQUEsSUFFSUUsMEJBQTBCLEdBQUdGLE9BQU8scUJBRnhDO0FBQUEsSUFHSUcsaUNBQWlDLEdBQUdILE9BQU8sMkNBSC9DO0FBQUEsSUFJSUksaUNBQWlDLEdBQUdKLE9BQU8sOEJBSi9DO0FBQUEsSUFLSUssSUFBSSxHQUFHTCxPQUFPLHFCQUxsQjtBQUFBLElBTUlNLFFBQVEsR0FBR04sT0FBTyxDQUFDLE1BQUQsQ0FBUCxDQUFnQk0sUUFOL0I7O0FBVUEsSUFBSUMsQ0FBQyxHQUFHRixJQUFJLENBQUNHLFNBQWI7O0FBRUEsSUFBSUMsdUJBQXVCLEdBQUdDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixV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QUF0QjtBQUFBLFVBQ0lOLE1BQU0sR0FBR0ssZUFBZSxJQUFJMUMsR0FBRyxDQUFDM0IsMkJBQUosQ0FBZ0NnRSxNQUFuRCxJQUNBLEtBQUs5QixZQUFMLENBQWtCcUMsa0JBRGxCLElBRUEsS0FBS3JDLFlBQUwsQ0FBa0IyQixPQUgvQjtBQUFBLFVBSUlXLFFBQVEsR0FBRyxLQUFLekQsV0FBTCxDQUFpQmtDLGFBQWpCLENBQStCZSxNQUEvQixDQUpmO0FBQUEsVUFLSVMsV0FBVyxHQUFHSixlQUFlLElBQUkxQyxHQUFHLENBQUMzQiwyQkFBSixDQUFnQzBFLGFBQW5ELEdBQ2RGLFFBQVEsQ0FBQ0csT0FBVCxDQUFpQmhELEdBQUcsQ0FBQzNCLDJCQUFKLENBQWdDMEUsYUFBakQsSUFBa0UsQ0FEcEQsR0FFZEYsUUFBUSxDQUFDckIsTUFBVCxHQUFrQixDQVB0QjtBQUFBLFVBUUl5QixRQUFRLEdBQUdKLFFBQVEsQ0FBQ0MsV0FBRCxDQVJ2Qjs7QUFXQSxVQUFJRyxRQUFRLENBQUN2RSxVQUFiLEVBQ0l1RSxRQUFRLENBQUN2RSxVQUFULENBQW9CaUIsU0FBcEIsR0FBZ0NvQixLQUFLLENBQUNsQyxRQUFOLENBQWVjLFNBQS9DLENBREosS0FJSXNELFFBQVEsQ0FBQ3ZFLFVBQVQsR0FBc0JxQyxLQUFLLENBQUNsQyxRQUE1QjtBQUNQO0FBbEpFLEdBQVA7QUFvSkgsQ0FySkQiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBNaXhpbiA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzL21peGluJyksXG4gICAgVG9rZW5pemVyID0gcmVxdWlyZSgnLi4vLi4vdG9rZW5pemVyJyksXG4gICAgTG9jYXRpb25JbmZvVG9rZW5pemVyTWl4aW4gPSByZXF1aXJlKCcuL3Rva2VuaXplcl9taXhpbicpLFxuICAgIFBvc2l0aW9uVHJhY2tpbmdQcmVwcm9jZXNzb3JNaXhpbiA9IHJlcXVpcmUoJy4uL3Bvc2l0aW9uX3RyYWNraW5nL3ByZXByb2Nlc3Nvcl9taXhpbicpLFxuICAgIExvY2F0aW9uSW5mb09wZW5FbGVtZW50U3RhY2tNaXhpbiA9IHJlcXVpcmUoJy4vb3Blbl9lbGVtZW50X3N0YWNrX21peGluJyksXG4gICAgSFRNTCA9IHJlcXVpcmUoJy4uLy4uL2NvbW1vbi9odG1sJyksXG4gICAgaW5oZXJpdHMgPSByZXF1aXJlKCd1dGlsJykuaW5oZXJpdHM7XG5cblxuLy9BbGlhc2VzXG52YXIgJCA9IEhUTUwuVEFHX05BTUVTO1xuXG52YXIgTG9jYXRpb25JbmZvUGFyc2VyTWl4aW4gPSBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChwYXJzZXIpIHtcbiAgICBNaXhpbi5jYWxsKHRoaXMsIHBhcnNlcik7XG5cbiAgICB0aGlzLnBhcnNlciA9IHBhcnNlcjtcbiAgICB0aGlzLnBvc1RyYWNrZXIgPSBudWxsO1xuICAgIHRoaXMubGFzdFN0YXJ0VGFnVG9rZW4gPSBudWxsO1xuICAgIHRoaXMubGFzdEZvc3RlclBhcmVudGluZ0xvY2F0aW9uID0gbnVsbDtcbiAgICB0aGlzLmN1cnJlbnRUb2tlbiA9IG51bGw7XG59O1xuXG5pbmhlcml0cyhMb2NhdGlvbkluZm9QYXJzZXJNaXhpbiwgTWl4aW4pO1xuXG5cbkxvY2F0aW9uSW5mb1BhcnNlck1peGluLnByb3RvdHlwZS5fc2V0U3RhcnRMb2NhdGlvbiA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgaWYgKHRoaXMubGFzdFN0YXJ0VGFnVG9rZW4pIHtcbiAgICAgICAgZWxlbWVudC5fX2xvY2F0aW9uID0gT2JqZWN0LmNyZWF0ZSh0aGlzLmxhc3RTdGFydFRhZ1Rva2VuLmxvY2F0aW9uKTtcbiAgICAgICAgZWxlbWVudC5fX2xvY2F0aW9uLnN0YXJ0VGFnID0gdGhpcy5sYXN0U3RhcnRUYWdUb2tlbi5sb2NhdGlvbjtcbiAgICB9XG4gICAgZWxzZVxuICAgICAgICBlbGVtZW50Ll9fbG9jYXRpb24gPSBudWxsO1xufTtcblxuTG9jYXRpb25JbmZvUGFyc2VyTWl4aW4ucHJvdG90eXBlLl9zZXRFbmRMb2NhdGlvbiA9IGZ1bmN0aW9uIChlbGVtZW50LCBjbG9zaW5nVG9rZW4pIHtcbiAgICB2YXIgbG9jID0gZWxlbWVudC5fX2xvY2F0aW9uO1xuXG4gICAgaWYgKGxvYykge1xuICAgICAgICBpZiAoY2xvc2luZ1Rva2VuLmxvY2F0aW9uKSB7XG4gICAgICAgICAgICB2YXIgY3RMb2MgPSBjbG9zaW5nVG9rZW4ubG9jYXRpb24sXG4gICAgICAgICAgICAgICAgdG4gPSB0aGlzLnBhcnNlci50cmVlQWRhcHRlci5nZXRUYWdOYW1lKGVsZW1lbnQpO1xuXG4gICAgICAgICAgICAvLyBOT1RFOiBGb3IgY2FzZXMgbGlrZSA8cD4gPHA+IDwvcD4gLSBGaXJzdCAncCcgY2xvc2VzIHdpdGhvdXQgYSBjbG9zaW5nXG4gICAgICAgICAgICAvLyB0YWcgYW5kIGZvciBjYXNlcyBsaWtlIDx0ZD4gPHA+IDwvdGQ+IC0gJ3AnIGNsb3NlcyB3aXRob3V0IGEgY2xvc2luZyB0YWcuXG4gICAgICAgICAgICB2YXIgaXNDbG9zaW5nRW5kVGFnID0gY2xvc2luZ1Rva2VuLnR5cGUgPT09IFRva2VuaXplci5FTkRfVEFHX1RPS0VOICYmIHRuID09PSBjbG9zaW5nVG9rZW4udGFnTmFtZTtcblxuICAgICAgICAgICAgaWYgKGlzQ2xvc2luZ0VuZFRhZykge1xuICAgICAgICAgICAgICAgIGxvYy5lbmRUYWcgPSBPYmplY3QuY3JlYXRlKGN0TG9jKTtcbiAgICAgICAgICAgICAgICBsb2MuZW5kT2Zmc2V0ID0gY3RMb2MuZW5kT2Zmc2V0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgbG9jLmVuZE9mZnNldCA9IGN0TG9jLnN0YXJ0T2Zmc2V0O1xuICAgICAgICB9XG5cbiAgICAgICAgZWxzZSBpZiAoY2xvc2luZ1Rva2VuLnR5cGUgPT09IFRva2VuaXplci5FT0ZfVE9LRU4pXG4gICAgICAgICAgICBsb2MuZW5kT2Zmc2V0ID0gdGhpcy5wb3NUcmFja2VyLm9mZnNldDtcbiAgICB9XG59O1xuXG5Mb2NhdGlvbkluZm9QYXJzZXJNaXhpbi5wcm90b3R5cGUuX2dldE92ZXJyaWRkZW5NZXRob2RzID0gZnVuY3Rpb24gKG14biwgb3JpZykge1xuICAgIHJldHVybiB7XG4gICAgICAgIF9ib290c3RyYXA6IGZ1bmN0aW9uIChkb2N1bWVudCwgZnJhZ21lbnRDb250ZXh0KSB7XG4gICAgICAgICAgICBvcmlnLl9ib290c3RyYXAuY2FsbCh0aGlzLCBkb2N1bWVudCwgZnJhZ21lbnRDb250ZXh0KTtcblxuICAgICAgICAgICAgbXhuLmxhc3RTdGFydFRhZ1Rva2VuID0gbnVsbDtcbiAgICAgICAgICAgIG14bi5sYXN0Rm9zdGVyUGFyZW50aW5nTG9jYXRpb24gPSBudWxsO1xuICAgICAgICAgICAgbXhuLmN1cnJlbnRUb2tlbiA9IG51bGw7XG4gICAgICAgICAgICBteG4ucG9zVHJhY2tlciA9IG5ldyBQb3NpdGlvblRyYWNraW5nUHJlcHJvY2Vzc29yTWl4aW4odGhpcy50b2tlbml6ZXIucHJlcHJvY2Vzc29yKTtcblxuICAgICAgICAgICAgbmV3IExvY2F0aW9uSW5mb1Rva2VuaXplck1peGluKHRoaXMudG9rZW5pemVyKTtcblxuICAgICAgICAgICAgbmV3IExvY2F0aW9uSW5mb09wZW5FbGVtZW50U3RhY2tNaXhpbih0aGlzLm9wZW5FbGVtZW50cywge1xuICAgICAgICAgICAgICAgIG9uSXRlbVBvcDogZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgbXhuLl9zZXRFbmRMb2NhdGlvbihlbGVtZW50LCBteG4uY3VycmVudFRva2VuKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcblxuICAgICAgICBfcnVuUGFyc2luZ0xvb3A6IGZ1bmN0aW9uIChzY3JpcHRIYW5kbGVyKSB7XG4gICAgICAgICAgICBvcmlnLl9ydW5QYXJzaW5nTG9vcC5jYWxsKHRoaXMsIHNjcmlwdEhhbmRsZXIpO1xuXG4gICAgICAgICAgICAvLyBOT1RFOiBnZW5lcmF0ZSBsb2NhdGlvbiBpbmZvIGZvciBlbGVtZW50c1xuICAgICAgICAgICAgLy8gdGhhdCByZW1haW5zIG9uIG9wZW4gZWxlbWVudCBzdGFja1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMub3BlbkVsZW1lbnRzLnN0YWNrVG9wOyBpID49IDA7IGktLSlcbiAgICAgICAgICAgICAgICBteG4uX3NldEVuZExvY2F0aW9uKHRoaXMub3BlbkVsZW1lbnRzLml0ZW1zW2ldLCBteG4uY3VycmVudFRva2VuKTtcbiAgICAgICAgfSxcblxuXG4gICAgICAgIC8vVG9rZW4gcHJvY2Vzc2luZ1xuICAgICAgICBfcHJvY2Vzc1Rva2VuSW5Gb3JlaWduQ29udGVudDogZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgICAgICAgICBteG4uY3VycmVudFRva2VuID0gdG9rZW47XG4gICAgICAgICAgICBvcmlnLl9wcm9jZXNzVG9rZW5JbkZvcmVpZ25Db250ZW50LmNhbGwodGhpcywgdG9rZW4pO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9wcm9jZXNzVG9rZW46IGZ1bmN0aW9uICh0b2tlbikge1xuICAgICAgICAgICAgbXhuLmN1cnJlbnRUb2tlbiA9IHRva2VuO1xuICAgICAgICAgICAgb3JpZy5fcHJvY2Vzc1Rva2VuLmNhbGwodGhpcywgdG9rZW4pO1xuXG4gICAgICAgICAgICAvL05PVEU6IDxib2R5PiBhbmQgPGh0bWw+IGFyZSBuZXZlciBwb3BwZWQgZnJvbSB0aGUgc3RhY2ssIHNvIHdlIG5lZWQgdG8gdXBkYXRlZFxuICAgICAgICAgICAgLy90aGVpciBlbmQgbG9jYXRpb24gZXhwbGljaXRseS5cbiAgICAgICAgICAgIHZhciByZXF1aXJlRXhwbGljaXRVcGRhdGUgPSB0b2tlbi50eXBlID09PSBUb2tlbml6ZXIuRU5EX1RBR19UT0tFTiAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0b2tlbi50YWdOYW1lID09PSAkLkhUTUwgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4udGFnTmFtZSA9PT0gJC5CT0RZICYmIHRoaXMub3BlbkVsZW1lbnRzLmhhc0luU2NvcGUoJC5CT0RZKSk7XG5cbiAgICAgICAgICAgIGlmIChyZXF1aXJlRXhwbGljaXRVcGRhdGUpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5vcGVuRWxlbWVudHMuc3RhY2tUb3A7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5vcGVuRWxlbWVudHMuaXRlbXNbaV07XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudHJlZUFkYXB0ZXIuZ2V0VGFnTmFtZShlbGVtZW50KSA9PT0gdG9rZW4udGFnTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbXhuLl9zZXRFbmRMb2NhdGlvbihlbGVtZW50LCB0b2tlbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuXG4gICAgICAgIC8vRG9jdHlwZVxuICAgICAgICBfc2V0RG9jdW1lbnRUeXBlOiBmdW5jdGlvbiAodG9rZW4pIHtcbiAgICAgICAgICAgIG9yaWcuX3NldERvY3VtZW50VHlwZS5jYWxsKHRoaXMsIHRva2VuKTtcblxuICAgICAgICAgICAgdmFyIGRvY3VtZW50Q2hpbGRyZW4gPSB0aGlzLnRyZWVBZGFwdGVyLmdldENoaWxkTm9kZXModGhpcy5kb2N1bWVudCksXG4gICAgICAgICAgICAgICAgY25MZW5ndGggPSBkb2N1bWVudENoaWxkcmVuLmxlbmd0aDtcblxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbkxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBkb2N1bWVudENoaWxkcmVuW2ldO1xuXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudHJlZUFkYXB0ZXIuaXNEb2N1bWVudFR5cGVOb2RlKG5vZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuX19sb2NhdGlvbiA9IHRva2VuLmxvY2F0aW9uO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG5cblxuICAgICAgICAvL0VsZW1lbnRzXG4gICAgICAgIF9hdHRhY2hFbGVtZW50VG9UcmVlOiBmdW5jdGlvbiAoZWxlbWVudCkge1xuICAgICAgICAgICAgLy9OT1RFOiBfYXR0YWNoRWxlbWVudFRvVHJlZSBpcyBjYWxsZWQgZnJvbSBfYXBwZW5kRWxlbWVudCwgX2luc2VydEVsZW1lbnQgYW5kIF9pbnNlcnRUZW1wbGF0ZSBtZXRob2RzLlxuICAgICAgICAgICAgLy9TbyB3ZSB3aWxsIHVzZSB0b2tlbiBsb2NhdGlvbiBzdG9yZWQgaW4gdGhpcyBtZXRob2RzIGZvciB0aGUgZWxlbWVudC5cbiAgICAgICAgICAgIG14bi5fc2V0U3RhcnRMb2NhdGlvbihlbGVtZW50KTtcbiAgICAgICAgICAgIG14bi5sYXN0U3RhcnRUYWdUb2tlbiA9IG51bGw7XG4gICAgICAgICAgICBvcmlnLl9hdHRhY2hFbGVtZW50VG9UcmVlLmNhbGwodGhpcywgZWxlbWVudCk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2FwcGVuZEVsZW1lbnQ6IGZ1bmN0aW9uICh0b2tlbiwgbmFtZXNwYWNlVVJJKSB7XG4gICAgICAgICAgICBteG4ubGFzdFN0YXJ0VGFnVG9rZW4gPSB0b2tlbjtcbiAgICAgICAgICAgIG9yaWcuX2FwcGVuZEVsZW1lbnQuY2FsbCh0aGlzLCB0b2tlbiwgbmFtZXNwYWNlVVJJKTtcbiAgICAgICAgfSxcblxuICAgICAgICBfaW5zZXJ0RWxlbWVudDogZnVuY3Rpb24gKHRva2VuLCBuYW1lc3BhY2VVUkkpIHtcbiAgICAgICAgICAgIG14bi5sYXN0U3RhcnRUYWdUb2tlbiA9IHRva2VuO1xuICAgICAgICAgICAgb3JpZy5faW5zZXJ0RWxlbWVudC5jYWxsKHRoaXMsIHRva2VuLCBuYW1lc3BhY2VVUkkpO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9pbnNlcnRUZW1wbGF0ZTogZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgICAgICAgICBteG4ubGFzdFN0YXJ0VGFnVG9rZW4gPSB0b2tlbjtcbiAgICAgICAgICAgIG9yaWcuX2luc2VydFRlbXBsYXRlLmNhbGwodGhpcywgdG9rZW4pO1xuXG4gICAgICAgICAgICB2YXIgdG1wbENvbnRlbnQgPSB0aGlzLnRyZWVBZGFwdGVyLmdldFRlbXBsYXRlQ29udGVudCh0aGlzLm9wZW5FbGVtZW50cy5jdXJyZW50KTtcblxuICAgICAgICAgICAgdG1wbENvbnRlbnQuX19sb2NhdGlvbiA9IG51bGw7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2luc2VydEZha2VSb290RWxlbWVudDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgb3JpZy5faW5zZXJ0RmFrZVJvb3RFbGVtZW50LmNhbGwodGhpcyk7XG4gICAgICAgICAgICB0aGlzLm9wZW5FbGVtZW50cy5jdXJyZW50Ll9fbG9jYXRpb24gPSBudWxsO1xuICAgICAgICB9LFxuXG4gICAgICAgIC8vQ29tbWVudHNcbiAgICAgICAgX2FwcGVuZENvbW1lbnROb2RlOiBmdW5jdGlvbiAodG9rZW4sIHBhcmVudCkge1xuICAgICAgICAgICAgb3JpZy5fYXBwZW5kQ29tbWVudE5vZGUuY2FsbCh0aGlzLCB0b2tlbiwgcGFyZW50KTtcblxuICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gdGhpcy50cmVlQWRhcHRlci5nZXRDaGlsZE5vZGVzKHBhcmVudCksXG4gICAgICAgICAgICAgICAgY29tbWVudE5vZGUgPSBjaGlsZHJlbltjaGlsZHJlbi5sZW5ndGggLSAxXTtcblxuICAgICAgICAgICAgY29tbWVudE5vZGUuX19sb2NhdGlvbiA9IHRva2VuLmxvY2F0aW9uO1xuICAgICAgICB9LFxuXG4gICAgICAgIC8vVGV4dFxuICAgICAgICBfZmluZEZvc3RlclBhcmVudGluZ0xvY2F0aW9uOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvL05PVEU6IHN0b3JlIGxhc3QgZm9zdGVyIHBhcmVudGluZyBsb2NhdGlvbiwgc28gd2Ugd2lsbCBiZSBhYmxlIHRvIGZpbmQgaW5zZXJ0ZWQgdGV4dFxuICAgICAgICAgICAgLy9pbiBjYXNlIG9mIGZvc3RlciBwYXJlbnRpbmdcbiAgICAgICAgICAgIG14bi5sYXN0Rm9zdGVyUGFyZW50aW5nTG9jYXRpb24gPSBvcmlnLl9maW5kRm9zdGVyUGFyZW50aW5nTG9jYXRpb24uY2FsbCh0aGlzKTtcblxuICAgICAgICAgICAgcmV0dXJuIG14bi5sYXN0Rm9zdGVyUGFyZW50aW5nTG9jYXRpb247XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2luc2VydENoYXJhY3RlcnM6IGZ1bmN0aW9uICh0b2tlbikge1xuICAgICAgICAgICAgb3JpZy5faW5zZXJ0Q2hhcmFjdGVycy5jYWxsKHRoaXMsIHRva2VuKTtcblxuICAgICAgICAgICAgdmFyIGhhc0Zvc3RlclBhcmVudCA9IHRoaXMuX3Nob3VsZEZvc3RlclBhcmVudE9uSW5zZXJ0aW9uKCksXG4gICAgICAgICAgICAgICAgcGFyZW50ID0gaGFzRm9zdGVyUGFyZW50ICYmIG14bi5sYXN0Rm9zdGVyUGFyZW50aW5nTG9jYXRpb24ucGFyZW50IHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuRWxlbWVudHMuY3VycmVudFRtcGxDb250ZW50IHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuRWxlbWVudHMuY3VycmVudCxcbiAgICAgICAgICAgICAgICBzaWJsaW5ncyA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0Q2hpbGROb2RlcyhwYXJlbnQpLFxuICAgICAgICAgICAgICAgIHRleHROb2RlSWR4ID0gaGFzRm9zdGVyUGFyZW50ICYmIG14bi5sYXN0Rm9zdGVyUGFyZW50aW5nTG9jYXRpb24uYmVmb3JlRWxlbWVudCA/XG4gICAgICAgICAgICAgICAgc2libGluZ3MuaW5kZXhPZihteG4ubGFzdEZvc3RlclBhcmVudGluZ0xvY2F0aW9uLmJlZm9yZUVsZW1lbnQpIC0gMSA6XG4gICAgICAgICAgICAgICAgc2libGluZ3MubGVuZ3RoIC0gMSxcbiAgICAgICAgICAgICAgICB0ZXh0Tm9kZSA9IHNpYmxpbmdzW3RleHROb2RlSWR4XTtcblxuICAgICAgICAgICAgLy9OT1RFOiBpZiB3ZSBoYXZlIGxvY2F0aW9uIGFzc2lnbmVkIGJ5IGFub3RoZXIgdG9rZW4sIHRoZW4ganVzdCB1cGRhdGUgZW5kIHBvc2l0aW9uXG4gICAgICAgICAgICBpZiAodGV4dE5vZGUuX19sb2NhdGlvbilcbiAgICAgICAgICAgICAgICB0ZXh0Tm9kZS5fX2xvY2F0aW9uLmVuZE9mZnNldCA9IHRva2VuLmxvY2F0aW9uLmVuZE9mZnNldDtcblxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIHRleHROb2RlLl9fbG9jYXRpb24gPSB0b2tlbi5sb2NhdGlvbjtcbiAgICAgICAgfVxuICAgIH07XG59O1xuXG4iXX0=