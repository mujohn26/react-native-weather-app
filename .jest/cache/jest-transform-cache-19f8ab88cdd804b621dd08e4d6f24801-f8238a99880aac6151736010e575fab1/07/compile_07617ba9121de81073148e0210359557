788319494e09459336a18a88eb8e15a6
module.exports = compile;
module.exports.compileUnsafe = compileUnsafe;
module.exports.compileToken = compileToken;

var parse = require("css-what"),
    DomUtils = require("domutils"),
    isTag = DomUtils.isTag,
    Rules = require("./general.js"),
    sortRules = require("./sort.js"),
    BaseFuncs = require("boolbase"),
    trueFunc = BaseFuncs.trueFunc,
    falseFunc = BaseFuncs.falseFunc,
    procedure = require("./procedure.json");

function compile(selector, options, context) {
  var next = compileUnsafe(selector, options, context);
  return wrap(next);
}

function wrap(next) {
  return function base(elem) {
    return isTag(elem) && next(elem);
  };
}

function compileUnsafe(selector, options, context) {
  var token = parse(selector, options);
  return compileToken(token, options, context);
}

function includesScopePseudo(t) {
  return t.type === "pseudo" && (t.name === "scope" || Array.isArray(t.data) && t.data.some(function (data) {
    return data.some(includesScopePseudo);
  }));
}

var DESCENDANT_TOKEN = {
  type: "descendant"
},
    SCOPE_TOKEN = {
  type: "pseudo",
  name: "scope"
},
    PLACEHOLDER_ELEMENT = {},
    getParent = DomUtils.getParent;

function absolutize(token, context) {
  var hasContext = !!context && !!context.length && context.every(function (e) {
    return e === PLACEHOLDER_ELEMENT || !!getParent(e);
  });
  token.forEach(function (t) {
    if (t.length > 0 && isTraversal(t[0]) && t[0].type !== "descendant") {} else if (hasContext && !includesScopePseudo(t)) {
      t.unshift(DESCENDANT_TOKEN);
    } else {
      return;
    }

    t.unshift(SCOPE_TOKEN);
  });
}

function compileToken(token, options, context) {
  token = token.filter(function (t) {
    return t.length > 0;
  });
  token.forEach(sortRules);
  var isArrayContext = Array.isArray(context);
  context = options && options.context || context;
  if (context && !isArrayContext) context = [context];
  absolutize(token, context);
  return token.map(function (rules) {
    return compileRules(rules, options, context, isArrayContext);
  }).reduce(reduceRules, falseFunc);
}

function isTraversal(t) {
  return procedure[t.type] < 0;
}

function compileRules(rules, options, context, isArrayContext) {
  var acceptSelf = isArrayContext && rules[0].name === "scope" && rules[1].type === "descendant";
  return rules.reduce(function (func, rule, index) {
    if (func === falseFunc) return func;
    return Rules[rule.type](func, rule, options, context, acceptSelf && index === 1);
  }, options && options.rootFunc || trueFunc);
}

function reduceRules(a, b) {
  if (b === falseFunc || a === trueFunc) {
    return a;
  }

  if (a === falseFunc || b === trueFunc) {
    return b;
  }

  return function combine(elem) {
    return a(elem) || b(elem);
  };
}

var Pseudos = require("./pseudos.js"),
    filters = Pseudos.filters,
    existsOne = DomUtils.existsOne,
    isTag = DomUtils.isTag,
    getChildren = DomUtils.getChildren;

function containsTraversal(t) {
  return t.some(isTraversal);
}

filters.not = function (next, token, options, context) {
  var opts = {
    xmlMode: !!(options && options.xmlMode),
    strict: !!(options && options.strict)
  };

  if (opts.strict) {
    if (token.length > 1 || token.some(containsTraversal)) {
      throw new SyntaxError("complex selectors in :not aren't allowed in strict mode");
    }
  }

  var func = compileToken(token, opts, context);
  if (func === falseFunc) return next;
  if (func === trueFunc) return falseFunc;
  return function (elem) {
    return !func(elem) && next(elem);
  };
};

filters.has = function (next, token, options) {
  var opts = {
    xmlMode: !!(options && options.xmlMode),
    strict: !!(options && options.strict)
  };
  var context = token.some(containsTraversal) ? [PLACEHOLDER_ELEMENT] : null;
  var func = compileToken(token, opts, context);
  if (func === falseFunc) return falseFunc;
  if (func === trueFunc) return function (elem) {
    return getChildren(elem).some(isTag) && next(elem);
  };
  func = wrap(func);

  if (context) {
    return function has(elem) {
      return next(elem) && (context[0] = elem, existsOne(func, getChildren(elem)));
    };
  }

  return function has(elem) {
    return next(elem) && existsOne(func, getChildren(elem));
  };
};

filters.matches = function (next, token, options, context) {
  var opts = {
    xmlMode: !!(options && options.xmlMode),
    strict: !!(options && options.strict),
    rootFunc: next
  };
  return compileToken(token, opts, context);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBpbGUuanMiXSwibmFtZXMiOlsibW9kdWxlIiwiZXhwb3J0cyIsImNvbXBpbGUiLCJjb21waWxlVW5zYWZlIiwiY29tcGlsZVRva2VuIiwicGFyc2UiLCJyZXF1aXJlIiwiRG9tVXRpbHMiLCJpc1RhZyIsIlJ1bGVzIiwic29ydFJ1bGVzIiwiQmFzZUZ1bmNzIiwidHJ1ZUZ1bmMiLCJmYWxzZUZ1bmMiLCJwcm9jZWR1cmUiLCJzZWxlY3RvciIsIm9wdGlvbnMiLCJjb250ZXh0IiwibmV4dCIsIndyYXAiLCJiYXNlIiwiZWxlbSIsInRva2VuIiwiaW5jbHVkZXNTY29wZVBzZXVkbyIsInQiLCJ0eXBlIiwibmFtZSIsIkFycmF5IiwiaXNBcnJheSIsImRhdGEiLCJzb21lIiwiREVTQ0VOREFOVF9UT0tFTiIsIlNDT1BFX1RPS0VOIiwiUExBQ0VIT0xERVJfRUxFTUVOVCIsImdldFBhcmVudCIsImFic29sdXRpemUiLCJoYXNDb250ZXh0IiwibGVuZ3RoIiwiZXZlcnkiLCJlIiwiZm9yRWFjaCIsImlzVHJhdmVyc2FsIiwidW5zaGlmdCIsImZpbHRlciIsImlzQXJyYXlDb250ZXh0IiwibWFwIiwicnVsZXMiLCJjb21waWxlUnVsZXMiLCJyZWR1Y2UiLCJyZWR1Y2VSdWxlcyIsImFjY2VwdFNlbGYiLCJmdW5jIiwicnVsZSIsImluZGV4Iiwicm9vdEZ1bmMiLCJhIiwiYiIsImNvbWJpbmUiLCJQc2V1ZG9zIiwiZmlsdGVycyIsImV4aXN0c09uZSIsImdldENoaWxkcmVuIiwiY29udGFpbnNUcmF2ZXJzYWwiLCJub3QiLCJvcHRzIiwieG1sTW9kZSIsInN0cmljdCIsIlN5bnRheEVycm9yIiwiaGFzIiwibWF0Y2hlcyJdLCJtYXBwaW5ncyI6IkFBSUFBLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQkMsT0FBakI7QUFDQUYsTUFBTSxDQUFDQyxPQUFQLENBQWVFLGFBQWYsR0FBK0JBLGFBQS9CO0FBQ0FILE1BQU0sQ0FBQ0MsT0FBUCxDQUFlRyxZQUFmLEdBQThC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QUFELENBQWxCLENBRHJDLENBQVA7QUFHQSxLQUpNO0FBS0g7O0FBRUQsU0FBTyxTQUFTK0MsR0FBVCxDQUFhL0MsSUFBYixFQUFrQjtBQUMzQixXQUFPSCxJQUFJLENBQUNHLElBQUQsQ0FBSixJQUFjdUMsU0FBUyxDQUFDVCxJQUFELEVBQU9VLFdBQVcsQ0FBQ3hDLElBQUQsQ0FBbEIsQ0FBOUI7QUFDQSxHQUZFO0FBR0gsQ0E3QkQ7O0FBK0JBc0MsT0FBTyxDQUFDVSxPQUFSLEdBQWtCLFVBQVNuRCxJQUFULEVBQWVJLEtBQWYsRUFBc0JOLE9BQXRCLEVBQStCQyxPQUEvQixFQUF1QztBQUN4RCxNQUFJK0MsSUFBSSxHQUFHO0FBQ1ZDLElBQUFBLE9BQU8sRUFBRSxDQUFDLEVBQUVqRCxPQUFPLElBQUlBLE9BQU8sQ0FBQ2lELE9BQXJCLENBREE7QUFFVkMsSUFBQUEsTUFBTSxFQUFFLENBQUMsRUFBRWxELE9BQU8sSUFBSUEsT0FBTyxDQUFDa0QsTUFBckIsQ0FGQztBQUdWWixJQUFBQSxRQUFRLEVBQUVwQztBQUhBLEdBQVg7QUFNQSxTQUFPZCxZQUFZLENBQUNrQixLQUFELEVBQVEwQyxJQUFSLEVBQWMvQyxPQUFkLENBQW5CO0FBQ0EsQ0FSRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5cdGNvbXBpbGVzIGEgc2VsZWN0b3IgdG8gYW4gZXhlY3V0YWJsZSBmdW5jdGlvblxuKi9cblxubW9kdWxlLmV4cG9ydHMgPSBjb21waWxlO1xubW9kdWxlLmV4cG9ydHMuY29tcGlsZVVuc2FmZSA9IGNvbXBpbGVVbnNhZmU7XG5tb2R1bGUuZXhwb3J0cy5jb21waWxlVG9rZW4gPSBjb21waWxlVG9rZW47XG5cbnZhciBwYXJzZSAgICAgICA9IHJlcXVpcmUoXCJjc3Mtd2hhdFwiKSxcbiAgICBEb21VdGlscyAgICA9IHJlcXVpcmUoXCJkb211dGlsc1wiKSxcbiAgICBpc1RhZyAgICAgICA9IERvbVV0aWxzLmlzVGFnLFxuICAgIFJ1bGVzICAgICAgID0gcmVxdWlyZShcIi4vZ2VuZXJhbC5qc1wiKSxcbiAgICBzb3J0UnVsZXMgICA9IHJlcXVpcmUoXCIuL3NvcnQuanNcIiksXG4gICAgQmFzZUZ1bmNzICAgPSByZXF1aXJlKFwiYm9vbGJhc2VcIiksXG4gICAgdHJ1ZUZ1bmMgICAgPSBCYXNlRnVuY3MudHJ1ZUZ1bmMsXG4gICAgZmFsc2VGdW5jICAgPSBCYXNlRnVuY3MuZmFsc2VGdW5jLFxuICAgIHByb2NlZHVyZSAgID0gcmVxdWlyZShcIi4vcHJvY2VkdXJlLmpzb25cIik7XG5cbmZ1bmN0aW9uIGNvbXBpbGUoc2VsZWN0b3IsIG9wdGlvbnMsIGNvbnRleHQpe1xuXHR2YXIgbmV4dCA9IGNvbXBpbGVVbnNhZmUoc2VsZWN0b3IsIG9wdGlvbnMsIGNvbnRleHQpO1xuXHRyZXR1cm4gd3JhcChuZXh0KTtcbn1cblxuZnVuY3Rpb24gd3JhcChuZXh0KXtcblx0cmV0dXJuIGZ1bmN0aW9uIGJhc2UoZWxlbSl7XG5cdFx0cmV0dXJuIGlzVGFnKGVsZW0pICYmIG5leHQoZWxlbSk7XG5cdH07XG59XG5cbmZ1bmN0aW9uIGNvbXBpbGVVbnNhZmUoc2VsZWN0b3IsIG9wdGlvbnMsIGNvbnRleHQpe1xuXHR2YXIgdG9rZW4gPSBwYXJzZShzZWxlY3Rvciwgb3B0aW9ucyk7XG5cdHJldHVybiBjb21waWxlVG9rZW4odG9rZW4sIG9wdGlvbnMsIGNvbnRleHQpO1xufVxuXG5mdW5jdGlvbiBpbmNsdWRlc1Njb3BlUHNldWRvKHQpe1xuICAgIHJldHVybiB0LnR5cGUgPT09IFwicHNldWRvXCIgJiYgKFxuICAgICAgICB0Lm5hbWUgPT09IFwic2NvcGVcIiB8fCAoXG4gICAgICAgICAgICBBcnJheS5pc0FycmF5KHQuZGF0YSkgJiZcbiAgICAgICAgICAgIHQuZGF0YS5zb21lKGZ1bmN0aW9uKGRhdGEpe1xuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhLnNvbWUoaW5jbHVkZXNTY29wZVBzZXVkbyk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgKTtcbn1cblxudmFyIERFU0NFTkRBTlRfVE9LRU4gPSB7dHlwZTogXCJkZXNjZW5kYW50XCJ9LFxuICAgIFNDT1BFX1RPS0VOID0ge3R5cGU6IFwicHNldWRvXCIsIG5hbWU6IFwic2NvcGVcIn0sXG4gICAgUExBQ0VIT0xERVJfRUxFTUVOVCA9IHt9LFxuICAgIGdldFBhcmVudCA9IERvbVV0aWxzLmdldFBhcmVudDtcblxuLy9DU1MgNCBTcGVjIChEcmFmdCk6IDMuMy4xLiBBYnNvbHV0aXppbmcgYSBTY29wZS1yZWxhdGl2ZSBTZWxlY3RvclxuLy9odHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnM0LyNhYnNvbHV0aXppbmdcbmZ1bmN0aW9uIGFic29sdXRpemUodG9rZW4sIGNvbnRleHQpe1xuICAgIC8vVE9ETyBiZXR0ZXIgY2hlY2sgaWYgY29udGV4dCBpcyBkb2N1bWVudFxuICAgIHZhciBoYXNDb250ZXh0ID0gISFjb250ZXh0ICYmICEhY29udGV4dC5sZW5ndGggJiYgY29udGV4dC5ldmVyeShmdW5jdGlvbihlKXtcbiAgICAgICAgcmV0dXJuIGUgPT09IFBMQUNFSE9MREVSX0VMRU1FTlQgfHwgISFnZXRQYXJlbnQoZSk7XG4gICAgfSk7XG5cblxuICAgIHRva2VuLmZvckVhY2goZnVuY3Rpb24odCl7XG4gICAgICAgIGlmKHQubGVuZ3RoID4gMCAmJiBpc1RyYXZlcnNhbCh0WzBdKSAmJiB0WzBdLnR5cGUgIT09IFwiZGVzY2VuZGFudFwiKXtcbiAgICAgICAgICAgIC8vZG9uJ3QgcmV0dXJuIGluIGVsc2UgYnJhbmNoXG4gICAgICAgIH0gZWxzZSBpZihoYXNDb250ZXh0ICYmICFpbmNsdWRlc1Njb3BlUHNldWRvKHQpKXtcbiAgICAgICAgICAgIHQudW5zaGlmdChERVNDRU5EQU5UX1RPS0VOKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHQudW5zaGlmdChTQ09QRV9UT0tFTik7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGNvbXBpbGVUb2tlbih0b2tlbiwgb3B0aW9ucywgY29udGV4dCl7XG4gICAgdG9rZW4gPSB0b2tlbi5maWx0ZXIoZnVuY3Rpb24odCl7IHJldHVybiB0Lmxlbmd0aCA+IDA7IH0pO1xuXG5cdHRva2VuLmZvckVhY2goc29ydFJ1bGVzKTtcblxuXHR2YXIgaXNBcnJheUNvbnRleHQgPSBBcnJheS5pc0FycmF5KGNvbnRleHQpO1xuXG4gICAgY29udGV4dCA9IChvcHRpb25zICYmIG9wdGlvbnMuY29udGV4dCkgfHwgY29udGV4dDtcblxuICAgIGlmKGNvbnRleHQgJiYgIWlzQXJyYXlDb250ZXh0KSBjb250ZXh0ID0gW2NvbnRleHRdO1xuXG4gICAgYWJzb2x1dGl6ZSh0b2tlbiwgY29udGV4dCk7XG5cblx0cmV0dXJuIHRva2VuXG5cdFx0Lm1hcChmdW5jdGlvbihydWxlcyl7IHJldHVybiBjb21waWxlUnVsZXMocnVsZXMsIG9wdGlvbnMsIGNvbnRleHQsIGlzQXJyYXlDb250ZXh0KTsgfSlcblx0XHQucmVkdWNlKHJlZHVjZVJ1bGVzLCBmYWxzZUZ1bmMpO1xufVxuXG5mdW5jdGlvbiBpc1RyYXZlcnNhbCh0KXtcblx0cmV0dXJuIHByb2NlZHVyZVt0LnR5cGVdIDwgMDtcbn1cblxuZnVuY3Rpb24gY29tcGlsZVJ1bGVzKHJ1bGVzLCBvcHRpb25zLCBjb250ZXh0LCBpc0FycmF5Q29udGV4dCl7XG5cdHZhciBhY2NlcHRTZWxmID0gKGlzQXJyYXlDb250ZXh0ICYmIHJ1bGVzWzBdLm5hbWUgPT09IFwic2NvcGVcIiAmJiBydWxlc1sxXS50eXBlID09PSBcImRlc2NlbmRhbnRcIik7XG5cdHJldHVybiBydWxlcy5yZWR1Y2UoZnVuY3Rpb24oZnVuYywgcnVsZSwgaW5kZXgpe1xuXHRcdGlmKGZ1bmMgPT09IGZhbHNlRnVuYykgcmV0dXJuIGZ1bmM7XG5cdFx0cmV0dXJuIFJ1bGVzW3J1bGUudHlwZV0oZnVuYywgcnVsZSwgb3B0aW9ucywgY29udGV4dCwgYWNjZXB0U2VsZiAmJiBpbmRleCA9PT0gMSk7XG5cdH0sIG9wdGlvbnMgJiYgb3B0aW9ucy5yb290RnVuYyB8fCB0cnVlRnVuYyk7XG59XG5cbmZ1bmN0aW9uIHJlZHVjZVJ1bGVzKGEsIGIpe1xuXHRpZihiID09PSBmYWxzZUZ1bmMgfHwgYSA9PT0gdHJ1ZUZ1bmMpe1xuXHRcdHJldHVybiBhO1xuXHR9XG5cdGlmKGEgPT09IGZhbHNlRnVuYyB8fCBiID09PSB0cnVlRnVuYyl7XG5cdFx0cmV0dXJuIGI7XG5cdH1cblxuXHRyZXR1cm4gZnVuY3Rpb24gY29tYmluZShlbGVtKXtcblx0XHRyZXR1cm4gYShlbGVtKSB8fCBiKGVsZW0pO1xuXHR9O1xufVxuXG4vLzpub3QsIDpoYXMgYW5kIDptYXRjaGVzIGhhdmUgdG8gY29tcGlsZSBzZWxlY3RvcnNcbi8vZG9pbmcgdGhpcyBpbiBsaWIvcHNldWRvcy5qcyB3b3VsZCBsZWFkIHRvIGNpcmN1bGFyIGRlcGVuZGVuY2llcyxcbi8vc28gd2UgYWRkIHRoZW0gaGVyZVxuXG52YXIgUHNldWRvcyAgICAgPSByZXF1aXJlKFwiLi9wc2V1ZG9zLmpzXCIpLFxuICAgIGZpbHRlcnMgICAgID0gUHNldWRvcy5maWx0ZXJzLFxuICAgIGV4aXN0c09uZSAgID0gRG9tVXRpbHMuZXhpc3RzT25lLFxuICAgIGlzVGFnICAgICAgID0gRG9tVXRpbHMuaXNUYWcsXG4gICAgZ2V0Q2hpbGRyZW4gPSBEb21VdGlscy5nZXRDaGlsZHJlbjtcblxuXG5mdW5jdGlvbiBjb250YWluc1RyYXZlcnNhbCh0KXtcblx0cmV0dXJuIHQuc29tZShpc1RyYXZlcnNhbCk7XG59XG5cbmZpbHRlcnMubm90ID0gZnVuY3Rpb24obmV4dCwgdG9rZW4sIG9wdGlvbnMsIGNvbnRleHQpe1xuXHR2YXIgb3B0cyA9IHtcblx0ICAgIFx0eG1sTW9kZTogISEob3B0aW9ucyAmJiBvcHRpb25zLnhtbE1vZGUpLFxuXHQgICAgXHRzdHJpY3Q6ICEhKG9wdGlvbnMgJiYgb3B0aW9ucy5zdHJpY3QpXG5cdCAgICB9O1xuXG5cdGlmKG9wdHMuc3RyaWN0KXtcblx0XHRpZih0b2tlbi5sZW5ndGggPiAxIHx8IHRva2VuLnNvbWUoY29udGFpbnNUcmF2ZXJzYWwpKXtcblx0XHRcdHRocm93IG5ldyBTeW50YXhFcnJvcihcImNvbXBsZXggc2VsZWN0b3JzIGluIDpub3QgYXJlbid0IGFsbG93ZWQgaW4gc3RyaWN0IG1vZGVcIik7XG5cdFx0fVxuXHR9XG5cbiAgICB2YXIgZnVuYyA9IGNvbXBpbGVUb2tlbih0b2tlbiwgb3B0cywgY29udGV4dCk7XG5cblx0aWYoZnVuYyA9PT0gZmFsc2VGdW5jKSByZXR1cm4gbmV4dDtcblx0aWYoZnVuYyA9PT0gdHJ1ZUZ1bmMpICByZXR1cm4gZmFsc2VGdW5jO1xuXG5cdHJldHVybiBmdW5jdGlvbihlbGVtKXtcblx0XHRyZXR1cm4gIWZ1bmMoZWxlbSkgJiYgbmV4dChlbGVtKTtcblx0fTtcbn07XG5cbmZpbHRlcnMuaGFzID0gZnVuY3Rpb24obmV4dCwgdG9rZW4sIG9wdGlvbnMpe1xuXHR2YXIgb3B0cyA9IHtcblx0XHR4bWxNb2RlOiAhIShvcHRpb25zICYmIG9wdGlvbnMueG1sTW9kZSksXG5cdFx0c3RyaWN0OiAhIShvcHRpb25zICYmIG9wdGlvbnMuc3RyaWN0KVxuXHR9O1xuXG4gICAgLy9GSVhNRTogVXNlcyBhbiBhcnJheSBhcyBhIHBvaW50ZXIgdG8gdGhlIGN1cnJlbnQgZWxlbWVudCAoc2lkZSBlZmZlY3RzKVxuICAgIHZhciBjb250ZXh0ID0gdG9rZW4uc29tZShjb250YWluc1RyYXZlcnNhbCkgPyBbUExBQ0VIT0xERVJfRUxFTUVOVF0gOiBudWxsO1xuXG5cdHZhciBmdW5jID0gY29tcGlsZVRva2VuKHRva2VuLCBvcHRzLCBjb250ZXh0KTtcblxuXHRpZihmdW5jID09PSBmYWxzZUZ1bmMpIHJldHVybiBmYWxzZUZ1bmM7XG5cdGlmKGZ1bmMgPT09IHRydWVGdW5jKSAgcmV0dXJuIGZ1bmN0aW9uKGVsZW0pe1xuXHRcdFx0cmV0dXJuIGdldENoaWxkcmVuKGVsZW0pLnNvbWUoaXNUYWcpICYmIG5leHQoZWxlbSk7XG5cdFx0fTtcblxuXHRmdW5jID0gd3JhcChmdW5jKTtcblxuICAgIGlmKGNvbnRleHQpe1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gaGFzKGVsZW0pe1xuXHRcdHJldHVybiBuZXh0KGVsZW0pICYmIChcbiAgICAgICAgICAgICAgICAoY29udGV4dFswXSA9IGVsZW0pLCBleGlzdHNPbmUoZnVuYywgZ2V0Q2hpbGRyZW4oZWxlbSkpXG4gICAgICAgICAgICApO1xuXHR9O1xuICAgIH1cblxuICAgIHJldHVybiBmdW5jdGlvbiBoYXMoZWxlbSl7XG5cdFx0cmV0dXJuIG5leHQoZWxlbSkgJiYgZXhpc3RzT25lKGZ1bmMsIGdldENoaWxkcmVuKGVsZW0pKTtcblx0fTtcbn07XG5cbmZpbHRlcnMubWF0Y2hlcyA9IGZ1bmN0aW9uKG5leHQsIHRva2VuLCBvcHRpb25zLCBjb250ZXh0KXtcblx0dmFyIG9wdHMgPSB7XG5cdFx0eG1sTW9kZTogISEob3B0aW9ucyAmJiBvcHRpb25zLnhtbE1vZGUpLFxuXHRcdHN0cmljdDogISEob3B0aW9ucyAmJiBvcHRpb25zLnN0cmljdCksXG5cdFx0cm9vdEZ1bmM6IG5leHRcblx0fTtcblxuXHRyZXR1cm4gY29tcGlsZVRva2VuKHRva2VuLCBvcHRzLCBjb250ZXh0KTtcbn07XG4iXX0=