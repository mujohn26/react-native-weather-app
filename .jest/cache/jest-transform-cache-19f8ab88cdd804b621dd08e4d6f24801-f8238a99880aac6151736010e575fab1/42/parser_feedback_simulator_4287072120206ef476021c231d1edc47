c47df8835202e0eb9b3a77f5d770db34
'use strict';

var Tokenizer = require("../tokenizer"),
    foreignContent = require("../common/foreign_content"),
    UNICODE = require("../common/unicode"),
    HTML = require("../common/html");

var $ = HTML.TAG_NAMES,
    NS = HTML.NAMESPACES;

var ParserFeedbackSimulator = module.exports = function (tokenizer) {
  this.tokenizer = tokenizer;
  this.namespaceStack = [];
  this.namespaceStackTop = -1;

  this._enterNamespace(NS.HTML);
};

ParserFeedbackSimulator.prototype.getNextToken = function () {
  var token = this.tokenizer.getNextToken();
  if (token.type === Tokenizer.START_TAG_TOKEN) this._handleStartTagToken(token);else if (token.type === Tokenizer.END_TAG_TOKEN) this._handleEndTagToken(token);else if (token.type === Tokenizer.NULL_CHARACTER_TOKEN && this.inForeignContent) {
    token.type = Tokenizer.CHARACTER_TOKEN;
    token.chars = UNICODE.REPLACEMENT_CHARACTER;
  } else if (this.skipNextNewLine) {
    if (token.type !== Tokenizer.HIBERNATION_TOKEN) this.skipNextNewLine = false;

    if (token.type === Tokenizer.WHITESPACE_CHARACTER_TOKEN && token.chars[0] === '\n') {
      if (token.chars.length === 1) return this.getNextToken();
      token.chars = token.chars.substr(1);
    }
  }
  return token;
};

ParserFeedbackSimulator.prototype._enterNamespace = function (namespace) {
  this.namespaceStackTop++;
  this.namespaceStack.push(namespace);
  this.inForeignContent = namespace !== NS.HTML;
  this.currentNamespace = namespace;
  this.tokenizer.allowCDATA = this.inForeignContent;
};

ParserFeedbackSimulator.prototype._leaveCurrentNamespace = function () {
  this.namespaceStackTop--;
  this.namespaceStack.pop();
  this.currentNamespace = this.namespaceStack[this.namespaceStackTop];
  this.inForeignContent = this.currentNamespace !== NS.HTML;
  this.tokenizer.allowCDATA = this.inForeignContent;
};

ParserFeedbackSimulator.prototype._ensureTokenizerMode = function (tn) {
  if (tn === $.TEXTAREA || tn === $.TITLE) this.tokenizer.state = Tokenizer.MODE.RCDATA;else if (tn === $.PLAINTEXT) this.tokenizer.state = Tokenizer.MODE.PLAINTEXT;else if (tn === $.SCRIPT) this.tokenizer.state = Tokenizer.MODE.SCRIPT_DATA;else if (tn === $.STYLE || tn === $.IFRAME || tn === $.XMP || tn === $.NOEMBED || tn === $.NOFRAMES || tn === $.NOSCRIPT) this.tokenizer.state = Tokenizer.MODE.RAWTEXT;
};

ParserFeedbackSimulator.prototype._handleStartTagToken = function (token) {
  var tn = token.tagName;
  if (tn === $.SVG) this._enterNamespace(NS.SVG);else if (tn === $.MATH) this._enterNamespace(NS.MATHML);

  if (this.inForeignContent) {
    if (foreignContent.causesExit(token)) {
      this._leaveCurrentNamespace();

      return;
    }

    var currentNs = this.currentNamespace;
    if (currentNs === NS.MATHML) foreignContent.adjustTokenMathMLAttrs(token);else if (currentNs === NS.SVG) {
      foreignContent.adjustTokenSVGTagName(token);
      foreignContent.adjustTokenSVGAttrs(token);
    }
    foreignContent.adjustTokenXMLAttrs(token);
    tn = token.tagName;
    if (!token.selfClosing && foreignContent.isIntegrationPoint(tn, currentNs, token.attrs)) this._enterNamespace(NS.HTML);
  } else {
    if (tn === $.PRE || tn === $.TEXTAREA || tn === $.LISTING) this.skipNextNewLine = true;else if (tn === $.IMAGE) token.tagName = $.IMG;

    this._ensureTokenizerMode(tn);
  }
};

ParserFeedbackSimulator.prototype._handleEndTagToken = function (token) {
  var tn = token.tagName;

  if (!this.inForeignContent) {
    var previousNs = this.namespaceStack[this.namespaceStackTop - 1];
    if (previousNs === NS.SVG && foreignContent.SVG_TAG_NAMES_ADJUSTMENT_MAP[tn]) tn = foreignContent.SVG_TAG_NAMES_ADJUSTMENT_MAP[tn];
    if (foreignContent.isIntegrationPoint(tn, previousNs, token.attrs)) this._leaveCurrentNamespace();
  } else if (tn === $.SVG && this.currentNamespace === NS.SVG || tn === $.MATH && this.currentNamespace === NS.MATHML) this._leaveCurrentNamespace();

  if (this.currentNamespace === NS.SVG) foreignContent.adjustTokenSVGTagName(token);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcnNlcl9mZWVkYmFja19zaW11bGF0b3IuanMiXSwibmFtZXMiOlsiVG9rZW5pemVyIiwicmVxdWlyZSIsImZvcmVpZ25Db250ZW50IiwiVU5JQ09ERSIsIkhUTUwiLCIkIiwiVEFHX05BTUVTIiwiTlMiLCJOQU1FU1BBQ0VTIiwiUGFyc2VyRmVlZGJhY2tTaW11bGF0b3IiLCJtb2R1bGUiLCJleHBvcnRzIiwidG9rZW5pemVyIiwibmFtZXNwYWNlU3RhY2siLCJuYW1lc3BhY2VTdGFja1RvcCIsIl9lbnRlck5hbWVzcGFjZSIsInByb3RvdHlwZSIsImdldE5leHRUb2tlbiIsInRva2VuIiwidHlwZSIsIlNUQVJUX1RBR19UT0tFTiIsIl9oYW5kbGVTdGFydFRhZ1Rva2VuIiwiRU5EX1RBR19UT0tFTiIsIl9oYW5kbGVFbmRUYWdUb2tlbiIsIk5VTExfQ0hBUkFDVEVSX1RPS0VOIiwiaW5Gb3JlaWduQ29udGVudCIsIkNIQVJBQ1RFUl9UT0tFTiIsImNoYXJzIiwiUkVQTEFDRU1FTlRfQ0hBUkFDVEVSIiwic2tpcE5leHROZXdMaW5lIiwiSElCRVJOQVRJT05fVE9LRU4iLCJXSElURVNQQUNFX0NIQVJBQ1RFUl9UT0tFTiIsImxlbmd0aCIsInN1YnN0ciIsIm5hbWVzcGFjZSIsInB1c2giLCJjdXJyZW50TmFtZXNwYWNlIiwiYWxsb3dDREFUQSIsIl9sZWF2ZUN1cnJlbnROYW1lc3BhY2UiLCJwb3AiLCJfZW5zdXJlVG9rZW5pemVyTW9kZSIsInRuIiwiVEVYVEFSRUEiLCJUSVRMRSIsInN0YXRlIiwiTU9ERSIsIlJDREFUQSIsIlBMQUlOVEVYVCIsIlNDUklQVCIsIlNDUklQVF9EQVRBIiwiU1RZTEUiLCJJRlJBTUUiLCJYTVAiLCJOT0VNQkVEIiwiTk9GUkFNRVMiLCJOT1NDUklQVCIsIlJBV1RFWFQiLCJ0YWdOYW1lIiwiU1ZHIiwiTUFUSCIsIk1BVEhNTCIsImNhdXNlc0V4aXQiLCJjdXJyZW50TnMiLCJhZGp1c3RUb2tlbk1hdGhNTEF0dHJzIiwiYWRqdXN0VG9rZW5TVkdUYWdOYW1lIiwiYWRqdXN0VG9rZW5TVkdBdHRycyIsImFkanVzdFRva2VuWE1MQXR0cnMiLCJzZWxmQ2xvc2luZyIsImlzSW50ZWdyYXRpb25Qb2ludCIsImF0dHJzIiwiUFJFIiwiTElTVElORyIsIklNQUdFIiwiSU1HIiwicHJldmlvdXNOcyIsIlNWR19UQUdfTkFNRVNfQURKVVNUTUVOVF9NQVAiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLFNBQVMsR0FBR0MsT0FBTyxnQkFBdkI7QUFBQSxJQUNJQyxjQUFjLEdBQUdELE9BQU8sNkJBRDVCO0FBQUEsSUFFSUUsT0FBTyxHQUFHRixPQUFPLHFCQUZyQjtBQUFBLElBR0lHLElBQUksR0FBR0gsT0FBTyxrQkFIbEI7O0FBT0EsSUFBSUksQ0FBQyxHQUFHRCxJQUFJLENBQUNFLFNBQWI7QUFBQSxJQUNJQyxFQUFFLEdBQUdILElBQUksQ0FBQ0ksVUFEZDs7QUFNQSxJQUFJQyx1QkFBdUIsR0FBR0MsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLFVBQVVDLFNBQVYsRUFBcUI7QUFDaEUsT0FBS0EsU0FBTCxHQUFpQkEsU0FBakI7QUFFQSxPQUFLQyxjQUFMLEdBQXNCLEVBQXRCO0FBQ0EsT0FBS0MsaUJBQUwsR0FBeUIsQ0FBQyxDQUExQjs7QUFDQSxPQUFLQyxlQUFMLENBQXFCUixFQUFFLENBQUNILElBQXhCO0FBQ0gsQ0FORDs7QUFRQUssdUJBQXVCLENBQUNPLFNBQXhCLENBQWtDQyxZQUFsQyxHQUFpRCxZQUFZO0FBQ3pELE1BQUlDLEtBQUssR0FBRyxLQUFLTixTQUFMLENBQWVLLFlBQWYsRUFBWjtBQUVBLE1BQUlDLEtBQUssQ0FBQ0MsSUFBTixLQUFlbkIsU0FBUyxDQUFDb0IsZUFBN0IsRUFDSSxLQUFLQyxvQkFBTCxDQUEwQkgsS0FBMUIsRUFESixLQUdLLElBQUlBLEtBQUssQ0FBQ0MsSUFBTixLQUFlbkIsU0FBUyxDQUFDc0IsYUFBN0IsRUFDRCxLQUFLQyxrQkFBTCxDQUF3QkwsS0FBeEIsRUFEQyxLQUdB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QUFULElBQWdCLEtBQUt0QixnQkFBTCxLQUEwQjdCLEVBQUUsQ0FBQ21ELEdBQTdDLElBQ0FqQixFQUFFLEtBQUtwQyxDQUFDLENBQUNzRCxJQUFULElBQWlCLEtBQUt2QixnQkFBTCxLQUEwQjdCLEVBQUUsQ0FBQ3FELE1BRGxELEVBRUQsS0FBS3RCLHNCQUFMOztBQUdKLE1BQUksS0FBS0YsZ0JBQUwsS0FBMEI3QixFQUFFLENBQUNtRCxHQUFqQyxFQUNJeEQsY0FBYyxDQUFDOEQscUJBQWYsQ0FBcUM5QyxLQUFyQztBQUNQLENBckJEIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgVG9rZW5pemVyID0gcmVxdWlyZSgnLi4vdG9rZW5pemVyJyksXG4gICAgZm9yZWlnbkNvbnRlbnQgPSByZXF1aXJlKCcuLi9jb21tb24vZm9yZWlnbl9jb250ZW50JyksXG4gICAgVU5JQ09ERSA9IHJlcXVpcmUoJy4uL2NvbW1vbi91bmljb2RlJyksXG4gICAgSFRNTCA9IHJlcXVpcmUoJy4uL2NvbW1vbi9odG1sJyk7XG5cblxuLy9BbGlhc2VzXG52YXIgJCA9IEhUTUwuVEFHX05BTUVTLFxuICAgIE5TID0gSFRNTC5OQU1FU1BBQ0VTO1xuXG5cbi8vUGFyc2VyRmVlZGJhY2tTaW11bGF0b3Jcbi8vU2ltdWxhdGVzIGFkanVzdG1lbnQgb2YgdGhlIFRva2VuaXplciB3aGljaCBwZXJmb3JtZWQgYnkgc3RhbmRhcmQgcGFyc2VyIGR1cmluZyB0cmVlIGNvbnN0cnVjdGlvbi5cbnZhciBQYXJzZXJGZWVkYmFja1NpbXVsYXRvciA9IG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHRva2VuaXplcikge1xuICAgIHRoaXMudG9rZW5pemVyID0gdG9rZW5pemVyO1xuXG4gICAgdGhpcy5uYW1lc3BhY2VTdGFjayA9IFtdO1xuICAgIHRoaXMubmFtZXNwYWNlU3RhY2tUb3AgPSAtMTtcbiAgICB0aGlzLl9lbnRlck5hbWVzcGFjZShOUy5IVE1MKTtcbn07XG5cblBhcnNlckZlZWRiYWNrU2ltdWxhdG9yLnByb3RvdHlwZS5nZXROZXh0VG9rZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHRva2VuID0gdGhpcy50b2tlbml6ZXIuZ2V0TmV4dFRva2VuKCk7XG5cbiAgICBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLlNUQVJUX1RBR19UT0tFTilcbiAgICAgICAgdGhpcy5faGFuZGxlU3RhcnRUYWdUb2tlbih0b2tlbik7XG5cbiAgICBlbHNlIGlmICh0b2tlbi50eXBlID09PSBUb2tlbml6ZXIuRU5EX1RBR19UT0tFTilcbiAgICAgICAgdGhpcy5faGFuZGxlRW5kVGFnVG9rZW4odG9rZW4pO1xuXG4gICAgZWxzZSBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLk5VTExfQ0hBUkFDVEVSX1RPS0VOICYmIHRoaXMuaW5Gb3JlaWduQ29udGVudCkge1xuICAgICAgICB0b2tlbi50eXBlID0gVG9rZW5pemVyLkNIQVJBQ1RFUl9UT0tFTjtcbiAgICAgICAgdG9rZW4uY2hhcnMgPSBVTklDT0RFLlJFUExBQ0VNRU5UX0NIQVJBQ1RFUjtcbiAgICB9XG5cbiAgICBlbHNlIGlmICh0aGlzLnNraXBOZXh0TmV3TGluZSkge1xuICAgICAgICBpZiAodG9rZW4udHlwZSAhPT0gVG9rZW5pemVyLkhJQkVSTkFUSU9OX1RPS0VOKVxuICAgICAgICAgICAgdGhpcy5za2lwTmV4dE5ld0xpbmUgPSBmYWxzZTtcblxuICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLldISVRFU1BBQ0VfQ0hBUkFDVEVSX1RPS0VOICYmIHRva2VuLmNoYXJzWzBdID09PSAnXFxuJykge1xuICAgICAgICAgICAgaWYgKHRva2VuLmNoYXJzLmxlbmd0aCA9PT0gMSlcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXROZXh0VG9rZW4oKTtcblxuICAgICAgICAgICAgdG9rZW4uY2hhcnMgPSB0b2tlbi5jaGFycy5zdWJzdHIoMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdG9rZW47XG59O1xuXG4vL05hbWVzcGFjZSBzdGFjayBtdXRhdGlvbnNcblBhcnNlckZlZWRiYWNrU2ltdWxhdG9yLnByb3RvdHlwZS5fZW50ZXJOYW1lc3BhY2UgPSBmdW5jdGlvbiAobmFtZXNwYWNlKSB7XG4gICAgdGhpcy5uYW1lc3BhY2VTdGFja1RvcCsrO1xuICAgIHRoaXMubmFtZXNwYWNlU3RhY2sucHVzaChuYW1lc3BhY2UpO1xuXG4gICAgdGhpcy5pbkZvcmVpZ25Db250ZW50ID0gbmFtZXNwYWNlICE9PSBOUy5IVE1MO1xuICAgIHRoaXMuY3VycmVudE5hbWVzcGFjZSA9IG5hbWVzcGFjZTtcbiAgICB0aGlzLnRva2VuaXplci5hbGxvd0NEQVRBID0gdGhpcy5pbkZvcmVpZ25Db250ZW50O1xufTtcblxuUGFyc2VyRmVlZGJhY2tTaW11bGF0b3IucHJvdG90eXBlLl9sZWF2ZUN1cnJlbnROYW1lc3BhY2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5uYW1lc3BhY2VTdGFja1RvcC0tO1xuICAgIHRoaXMubmFtZXNwYWNlU3RhY2sucG9wKCk7XG5cbiAgICB0aGlzLmN1cnJlbnROYW1lc3BhY2UgPSB0aGlzLm5hbWVzcGFjZVN0YWNrW3RoaXMubmFtZXNwYWNlU3RhY2tUb3BdO1xuICAgIHRoaXMuaW5Gb3JlaWduQ29udGVudCA9IHRoaXMuY3VycmVudE5hbWVzcGFjZSAhPT0gTlMuSFRNTDtcbiAgICB0aGlzLnRva2VuaXplci5hbGxvd0NEQVRBID0gdGhpcy5pbkZvcmVpZ25Db250ZW50O1xufTtcblxuLy9Ub2tlbiBoYW5kbGVyc1xuUGFyc2VyRmVlZGJhY2tTaW11bGF0b3IucHJvdG90eXBlLl9lbnN1cmVUb2tlbml6ZXJNb2RlID0gZnVuY3Rpb24gKHRuKSB7XG4gICAgaWYgKHRuID09PSAkLlRFWFRBUkVBIHx8IHRuID09PSAkLlRJVExFKVxuICAgICAgICB0aGlzLnRva2VuaXplci5zdGF0ZSA9IFRva2VuaXplci5NT0RFLlJDREFUQTtcblxuICAgIGVsc2UgaWYgKHRuID09PSAkLlBMQUlOVEVYVClcbiAgICAgICAgdGhpcy50b2tlbml6ZXIuc3RhdGUgPSBUb2tlbml6ZXIuTU9ERS5QTEFJTlRFWFQ7XG5cbiAgICBlbHNlIGlmICh0biA9PT0gJC5TQ1JJUFQpXG4gICAgICAgIHRoaXMudG9rZW5pemVyLnN0YXRlID0gVG9rZW5pemVyLk1PREUuU0NSSVBUX0RBVEE7XG5cbiAgICBlbHNlIGlmICh0biA9PT0gJC5TVFlMRSB8fCB0biA9PT0gJC5JRlJBTUUgfHwgdG4gPT09ICQuWE1QIHx8XG4gICAgICAgICAgICAgdG4gPT09ICQuTk9FTUJFRCB8fCB0biA9PT0gJC5OT0ZSQU1FUyB8fCB0biA9PT0gJC5OT1NDUklQVClcbiAgICAgICAgdGhpcy50b2tlbml6ZXIuc3RhdGUgPSBUb2tlbml6ZXIuTU9ERS5SQVdURVhUO1xufTtcblxuUGFyc2VyRmVlZGJhY2tTaW11bGF0b3IucHJvdG90eXBlLl9oYW5kbGVTdGFydFRhZ1Rva2VuID0gZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgdmFyIHRuID0gdG9rZW4udGFnTmFtZTtcblxuICAgIGlmICh0biA9PT0gJC5TVkcpXG4gICAgICAgIHRoaXMuX2VudGVyTmFtZXNwYWNlKE5TLlNWRyk7XG5cbiAgICBlbHNlIGlmICh0biA9PT0gJC5NQVRIKVxuICAgICAgICB0aGlzLl9lbnRlck5hbWVzcGFjZShOUy5NQVRITUwpO1xuXG4gICAgaWYgKHRoaXMuaW5Gb3JlaWduQ29udGVudCkge1xuICAgICAgICBpZiAoZm9yZWlnbkNvbnRlbnQuY2F1c2VzRXhpdCh0b2tlbikpIHtcbiAgICAgICAgICAgIHRoaXMuX2xlYXZlQ3VycmVudE5hbWVzcGFjZSgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGN1cnJlbnROcyA9IHRoaXMuY3VycmVudE5hbWVzcGFjZTtcblxuICAgICAgICBpZiAoY3VycmVudE5zID09PSBOUy5NQVRITUwpXG4gICAgICAgICAgICBmb3JlaWduQ29udGVudC5hZGp1c3RUb2tlbk1hdGhNTEF0dHJzKHRva2VuKTtcblxuICAgICAgICBlbHNlIGlmIChjdXJyZW50TnMgPT09IE5TLlNWRykge1xuICAgICAgICAgICAgZm9yZWlnbkNvbnRlbnQuYWRqdXN0VG9rZW5TVkdUYWdOYW1lKHRva2VuKTtcbiAgICAgICAgICAgIGZvcmVpZ25Db250ZW50LmFkanVzdFRva2VuU1ZHQXR0cnModG9rZW4pO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yZWlnbkNvbnRlbnQuYWRqdXN0VG9rZW5YTUxBdHRycyh0b2tlbik7XG5cbiAgICAgICAgdG4gPSB0b2tlbi50YWdOYW1lO1xuXG4gICAgICAgIGlmICghdG9rZW4uc2VsZkNsb3NpbmcgJiYgZm9yZWlnbkNvbnRlbnQuaXNJbnRlZ3JhdGlvblBvaW50KHRuLCBjdXJyZW50TnMsIHRva2VuLmF0dHJzKSlcbiAgICAgICAgICAgIHRoaXMuX2VudGVyTmFtZXNwYWNlKE5TLkhUTUwpO1xuICAgIH1cblxuICAgIGVsc2Uge1xuICAgICAgICBpZiAodG4gPT09ICQuUFJFIHx8IHRuID09PSAkLlRFWFRBUkVBIHx8IHRuID09PSAkLkxJU1RJTkcpXG4gICAgICAgICAgICB0aGlzLnNraXBOZXh0TmV3TGluZSA9IHRydWU7XG5cbiAgICAgICAgZWxzZSBpZiAodG4gPT09ICQuSU1BR0UpXG4gICAgICAgICAgICB0b2tlbi50YWdOYW1lID0gJC5JTUc7XG5cbiAgICAgICAgdGhpcy5fZW5zdXJlVG9rZW5pemVyTW9kZSh0bik7XG4gICAgfVxufTtcblxuUGFyc2VyRmVlZGJhY2tTaW11bGF0b3IucHJvdG90eXBlLl9oYW5kbGVFbmRUYWdUb2tlbiA9IGZ1bmN0aW9uICh0b2tlbikge1xuICAgIHZhciB0biA9IHRva2VuLnRhZ05hbWU7XG5cbiAgICBpZiAoIXRoaXMuaW5Gb3JlaWduQ29udGVudCkge1xuICAgICAgICB2YXIgcHJldmlvdXNOcyA9IHRoaXMubmFtZXNwYWNlU3RhY2tbdGhpcy5uYW1lc3BhY2VTdGFja1RvcCAtIDFdO1xuXG4gICAgICAgIGlmIChwcmV2aW91c05zID09PSBOUy5TVkcgJiYgZm9yZWlnbkNvbnRlbnQuU1ZHX1RBR19OQU1FU19BREpVU1RNRU5UX01BUFt0bl0pXG4gICAgICAgICAgICB0biA9IGZvcmVpZ25Db250ZW50LlNWR19UQUdfTkFNRVNfQURKVVNUTUVOVF9NQVBbdG5dO1xuXG4gICAgICAgIC8vTk9URTogY2hlY2sgZm9yIGV4aXQgZnJvbSBpbnRlZ3JhdGlvbiBwb2ludFxuICAgICAgICBpZiAoZm9yZWlnbkNvbnRlbnQuaXNJbnRlZ3JhdGlvblBvaW50KHRuLCBwcmV2aW91c05zLCB0b2tlbi5hdHRycykpXG4gICAgICAgICAgICB0aGlzLl9sZWF2ZUN1cnJlbnROYW1lc3BhY2UoKTtcbiAgICB9XG5cbiAgICBlbHNlIGlmICh0biA9PT0gJC5TVkcgJiYgdGhpcy5jdXJyZW50TmFtZXNwYWNlID09PSBOUy5TVkcgfHxcbiAgICAgICAgICAgICB0biA9PT0gJC5NQVRIICYmIHRoaXMuY3VycmVudE5hbWVzcGFjZSA9PT0gTlMuTUFUSE1MKVxuICAgICAgICB0aGlzLl9sZWF2ZUN1cnJlbnROYW1lc3BhY2UoKTtcblxuICAgIC8vIE5PVEU6IGFkanVzdCBlbmQgdGFnIG5hbWUgYXMgd2VsbCBmb3IgY29uc2lzdGVuY3lcbiAgICBpZiAodGhpcy5jdXJyZW50TmFtZXNwYWNlID09PSBOUy5TVkcpXG4gICAgICAgIGZvcmVpZ25Db250ZW50LmFkanVzdFRva2VuU1ZHVGFnTmFtZSh0b2tlbik7XG59O1xuIl19